쿠버네티스 클러스터 구축을 위해 **마스터 노드(Control Plane) 1대**와 **워커 노드(Worker Node) 2대**를 설정하는 전체 과정을 정리했습니다. 모든 과정은 **Ubuntu 22.04 LTS** 환경과 **containerd** 런타임을 기준으로 하며, 각 노드의 사양은 최소 2 vCPU, 2GB RAM 이상을 권장합니다.

---

## 1. 모든 노드 공통 설정 (Master & Worker 1, 2)

클러스터에 참여하는 모든 서버에서 아래 과정을 동일하게 수행해야 합니다.

```bash
# 시스템 패키지 리스트를 업데이트합니다.
sudo apt-get update -y

# 쿠버네티스의 안정적인 동작을 위해 스왑(Swap) 메모리를 비활성화합니다.
sudo swapoff -a

# 재부팅 시에도 스왑이 활성화되지 않도록 설정 파일에서 주석 처리합니다.
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

# 컨테이너 네트워크 통신을 위한 커널 모듈(overlay, br_netfilter)을 로드 설정에 추가합니다.
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

# 설정한 커널 모듈을 시스템에 즉시 로드합니다.
sudo modprobe overlay
sudo modprobe br_netfilter

# 브릿지 네트워크를 통한 트래픽이 iptables에 의해 제어되도록 커널 파라미터를 설정합니다.
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 변경된 커널 파라미터 설정을 시스템에 즉시 적용합니다.
sudo sysctl --system

# 컨테이너 런타임(containerd) 및 필수 도구들을 설치합니다.
sudo apt-get install -y curl gnupg2 software-properties-common apt-transport-https ca-certificates
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/docker.gpg
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" -y
sudo apt-get update -y
sudo apt-get install -y containerd.io

# containerd 기본 설정을 생성하고 시스템 그룹 관리(SystemdCgroup) 기능을 활성화합니다.
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml
sudo sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

# 쿠버네티스 패키지 설치를 위한 GPG 키와 저장소를 등록합니다. (v1.30 기준)
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

# kubeadm(설치도구), kubelet(노드관리), kubectl(명령도구)을 설치하고 버전을 고정합니다.
sudo apt-get update -y
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

```

---

## 2. 마스터 노드(Master Node) 초기화 설정

마스터 노드 한 곳에서만 실행하여 클러스터의 제어 평면을 구성합니다.

```bash
# 클러스터를 초기화합니다. pod-network-cidr은 이후 설치할 Flannel 네트워크 대역과 맞춥니다.
# --apiserver-advertise-address에는 마스터 노드의 실제 IP를 입력하세요.
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# 일반 사용자 계정에서도 kubectl 명령어를 사용할 수 있도록 권한 설정을 복사합니다.
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# 노드 간 네트워크 통신을 가능하게 하는 Flannel CNI(Container Network Interface)를 설치합니다.
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```

> **주의**: `kubeadm init` 완료 후 출력되는 마지막 부분의 **`kubeadm join ...`** 명령어를 반드시 복사해두어야 합니다. (워커 노드 연결 시 사용)

---

## 3. 워커 노드(Worker Nodes) 클러스터 합류

워커 노드 1번과 2번 각각에서 마스터 노드로부터 받은 `join` 명령어를 실행합니다.

```bash
# 마스터 노드에서 생성된 토큰과 해시값을 포함한 명령어를 워커 노드에 입력합니다.
# 아래 명령은 예시이므로 반드시 본인의 마스터 노드에서 생성된 값을 사용하세요.
sudo kubeadm join <MASTER_IP>:6443 --token <TOKEN> \
    --discovery-token-ca-cert-hash sha256:<HASH_VALUE>

```

---

## 4. 설치 확인 (마스터 노드에서 수행)

모든 노드가 정상적으로 연결되었는지 확인합니다.

```bash
# 모든 노드의 상태를 확인합니다. Status가 'Ready'가 될 때까지 약 1~2분 소요됩니다.
kubectl get nodes

# 모든 시스템용 Pod들이 정상적으로 동작 중인지 확인합니다.
kubectl get pods -A

```

---

### 구성 환경 정보 요약 (AWS 등 클라우드 사용 시)

| 서비스 | 포트 | 용도 | 과금 여부 |
| --- | --- | --- | --- |
| **Kubernetes API** | 6443 | 마스터 노드 통신 | 인스턴스 비용 발생 |
| **NodePort Services** | 30000-32767 | 외부 서비스 노출 | 인스턴스 비용 발생 |
| **AWS EBS/EFS** | - | 데이터 영구 저장 시 | **유료 (사용량에 따라 과금)** |

---

Next Step: **kubeadm join 토큰 재발급**, **Pod 배포 및 테스트**, **대시보드 설치**

---

마스터 1대와 워커 2대 구성이 완료되었습니다. 혹시 `kubeadm join` 토큰을 잃어버리셨거나, 특정 노드가 `NotReady` 상태라면 원인을 파악해 드릴 수 있습니다.
