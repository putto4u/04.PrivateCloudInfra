쿠버네티스(Kubernetes, k8s)를 우분투 환경에서 **kubeadm**을 이용해 설치하는 상세 과정을 정리했습니다. 각 단계별로 명령어의 의미를 주석으로 달아두었습니다.

---

### 1. 시스템 환경 설정 (모든 노드 공통)

쿠버네티스가 정상적으로 컨테이너를 관리하기 위해 리눅스 시스템의 몇 가지 기본 설정을 변경해야 합니다.

```bash
# 1. 시스템 패키지 업데이트
sudo apt update && sudo apt upgrade -y

# 2. Swap 메모리 비활성화 (k8s 스케줄러가 리소스를 정확히 계산하기 위해 필수)
sudo swapoff -a
sudo sed -i '/swap/s/^/#/' /etc/fstab # 재부팅 시에도 적용되도록 설정

# 3. 네트워크 브리지 모듈 로드 및 커널 파라미터 설정
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# 4. iptables가 브리지된 트래픽을 볼 수 있도록 설정
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 설정 적용
sudo sysctl --system

```

### 2. 컨테이너 런타임(containerd) 설치

쿠버네티스는 컨테이너를 실행할 엔진이 필요합니다. 현재 표준인 **containerd**를 설치합니다.

```bash
# 1. Docker 저장소 등록을 위한 필수 패키지 설치
sudo apt install -y ca-certificates curl gnupg lsb-release

# 2. Docker 공식 GPG 키 추가
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 3. Docker 저장소 추가
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. containerd 설치
sudo apt update
sudo apt install -y containerd.io

# 5. containerd 기본 설정 생성 및 Cgroup 관리자 설정 (Systemd 사용)
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd

```

### 3. 쿠버네티스 구성 요소 설치

클러스터 구축을 위한 핵심 도구 3인방(`kubeadm`, `kubelet`, `kubectl`)을 설치합니다.

```bash
# 1. 쿠버네티스 저장소의 GPG 키 다운로드 (v1.30 기준)
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# 2. 쿠버네티스 apt 저장소 추가
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

# 3. 도구 설치 및 버전 고정 (의도치 않은 업데이트 방지)
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

```

### 4. 마스터 노드(Control Plane) 초기화

이 단계는 **마스터로 사용할 서버에서만** 실행합니다.

```bash
# 1. 클러스터 초기화 (Flannel 네트워크를 사용할 경우 10.244.0.0/16 권장)
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# 2. 일반 사용자(root가 아닌)도 kubectl을 사용할 수 있도록 환경 변수 설정
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

### 5. CNI(Container Network Interface) 설치

노드 간 통신을 위해 가상 네트워크 플러그인을 설치해야 노드 상태가 `Ready`로 변합니다.

```bash
# Flannel 네트워크 배포
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```

---

> [!IMPORTANT]
> **AWS 과금 주의**: 클라우드 환경에서 실습할 경우, 마스터 노드는 최소 **t3.medium**(2 CPU, 4GB RAM) 이상을 권장합니다. 프리티어인 t2.micro에서는 리소스 부족으로 설치가 실패할 수 있으며, 인스턴스 가동 시간에 따라 과금이 발생합니다.

Next Step: **워커 노드 연결 및 파드(Pod) 배포 테스트**

---
제시해주신 설치 과정은 **이미 한 번 실행된 환경에서 다시 실행(중복 실행)하면 충돌이 발생하거나 시스템 설정이 꼬일 위험이 큽니다.**

특히 쿠버네티스 초기화(`kubeadm init`)와 네트워크 설정 부분은 이전의 데이터가 남아있으면 에러를 뱉으며 중단됩니다. 만약 설치 중에 실수가 있었거나, 깨끗한 상태에서 다시 시작하고 싶다면 반드시 **초기화(Reset)** 과정을 거친 후 재설행해야 합니다.

---

### 재설치 또는 재실행 전 필수 단계: 클러스터 초기화

두 번 실행하기 전에, 먼저 기존에 생성된 인증서, 네트워크 인터페이스, 설정 파일들을 삭제해야 합니다.

```bash
# 1. 쿠버네티스 설정 초기화 (마스터/워커 노드 공통)
# 실행 시 [y/N] 질문이 나오면 y를 입력합니다.
sudo kubeadm reset

# 2. 개인 설정 디렉토리 삭제
rm -rf $HOME/.kube

# 3. CNI(네트워크 플러그인) 잔재 삭제
sudo rm -rf /etc/cni/net.d
sudo rm -rf /var/lib/cni/

# 4. (선택사항) IP 테이블 정리 (네트워크 꼬임 방지)
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

```

위 과정을 마친 후에 다시 단계별로 명령어를 실행하면 처음과 동일한 상태에서 깨끗하게 설치할 수 있습니다.

---

### 주의해야 할 중복 실행 항목

1. **`/etc/fstab` 수정 (Swap 비활성화)**: `sed` 명령어를 여러 번 실행하면 주석(`#`)이 중복해서 붙을 수 있습니다. 파일의 내용을 확인해 보세요.
2. **Containerd 설정**: `containerd config default` 명령어로 설정을 덮어쓰면 기존에 수정한 `SystemdCgroup = true` 설정이 초기화될 수 있으므로 주의가 필요합니다.
3. **Kubeadm Init**: 이미 클러스터가 생성된 상태에서 다시 실행하면 "이미 사용 중인 포트" 혹은 "파일이 이미 존재함" 에러가 발생합니다.

> [!CAUTION]
> **AWS 과금 관련**: 설치 실패 후 인스턴스를 종료하지 않고 방치하거나, 리소스 부족으로 인스턴스를 상위 등급(t3.medium 등)으로 새로 생성할 경우 **Elastic IP(공인 IP) 미연결 비용**이나 **EBS 볼륨 비용**이 누적되어 과금될 수 있으니 사용하지 않는 자원은 즉시 삭제하세요.

Next Step: **kubeadm reset 상세 옵션 및 트러블슈팅**

