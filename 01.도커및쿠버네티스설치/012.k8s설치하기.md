쿠버네티스(Kubernetes, k8s)를 우분투 환경에서 **kubeadm**을 이용해 설치하는 상세 과정을 정리했습니다. 각 단계별로 명령어의 의미를 주석으로 달아두었습니다.

---

### 1. 시스템 환경 설정 (모든 노드 공통)

쿠버네티스가 정상적으로 컨테이너를 관리하기 위해 리눅스 시스템의 몇 가지 기본 설정을 변경해야 합니다.

```bash
# 1. 시스템 패키지 업데이트
sudo apt update && sudo apt upgrade -y

# 2. Swap 메모리 비활성화 (k8s 스케줄러가 리소스를 정확히 계산하기 위해 필수)
sudo swapoff -a
sudo sed -i '/swap/s/^/#/' /etc/fstab # 재부팅 시에도 적용되도록 설정

# 3. 네트워크 브리지 모듈 로드 및 커널 파라미터 설정, 가상인터페이스를 모르는 iptables 가 볼수있게,
# overlay : 여러 독립적 네트워크 레이어를 겹쳐서 하나로 연결된 네트워크 생성, 다른 호스트 파드가 동일한 네트워크에 존재하는 것처럼 통신
# 부팅시 overlay 네트워크 드라이버를 로드함.
# br_netfilter : iptables 규칙 적용, 컨테이너-호스트간 트래픽 규칙 적용 관리 위해 만듬,

cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay   
br_netfilter
EOF

# 모듈관리도구 설치 : 특정 모듈 로드 및 제거 제어
sudo modprobe overlay
sudo modprobe br_netfilter

# 4. iptables가 브리지된 트래픽을 제어할 수 있도록 설정
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 설정 적용
sudo sysctl --system

```

### 2. 컨테이너 런타임(containerd) 설치

쿠버네티스는 컨테이너를 실행할 엔진이 필요합니다. 현재 표준인 **containerd**를 설치합니다.

```bash
# 1. Docker 저장소 등록을 위한 필수 패키지 설치
sudo apt install -y ca-certificates curl gnupg lsb-release apt-transport-https 

# 2. Docker 공식 GPG 키 추가
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 3. Docker 저장소 추가
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. containerd 설치
sudo apt update
sudo apt install -y containerd.io

# 5. containerd 기본 설정 생성 및 Cgroup 관리자 설정 (Systemd 사용)
sudo mkdir -p /etc/containerd
containerd config default | sudo tee /etc/containerd/config.toml > /dev/null
sudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
sudo systemctl restart containerd
sudo systemctl enable containderd  # 추가

```

### 3. 쿠버네티스 구성 요소 설치

클러스터 구축을 위한 핵심 도구 3인방(`kubeadm`, `kubelet`, `kubectl`)을 설치합니다.

```bash
# 1. 쿠버네티스 저장소의 GPG 키 다운로드 (v1.30 기준)
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

# 2. 쿠버네티스 apt 저장소 추가
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

# 3. 도구 설치 및 버전 고정 (의도치 않은 업데이트 방지)
sudo apt update
sudo apt install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

```

### 4. 마스터 노드(Control Plane) 초기화

이 단계는 **마스터로 사용할 서버에서만** 실행합니다.

```bash
# 1. 클러스터 초기화 (Flannel 네트워크를 사용할 경우 10.244.0.0/16 권장)
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

# 2. 일반 사용자(root가 아닌)도 kubectl을 사용할 수 있도록 환경 변수 설정
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

### 5. CNI(Container Network Interface) 설치

노드 간 통신을 위해 가상 네트워크 플러그인을 설치해야 노드 상태가 `Ready`로 변합니다.

```bash
# Flannel 네트워크 배포
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```

---

> [!IMPORTANT]
> **AWS 과금 주의**: 클라우드 환경에서 실습할 경우, 마스터 노드는 최소 **t3.medium**(2 CPU, 4GB RAM) 이상을 권장합니다. 프리티어인 t2.micro에서는 리소스 부족으로 설치가 실패할 수 있으며, 인스턴스 가동 시간에 따라 과금이 발생합니다.

Next Step: **워커 노드 연결 및 파드(Pod) 배포 테스트**

---
제시해주신 설치 과정은 **이미 한 번 실행된 환경에서 다시 실행(중복 실행)하면 충돌이 발생하거나 시스템 설정이 꼬일 위험이 큽니다.**

특히 쿠버네티스 초기화(`kubeadm init`)와 네트워크 설정 부분은 이전의 데이터가 남아있으면 에러를 뱉으며 중단됩니다. 만약 설치 중에 실수가 있었거나, 깨끗한 상태에서 다시 시작하고 싶다면 반드시 **초기화(Reset)** 과정을 거친 후 재설행해야 합니다.

---
## Kubernetes 컨트롤 플레인 설치 확인

컨트롤 플레인(마스터 노드) 설치 후, 클러스터가 정상적으로 구동되고 주요 구성 요소들이 활성화되었는지 확인하는 절차는 필수적입니다. 다음 명령어들을 통해 현재 클러스터의 상태를 점검할 수 있습니다.

---

### 1. 노드 상태 및 역할 확인

가장 먼저 마스터 노드가 `Ready` 상태인지 확인합니다.

```bash
kubectl get nodes

```

* **STATUS**: `Ready`로 표시되어야 합니다. 만약 `NotReady`라면 네트워크 플러그인(CNI)이 아직 설치되지 않았을 가능성이 큽니다.
* **ROLES**: `control-plane` 또는 `master`로 표시되는지 확인합니다.

### 2. 클러스터 정보 및 상태 점검

클러스터의 엔드포인트가 정상적으로 노출되고 있는지 확인합니다.

```bash
kubectl cluster-info

```

* **Kubernetes control plane** 주소와 **CoreDNS** 서비스의 실행 여부를 확인할 수 있습니다.

### 3. 시스템 구성 요소 Pod 상태 확인

Kubernetes의 핵심 구성 요소(API Server, Scheduler, Controller Manager, etcd)는 `kube-system` 네임스페이스에서 Pod 형태로 실행됩니다.

```bash
kubectl get pods -n kube-system

```

**주요 체크 리스트:**

* `kube-apiserver`: API 요청 처리 담당
* `etcd`: 클러스터 데이터 저장소
* `kube-scheduler`: Pod 스케줄링 담당
* `kube-controller-manager`: 다양한 컨트롤러 관리
* `coredns`: 클러스터 내 이름 조회 담당 (CNI 설치 전까지는 `Pending` 상태일 수 있음)

### 4. 컴포넌트 헬스 체크

각 컴포넌트의 개별 상태를 직접적으로 확인합니다.

```bash
kubectl get componentstatuses
# 또는 (최신 버전 권장)
kubectl get cs

```

* 모든 항목의 **STATUS**가 `Healthy`로 나오는지 확인합니다.

---

### 5. API 서버 통신 테스트

외부 도구 없이 `curl`을 사용하여 API 서버가 살아있는지 직접 찌러볼 수 있습니다.

```bash
curl -k https://localhost:6443/livez
# 출력 결과: ok

```

---

### 주의 사항 (과금 관련)

* **Cloud Managed Service (EKS, GKE 등)**: 마스터 노드(컨트롤 플레인) 자체를 클라우드 업체에서 관리해 주는 서비스를 사용할 경우, 컨트롤 플레인 가동 시간에 따른 **시간당 고정 비용**이 발생합니다. (예: AWS EKS의 경우 클러스터당 시간당 약 $0.10 내외)
* **On-premise / Self-managed**: 본인이 직접 인스턴스에 설치한 경우에는 인스턴스 비용 외에 별도의 K8s 소프트웨어 비용은 발생하지 않습니다.

---

Next Step: CNI(Container Network Interface) 설치 및 네트워크 설정

---

요청하신 마스터 노드 설치 확인 절차를 정리했습니다. 깃허브에 바로 사용하실 수 있는 마크다운 포맷입니다. 추가로 궁금한 점이 있으시면 말씀해 주세요.

---
### 재설치 또는 재실행 전 필수 단계: 클러스터 초기화

두 번 실행하기 전에, 먼저 기존에 생성된 인증서, 네트워크 인터페이스, 설정 파일들을 삭제해야 합니다.

```bash
# 1. 쿠버네티스 설정 초기화 (마스터/워커 노드 공통)
# 실행 시 [y/N] 질문이 나오면 y를 입력합니다.
sudo kubeadm reset

# 2. 개인 설정 디렉토리 삭제
rm -rf $HOME/.kube

# 3. CNI(네트워크 플러그인) 잔재 삭제
sudo rm -rf /etc/cni/net.d
sudo rm -rf /var/lib/cni/

# 4. (선택사항) IP 테이블 정리 (네트워크 꼬임 방지)
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

```

위 과정을 마친 후에 다시 단계별로 명령어를 실행하면 처음과 동일한 상태에서 깨끗하게 설치할 수 있습니다.

---

### 주의해야 할 중복 실행 항목

1. **`/etc/fstab` 수정 (Swap 비활성화)**: `sed` 명령어를 여러 번 실행하면 주석(`#`)이 중복해서 붙을 수 있습니다. 파일의 내용을 확인해 보세요.
2. **Containerd 설정**: `containerd config default` 명령어로 설정을 덮어쓰면 기존에 수정한 `SystemdCgroup = true` 설정이 초기화될 수 있으므로 주의가 필요합니다.
3. **Kubeadm Init**: 이미 클러스터가 생성된 상태에서 다시 실행하면 "이미 사용 중인 포트" 혹은 "파일이 이미 존재함" 에러가 발생합니다.

> [!CAUTION]
> **AWS 과금 관련**: 설치 실패 후 인스턴스를 종료하지 않고 방치하거나, 리소스 부족으로 인스턴스를 상위 등급(t3.medium 등)으로 새로 생성할 경우 **Elastic IP(공인 IP) 미연결 비용**이나 **EBS 볼륨 비용**이 누적되어 과금될 수 있으니 사용하지 않는 자원은 즉시 삭제하세요.

Next Step: **kubeadm reset 상세 옵션 및 트러블슈팅**


---
쿠버네티스 마스터 노드(Control Plane) 초기화 실패 후 디렉터리들을 삭제했다면, 단순히 `kubeadm init`만 다시 실행해서는 안 됩니다. 설정 잔재와 네트워크 인터페이스 상태가 꼬여 있을 가능성이 높기 때문에 **완전한 초기화(Reset)** 과정을 먼저 거쳐야 합니다.

---

## 쿠버네티스 노드 재설정 및 재초기화 가이드

`etcd` 데이터와 `CNI` 설정 파일을 삭제한 것은 클러스터의 상태 정보와 네트워크 구성을 모두 날린 것이므로, 깨끗한 상태에서 다시 시작하는 것이 가장 안전합니다.

### 1. 노드 초기화 (kubeadm reset)

가장 먼저 수행해야 할 단계입니다. 삭제되지 않은 나머지 설정값과 실행 중인 컨테이너들을 정리합니다.

```bash
sudo kubeadm reset

```

* **주의:** 실행 중 `/etc/kubernetes/` 내의 설정 파일들이 삭제된다는 안내가 나옵니다. `y`를 눌러 진행하세요.

### 2. 잔류 데이터 및 네트워크 인터페이스 정리

수동으로 지우셨던 디렉터리들을 포함하여, 확실한 초기화를 위해 아래 명령어를 차례로 실행합니다. 특히 `cni` 인터페이스가 남아 있으면 재설치 시 네트워크 충돌이 발생할 수 있습니다.

```bash
# CNI 설정 및 바이너리 삭제
sudo rm -rf /etc/cni/net.d
sudo rm -rf /var/lib/cni/

# etcd 데이터 삭제 (이미 삭제하셨다면 확인만 하세요)
sudo rm -rf /var/lib/etcd

# 쿠버네티스 설정 디렉터리 삭제
sudo rm -rf ~/.kube
sudo rm -rf /etc/kubernetes/

```

### 3. IPVS/IPTables 및 네트워크 인터페이스 초기화

이전에 생성되었던 가상 네트워크 인터페이스(`cni0`, `flannel.1` 등)를 제거해야 합니다.

```bash
# 네트워크 인터페이스 초기화
sudo ip link delete cni0
sudo ip link delete flannel.1

# iptables 설정 초기화
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

```

### 4. kubeadm init 재시도

이제 다시 마스터 노드를 초기화할 준비가 되었습니다. Pod 네트워크 대역(CIDR) 설정을 포함하여 초기화를 진행합니다.

```bash
# 예시: Flannel을 사용할 경우 --pod-network-cidr를 지정해야 합니다.
sudo kubeadm init --pod-network-cidr=10.244.0.0/16

```

### 5. 후속 작업 (관리 권한 부여)

초기화가 완료되면 출력되는 가이드를 따라 일반 사용자가 kubectl을 사용할 수 있도록 설정합니다.

```bash
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

```

### 6. CNI(네트워크 플러그인) 재설치

`cni/net.d`를 지웠기 때문에, 노드 상태가 `NotReady`로 보일 것입니다. 사용하고자 하는 네트워크 플러그인(Calico, Flannel 등)을 다시 설치해야 합니다.

---

### 질문하신 삭제 부분에 대한 검토

* **`/var/lib/etcd` 삭제:** 클러스터의 모든 상태 정보(Pod, Service, ConfigMap 등)가 들어있는 DB입니다. 처음부터 다시 클러스터를 구성하는 상황이라면 삭제해도 무방하며, 오히려 찌꺼기가 남지 않아 재설치 시 오류를 방지합니다.
* **`cni/net.d` 및 `lib/cni` 삭제:** 네트워크 구성 파일입니다. 재설치 시 CNI 플러그인 YAML을 다시 배포하면 자동으로 생성되므로 걱정하지 않으셔도 됩니다.

---

### Next Step:

`kubeadm init` 실패 원인 파악, `etcd` 데이터 복구 방법, CNI 플러그인 선택 가이드

---

* **AWS 관련 참고:** 만약 AWS EC2 위에서 직접 마스터를 구성 중이라면, 보안 그룹(Security Group)에서 **6443, 2379-2380, 10250, 10259, 10257** 포트가 열려 있는지 반드시 확인하세요. AWS 관리형 서비스인 EKS를 사용 중이라면 이러한 수동 초기화 방식은 권장되지 않습니다.
