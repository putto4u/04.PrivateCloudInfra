## VirtualBox 및 DevOps 도구 통합 배포 최종 프로젝트 (개정판)

이 프로젝트는 Windows 호스트 환경에서 VirtualBox 인프라를 구축하고, 생성된 VM 내부에 **도커(Docker)**와 **쿠버네티스 마스터(Kubernetes Master)**를 설치 및 설정하는 전체 공정을 자동화합니다.

---

## 1. 프로젝트 디렉토리 구조

```text
ansible-devops-project/
├── inventory/
│   └── hosts.ini            # 대상 Windows 호스트 PC 리스트
├── vars/
│   └── main.yml             # 설치 파일 버전, 경로 및 계정 정보
└── site.yml                 # 전체 공정 통합 플레이북

```

---

## 2. 파일별 상세 내용

### ① 인벤토리 설정 (`inventory/hosts.ini`)

```ini
[physical_pcs]
# 대상 Windows 호스트 IP
pc-01 ansible_host=192.168.0.10

[physical_pcs:vars]
ansible_user=Administrator
ansible_password=YourPassword
ansible_port=5986
ansible_connection=winrm
ansible_winrm_server_cert_validation=ignore

```

### ② 변수 정의 (`vars/main.yml`)

```yaml
# 선행 필수 및 VirtualBox 관련
vcredist_url: "https://aka.ms/vs/17/release/vc_redist.x64.exe"
vbox_installer_url: "https://download.virtualbox.org/virtualbox/7.0.12/VirtualBox-7.0.12-159484-Win.exe"
ext_pack_url: "https://download.virtualbox.org/virtualbox/7.0.12/Oracle_VM_VirtualBox_Extension_Pack-7.0.12.vbox-extpack"
ext_pack_hash: "33d7284dc4a0ece278f985c002b881fd92b35887955e59824e5c0162dbf03d60"

# VM 사양 및 게스트 설정
vm_name: "DevOps-Master-VM"
vm_user: "master"
vm_pass: "1234"
vm_memory: 4096
vm_cpus: 2
guest_iso: "C:\\Program Files\\Oracle\\VirtualBox\\VBoxGuestAdditions.iso"

# 쿠버네티스 버전 및 네트워크 대역
k8s_version: "1.29"
pod_network_cidr: "10.244.0.0/16"

```

### ③ 메인 플레이북 (`site.yml`)

```yaml
---
- name: 호스트 환경 구축 및 VM 내 도커/K8s 마스터 설정
  hosts: physical_pcs
  vars_files:
    - vars/main.yml

  tasks:
# [STEP 1] Windows 호스트 선행 소프트웨어 설치
    - name: Microsoft Visual C++ Redistributable 설치
      win_package:
        path: "{{ vcredist_url }}"
        arguments: /install /quiet /norestart
        state: present

    - name: VirtualBox 소프트웨어 설치
      win_package:
        path: "{{ vbox_installer_url }}"
        arguments: /s
        state: present

# [STEP 2] VM 생성 및 가상 하드웨어 구성
    - name: VirtualBox VM 생성 및 게스트 ISO 마운트
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        if (!(& $vbox list vms | Select-String "{{ vm_name }}")) {
          & $vbox createvm --name "{{ vm_name }}" --register
          & $vbox modifyvm "{{ vm_name }}" --memory {{ vm_memory }} --cpus {{ vm_cpus }} --nic1 bridged
          & $vbox storagectl "{{ vm_name }}" --name "SATA" --add sata
          & $vbox storageattach "{{ vm_name }}" --storagectl "SATA" --port 1 --device 0 --type dvddrive --medium "{{ guest_iso }}"
          & $vbox startvm "{{ vm_name }}" --type headless
        }

# [STEP 3] VM 내부 도커 및 쿠버네티스 마스터 설치/설정
# *주의: 아래 과정은 GuestControl을 통해 VM 내부 Bash로 전달됩니다.
    - name: 도커(Docker) 및 쿠버네티스 도구 설치
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        # 패키지 업데이트 및 도커 설치
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get update
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/apt-get install -y docker.io kubeadm kubectl kubelet
        
        # 쿠버네티스 마스터 노드 초기화 (Kubeadm init)
        & $vbox guestcontrol "{{ vm_name }}" run --username root --password {{ vm_pass }} -- /usr/bin/kubeadm init --pod-network-cidr={{ pod_network_cidr }}

# [STEP 4] 일반 사용자 환경 설정 및 네트워크 플러그인(Flannel) 배포
    - name: Kubeconfig 설정 및 Flannel 배포
      win_shell: |
        $vbox = "${env:ProgramFiles}\Oracle\VirtualBox\VBoxManage.exe"
        $script = "mkdir -p $HOME/.ssh && cp /etc/kubernetes/admin.conf $HOME/.kube/config && chown $(id -u):$(id -g) $HOME/.kube/config"
        & $vbox guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /bin/bash -c "$script"
        & $vbox guestcontrol "{{ vm_name }}" run --username {{ vm_user }} --password {{ vm_pass }} -- /usr/bin/kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```

---

## 3. 실행 가이드

1. **대상 Windows PC**: WinRM 설정이 활성화되어 있어야 합니다.
2. **배포 시작**: 아래 명령어를 입력하여 실행합니다.

```bash
ansible-playbook -i inventory/hosts.ini site.yml

```

---

## 4. 결과 확인 방법

1. **도커 상태**: VM 내부 접속 후 `sudo docker ps` 실행.
2. **K8s 마스터 상태**: `kubectl get nodes` 실행 시 마스터 노드가 `Ready` 상태인지 확인.
3. **Pod 상태**: `kubectl get pods -A` 실행 시 Flannel 등 시스템 파드가 정상 구동 중인지 확인.

---

### ⚠️ 비용 및 환경 체크

* **AWS 환경**: Windows 호스트로 Bare Metal 인스턴스를 사용할 경우 높은 비용이 발생하므로 실습 후 반드시 **인스턴스 종료(Terminate)**를 확인하세요.
* **VirtualBox 확장팩**: 기업 환경 배포 시 라이선스 정책을 반드시 확인해야 합니다.

Next Step: 쿠버네티스 워커 노드 추가 및 조인(Join) 자동화 방법
