## 배포 일시 중지(Pause) 및 재개(Resume)를 활용한 카나리 배포

쿠버네티스 디플로이먼트의 **Pause(일시 중지)**와 **Resume(재개)** 기능을 활용하면, 별도의 복잡한 도구(Istio, ArgoCD 등) 없이도 **카나리 배포(Canary Deployment)**의 효과를 낼 수 있습니다. 이는 새 버전의 영향을 소수의 사용자에게만 먼저 테스트해 보고자 할 때 매우 유용합니다.

---

### 1. 카나리 배포 메커니즘 (Pause/Resume 방식)

디플로이먼트를 업데이트하는 도중에 '일시 중지'를 걸면, 쿠버네티스는 새로운 버전의 포드를 일부만 생성한 상태에서 업데이트 프로세스를 멈춥니다. 이때 클러스터에는 **구버전 포드와 신버전 포드가 공존**하게 되며, 서비스(Service)를 통해 들어온 트래픽은 자연스럽게 두 버전으로 분산됩니다.

---

### 2. 실전 단계별 명령어

강사님께서 수강생들과 함께 실습하실 수 있는 단계별 시나리오입니다. (예: `nginx:1.14`에서 `1.15`로 업데이트)

| 단계 | 실행 명령어 | 설명 |
| --- | --- | --- |
| **1. 이미지 업데이트 시작** | `kubectl set image deploy/web nginx=nginx:1.15` | 업데이트를 트리거합니다. |
| **2. 즉시 일시 중지** | `kubectl rollout pause deploy/web` | 업데이트가 완료되기 전에 즉시 중단합니다. |
| **3. 상태 확인** | `kubectl get pods` | 신버전 포드 1~2개와 구버전 포드들이 섞여 있는지 확인합니다. |
| **4. 트래픽 테스트** | (서비스 IP 접속 테스트) | 소수의 신버전 포드로 유입되는 트래픽의 로그나 오류 여부를 점검합니다. |
| **5. 배포 완료(재개)** | `kubectl rollout resume deploy/web` | 테스트 결과가 정상이라면 나머지 포드들도 업데이트합니다. |

---

### 3. 카나리 비율 조정 (Strategy 활용)

단순히 Pause를 거는 것보다, `maxSurge`와 `maxUnavailable` 설정을 정교하게 조정하면 카나리 테스트 시의 트래픽 비율을 더 세밀하게 관리할 수 있습니다.

```yaml
spec:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1           # 업데이트 중 추가로 생성될 수 있는 포드 최대 수
      maxUnavailable: 0     # 업데이트 중 사용할 수 없는 상태가 되어도 되는 포드 수

```

* **전문가 팁**: `maxSurge: 1`과 `maxUnavailable: 0`으로 설정하고 Pause를 걸면, 전체 10개의 포드 중 단 1개만 신버전으로 교체된 상태(`1:10` 비율)에서 카나리 테스트를 수행할 수 있습니다.

---

### 4. 카나리 배포의 장점과 한계

* **장점**:
* 추가적인 리소스나 솔루션 도입 없이 기본 `kubectl`만으로 구현 가능합니다.
* 운영 리스크를 줄이면서 실제 트래픽 기반의 검증이 가능합니다.


* **한계**:
* 트래픽의 정확한 가중치(예: 딱 5%만 보내기) 조절이 어렵습니다. (포드 개수 비율로만 결정됨)
* 사용자 세션 유지(Sticky Session)가 보장되지 않아 신/구 버전을 왔다 갔다 할 수 있습니다.



---

### 💡 실무 전문가의 팁: 롤백과의 연계

카나리 테스트 중 신버전에서 에러 로그가 발견된다면, 고민하지 말고 `kubectl rollout undo deployment/web`을 실행하세요. Pause 상태에서도 `undo` 명령어는 유효하며, 생성되었던 소수의 신버전 포드를 즉시 제거하고 안정적인 구버전으로 100% 복구합니다.

---

### ⚠️ 비용 및 유료 전환 주의사항

* **일시적인 리소스 증가**: `maxSurge`를 활용하여 카나리 배포를 진행할 경우, 업데이트 과정 동안 설정한 값만큼의 **추가 포드가 생성**됩니다. AWS EKS의 경우 이로 인해 노드의 리소스가 꽉 차게 되면 **새로운 EC2 인스턴스가 추가로 프로비저닝**되어 비용이 발생할 수 있습니다.
* **데이터 전송 비용**: 신버전 테스트를 위해 외부에서 대량의 테스트 트래픽을 유입시킬 경우, AWS **Data Transfer In/Out 비용**이 발생하므로 주의가 필요합니다.

---

**Next Step: 카나리 배포 자동화와 모니터링 연동**

## '카나리(Canary)' 배포의 어원과 의미

IT 분야, 특히 쿠버네티스 배포 전략에서 자주 등장하는 **카나리(Canary)**라는 용어는 19세기 광부들이 탄광의 유독가스를 감지하기 위해 **카나리아 새**를 새장에 넣어 들어갔던 역사적 사실에서 유래되었습니다.

---

### 1. 역사적 배경 (탄광의 카나리아)

카나리아는 메탄이나 일산화탄소 같은 유독가스에 인간보다 훨씬 민감하게 반응합니다. 광부들은 갱도에 들어갈 때 카나리아를 데리고 갔으며, 만약 카나리아가 갑자기 노래를 멈추거나 쓰러지면 이를 **위험 신호**로 받아들이고 즉시 대피했습니다. 즉, 카나리아는 위험을 미리 알려주는 **'조기 경보 시스템'** 역할을 했습니다.

---

### 2. IT 배포에서의 의미

소프트웨어 배포에서의 '카나리' 역시 같은 원리로 작동합니다. 새로운 버전의 프로그램을 전체 사용자에게 한 번에 공개(배포)하기 전에, **아주 적은 수의 사용자(또는 서버)에게만 먼저 배포**하여 문제가 없는지 확인하는 방식입니다.

* **위험 감지**: 소수의 환경에서 에러율, CPU 사용량 등을 모니터링합니다.
* **피해 최소화**: 만약 새 버전에 심각한 버그가 있다면, 소수의 카나리아 그룹만 영향을 받고 전체 서비스는 안전하게 유지됩니다.
* **점진적 확대**: 카나리아 그룹에서 문제가 없음을 확인하면 점진적으로 배포 범위를 넓혀 최종적으로 100% 전환합니다.

---

### 3. 카나리 배포 vs 다른 전략

| 전략 | 핵심 개념 | 카나리와의 차이점 |
| --- | --- | --- |
| **Canary** | **소수에게 먼저 노출** | 위험을 미리 감지하고 점진적으로 배포함 |
| **Blue/Green** | **구/신 버전 전체 교체** | 두 환경을 똑같이 만들어 놓고 한꺼번에 트래픽을 전환함 |
| **Rolling Update** | **순차적으로 교체** | 점진적으로 바꾸긴 하지만, 카나리처럼 '검증' 단계가 명시적이지 않음 |

---

### 💡 실무 전문가의 팁: 왜 카나리가 중요한가?

강사님은 수강생들에게 "카나리 배포는 기술적인 도구라기보다 **'운영의 철학'**에 가깝다"고 설명하시면 좋습니다. 아무리 테스트 환경에서 완벽했어도 실제 사용자의 다양한 기기 환경과 트래픽 패턴에서는 예상치 못한 에러가 날 수 있기 때문입니다. 쿠버네티스의 `pause` 기능을 활용하는 것이 바로 이 '카나리아'를 먼저 갱도에 들보내는 행위입니다.

---

### ⚠️ 비용 및 유료 전환 주의사항

* **리소스 중복**: 카나리 배포를 위해 구버전과 신버전을 동시에 띄우는 기간에는 평소보다 더 많은 서버 자원(CPU, Mem)이 필요합니다. AWS 환경에서 **인스턴스 개수 증가**에 따른 추가 과금이 발생할 수 있습니다.
* **트래픽 제어 도구**: 더 정교한 카나리 배포를 위해 **AWS App Mesh**나 **Istio** 같은 서비스 메시 도구를 도입할 경우, 해당 관리형 서비스 이용료가 추가될 수 있습니다.

---

**Next Step: 카나리 배포 테스트를 위한 Prometheus 메트릭 모니터링 설정**

Next Step: **Prometheus 에러율 모니터링** | **Istio를 활용한 가중치 기반 카나리 배포** | **카나리 자동 롤백 자동화** Would you like me to: **강의 교재용 카나리 배포 비유 설명 작성**, **모니터링 대시보드 구성 예제 제공**?

Next Step: **Prometheus 로그 모니터링 연동** | **롤링 업데이트 파라미터 최적화** | **Blue/Green 배포 방식 비교** Would you like me to: **강의 교재용 카나리 배포 시나리오 퀴즈**, **Blue/Green 배포 예제 구성**?
