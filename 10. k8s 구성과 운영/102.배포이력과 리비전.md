

## 배포 이력(Rollout History)과 리비전(Revision)의 이해

쿠버네티스 디플로이먼트의 가장 큰 장점 중 하나는 **배포 이력 관리**입니다. 애플리케이션의 설정이나 이미지가 변경될 때마다 쿠버네티스는 이를 새로운 **리비전(Revision)**으로 기록하며, 이를 통해 문제가 발생했을 때 특정 시점으로 쉽고 빠르게 되돌릴 수 있습니다.

---

### 1. 배포 이력의 기록 원리

디플로이먼트의 `spec.template` 부분이 변경되면(예: 이미지 버전 변경), 디플로이먼트는 새로운 **레플리카셋(ReplicaSet)**을 생성합니다.

* **이전 리비전**: 기존 레플리카셋은 삭제되지 않고 `replicas: 0` 상태로 보존됩니다. 이것이 '배포 이력'이 됩니다.
* **최신 리비전**: 새로운 설정이 적용된 레플리카셋이 활성화되어 포드를 관리합니다.

---

### 2. 주요 관리 명령어 (실전 예제)

강의 시 수강생들이 직접 실습해보기 좋은 핵심 명령어들입니다.

| 작업 내용 | 실전 명령어 | 비고 |
| --- | --- | --- |
| **전체 이력 확인** | `kubectl rollout history deploy/web-deploy` | 생성된 리비전 번호 목록 출력 |
| **특정 리비전 상세 확인** | `kubectl rollout history deploy/web-deploy --revision=2` | 2번 리비전의 구체적인 설정 확인 |
| **직전 버전으로 롤백** | `kubectl rollout undo deploy/web-deploy` | 문제가 생겼을 때 즉시 복구 |
| **특정 버전으로 롤백** | `kubectl rollout undo deploy/web-deploy --to-revision=1` | 원하는 시점으로 강제 복구 |
| **배포 상태 모니터링** | `kubectl rollout status deploy/web-deploy` | 업데이트 진행 상황 실시간 확인 |

---

### 3. 리비전 기록 제한 (Revision History Limit)

무한정 이력을 쌓아두면 클러스터 리소스를 낭비하게 됩니다. 이를 제어하는 중요한 설정입니다.

```yaml
spec:
  revisionHistoryLimit: 10   # 보존할 이전 리비전의 개수 (기본값은 10)
  strategy:
    type: RollingUpdate

```

* **전문가 팁**: 실무에서는 보통 3~5개 정도로 설정하여 `etcd` 데이터베이스의 부하를 줄이고 관리 효율을 높입니다. 이 값이 `0`이면 롤백이 불가능해지므로 주의해야 합니다.

---

### 4. 배포 이력에 설명 추가하기 (Change Cause)

단순히 리비전 번호만 보면 무엇이 바뀌었는지 알기 어렵습니다. `kubernetes.io/change-cause` 주석을 활용하면 관리가 훨씬 수월해집니다.

* **명령형 방식**:
```bash
kubectl annotate deployment/web-deploy kubernetes.io/change-cause="v2.0 image update"

```


* **결과 확인**: `kubectl rollout history` 실행 시 `CHANGE-CAUSE` 컬럼에 해당 문구가 나타납니다.

---

### 💡 실무 전문가의 팁: 롤백의 한계

디플로이먼트 롤백은 **'쿠버네티스 오브젝트 설정'**을 되돌리는 것입니다. 만약 애플리케이션 내부에서 **데이터베이스 스키마를 변경**했거나, 외부 스토리지의 데이터를 삭제했다면 롤백만으로는 완벽한 복구가 불가능합니다. 따라서 데이터베이스 마이그레이션이 포함된 배포는 반드시 별도의 백업 전략이 병행되어야 함을 강조해 주세요.

---

### ⚠️ 비용 및 유료 전환 주의사항

* **리소스 소모**: 보관되는 리비전(ReplicaSet)은 실제 포드를 띄우고 있지는 않지만, 클러스터의 상태 저장소인 `etcd`에 데이터를 점유합니다. 수천 개의 디플로이먼트가 각각 10개 이상의 리비전을 유지하면 마스터 노드의 성능 저하를 유발할 수 있습니다.
* **AWS EBS 스냅샷**: 만약 롤백 전략의 일환으로 데이터 볼륨의 스냅샷을 생성한다면, **AWS EBS Snapshot 보관 비용**이 GB당 월별로 청구됩니다. 자동화된 백업 스크립트 작성 시 보관 주기(Retention Policy)를 반드시 설정하십시오.

---

**Next Step: 배포 일시 중지(Pause) 및 재개(Resume)를 활용한 카나리 배포 맛보기**

Next Step: **rollout pause/resume 실습** | **카나리(Canary) 배포 개념 이해** | **전략적 업데이트 파라미터 튜닝** ---
Would you like me to: **강의 교재용 롤백 시나리오 문제 작성**, **Canary 배포 예제 구성**?
