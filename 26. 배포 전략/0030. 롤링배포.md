# Module: Rolling Update Strategy

## 1. 롤링 배포(Rolling Update) 개요

롤링 배포는 가장 대중적이고 기본적인 무중단 배포 전략으로, **"점진적 교체"** 방식이다. 구버전의 인스턴스(Pod)를 하나씩(또는 설정된 배치 크기만큼) 제거하고 동시에 새 버전의 인스턴스를 생성하여, 전체 서비스가 중단 없이 자연스럽게 새 버전으로 전환되도록 한다.

Kubernetes의 `Deployment` 리소스가 기본적(Default)으로 채택하고 있는 전략이며, 별도의 설정 없이도 `kubectl apply`를 실행하면 이 방식으로 배포가 진행된다.

### 1.1 핵심 메커니즘

* **점진적 전환:** 전체 트래픽을 한 번에 끊는 것이 아니라, 로드밸런서 뒤에 연결된 서버 풀(Pool)에서 구버전 서버를 하나 빼고, 신버전 서버를 하나 넣는 과정을 반복한다.
* **가용성 유지:** 배포 중에도 항상 일정 수 이상의 서버가 살아있어 사용자의 요청을 처리할 수 있다.
* **리소스 효율성:** 블루-그린 배포처럼 전체 인프라를 두 배로 늘릴 필요 없이, 소수의 추가 리소스(Overhead)만 있으면 배포가 가능하다.

---

## 2. 동작 원리 및 프로세스

Kubernetes 환경을 기준으로 롤링 업데이트는 다음과 같은 순서로 진행된다. (예: Replica=3 인 경우)

1. **시작:** 사용자가 이미지 태그를 변경하여 배포를 명령한다.
2. **Scale Up (신규 생성):** 새 버전(v2)의 Pod 1개를 먼저 생성한다.
3. **Health Check:** 새 Pod가 `Ready` 상태가 될 때까지 기다린다. (Readiness Probe 통과 필수)
4. **Scale Down (구버전 삭제):** 새 Pod가 트래픽을 받을 준비가 되면, 구버전(v1) Pod 1개를 삭제한다.
5. **반복:** 위 과정을 설정된 복제본(Replica) 수만큼 반복한다.
6. **완료:** 모든 Pod가 v2로 교체되면 배포가 종료된다.

---

## 3. Kubernetes 상세 설정 (Tuning)

롤링 배포의 핵심은 배포 속도와 안정성 사이의 균형을 맞추는 것이다. 이를 위해 `strategy` 필드 내의 두 가지 파라미터를 조절해야 한다.

### 3.1 maxSurge (최대 초과 허용 수)

* **정의:** 배포 중에 의도된 파드 개수(`replicas`)보다 **얼마나 더 많은 파드를 생성할 수 있는지**를 결정한다.
* **설정값:** 숫자(개수) 또는 백분율(%)로 설정 가능. (기본값: 25%)
* **예시:** `replicas: 10`, `maxSurge: 2` (또는 20%)
* 배포 중 최대 12개(10+2)의 파드가 동시에 존재할 수 있다.
* 값이 클수록 배포 속도는 빨라지지만, 순간적으로 더 많은 리소스(CPU/Memory)가 필요하다.



### 3.2 maxUnavailable (최대 사용 불가 허용 수)

* **정의:** 배포 중에 **몇 개의 파드가 죽어 있어도(사용 불가 상태여도) 되는지**를 결정한다.
* **설정값:** 숫자(개수) 또는 백분율(%)로 설정 가능. (기본값: 25%)
* **예시:** `replicas: 10`, `maxUnavailable: 1` (또는 10%)
* 배포 중 최소 9개(10-1)의 파드는 항상 `Running` 상태여야 한다.
* 값이 0이면, 새 파드가 완벽하게 뜨기 전에는 구버전 파드를 절대 죽이지 않는다. (가장 안전하지만 배포 속도가 느림)



**[설정 예시 YAML]**

```yaml
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # 1개 더 생성 가능 (총 4개까지 허용)
      maxUnavailable: 0  # 단 하나도 죽지 않은 상태 유지 (무중단 보장)

```

---

## 4. 장점과 단점 (Trade-offs)

### 4.1 장점 (Pros)

* **비용 효율적:** 추가 리소스가 거의 필요하지 않다. (`maxSurge` 만큼의 여유분만 있으면 됨)
* **구현 용이성:** 대부분의 오케스트레이션 도구(K8s, AWS ECS 등)에서 기본으로 지원하므로 복잡한 라우팅 설정이 불필요하다.
* **위험 분산:** 점진적으로 배포되므로 초기에 문제가 발견되면 중단하여 전체 장애를 막을 수 있다.

### 4.2 단점 (Cons)

* **롤백 속도 저하:** 배포가 완료된 후 심각한 버그가 발견되면, 다시 구버전 이미지를 롤링 방식으로 배포해야 하므로 복구에 시간이 오래 걸린다.
* **버전 호환성 문제 (N+1 문제):** 배포가 진행되는 동안(수 분~수십 분) 구버전과 신버전이 공존한다.
* 사용자 A는 v1 UI를 보고, 사용자 B는 v2 UI를 볼 수 있다.
* v1과 v2가 공유하는 DB 스키마가 변경된 경우, 애플리케이션 에러가 발생할 수 있다.



---

## 5. 실전 운영 팁 (Best Practices)

1. **Readiness Probe 필수 설정:**
* 롤링 배포의 전제 조건은 **"새 파드가 준비되었을 때 트래픽을 보낸다"**는 것이다.
* `readinessProbe`를 설정하지 않으면, 컨테이너가 시작되자마자(아직 앱 로딩 중인데) 트래픽이 유입되어 500 에러가 발생한다. 이는 무중단 배포 실패의 주원인이다.


2. **Graceful Shutdown 처리:**
* 구버전 파드가 종료될 때(`SIGTERM` 시그널 수신), 현재 처리 중인 요청을 완료할 수 있도록 충분한 대기 시간(`terminationGracePeriodSeconds`)을 주어야 한다.


3. **버전 호환성 체크:**
* API 변경 시 하위 호환성을 반드시 유지해야 한다. (예: 필드 삭제 대신 `deprecated` 처리 후 다음 배포 때 삭제)



---

## 6. 배포 전략 비교 요약

| 구분 | 롤링 (Rolling) | 블루-그린 (Blue-Green) | 카나리 (Canary) |
| --- | --- | --- | --- |
| **속도** | 중간 | 빠름 | 느림 (검증 시간 필요) |
| **비용** | **저렴** (최소 리소스) | 비쌈 (2배 리소스) | 저렴~중간 |
| **롤백** | **느림** (재배포 필요) | **빠름** (스위칭) | 빠름 (트래픽 차단) |
| **난이도** | **쉬움** (Default) | 중간 (LB 설정 필요) | 어려움 (정교한 제어 필요) |
| **사용처** | 일반적인 웹 서비스 | 중요한 메이저 업데이트 | 리스크가 큰 신규 기능 |

Next Step: 무중단 배포의 핵심, Readiness Probe와 Liveness Probe의 정확한 설정법
