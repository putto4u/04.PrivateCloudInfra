# Module: Advanced Ingress Logic - How Traffic Splitting Works

## 1. 인그레스(Ingress)의 재발견: 단순 라우터 그 이상

질문하신 대로 쿠버네티스의 **Ingress는 기본적으로 L7(HTTP/HTTPS) 로드밸런서**가 맞습니다. 도메인(`foo.bar.com`)이나 경로(`/api`)를 보고 적절한 서비스로 토스해주는 역할을 합니다.

하지만, 우리가 흔히 사용하는 **Nginx Ingress Controller**는 단순한 정적 프록시가 아니라, **Lua 스크립트가 내장된 OpenResty** 기반의 강력한 프로그래밍 가능한 프록시입니다. 즉, "요청이 오면 넘긴다"는 단순 로직 외에, "요청을 분석하고 확률을 계산해서 넘긴다"는 **동적 로직(Dynamic Logic)** 처리가 가능합니다.

이것이 가능한 이유는 **Ingress 리소스(YAML)**는 '설정서'일 뿐이고, 실제 일을 하는 **Ingress Controller(Nginx)**가 이 설정을 읽어들여 내부적으로 복잡한 알고리즘을 수행하기 때문입니다.

---

## 2. 카나리 배포(Traffic Splitting)의 내부 로직 분석

인그레스 컨트롤러가 `canary-weight: 10`이라는 어노테이션을 만나면, 내부 Nginx 설정 파일(`nginx.conf`)을 재작성(Reload)하며 다음과 같은 로직을 주입합니다.

### 2.1 핵심 알고리즘: 확률적 분기 (Randomized Splitting)

가장 기본적인 로직은 **'들어오는 요청마다 주사위를 굴리는 것'**입니다.

1. **요청 수신:** 사용자가 `GET /` 요청을 보냅니다.
2. **변수 생성:** Nginx 내부 변수 `$request_id` 또는 랜덤 값을 생성합니다.
3. **모듈 연산 (Split Clients):**
* Nginx의 `split_clients` 모듈이나 Lua 스크립트가 실행됩니다.
* 수식: `Random(0, 100) < Weight(10)`


4. **라우팅 결정:**
* 결과값이 10 미만이면 -> `backend-canary` (신버전) 업스트림으로 전송.
* 결과값이 10 이상이면 -> `backend-stable` (구버전) 업스트림으로 전송.



### 2.2 세션 고정 (Sticky Session) 로직

단순 확률로만 돌리면, 사용자가 새로고침 할 때마다 v1(구버전)과 v2(신버전)를 왔다 갔다 하게 됩니다. 이를 방지하기 위해 **쿠키(Cookie)**를 활용한 로직이 추가됩니다.

1. **쿠키 확인:** 요청 헤더에 `ingress-canary` 쿠키가 있는지 확인합니다.
* `always`: 무조건 카나리로 보냄.
* `never`: 무조건 구버전으로 보냄.


2. **쿠키 생성:** 쿠키가 없다면, 위의 확률 로직을 돌려서 결정된 목적지를 쿠키에 구워(Set-Cookie) 응답합니다.
3. **고정 라우팅:** 이후 요청부터는 이 쿠키 값을 보고 확률 계산 없이 바로 해당 버전으로 보냅니다.

---

## 3. 헤더 기반 라우팅 (A/B 테스팅 로직)

확률뿐만 아니라 특정 사용자만 골라내는 것도 가능합니다. 이는 **HTTP Header 매칭 로직**을 사용합니다.

* **설정:** `nginx.ingress.kubernetes.io/canary-by-header: "X-Beta-User"`
* **로직:**
```lua
if request.header["X-Beta-User"] == "true" then
    return "canary_upstream"
else
    return "stable_upstream"
end

```


* **활용:** 사내 QA 팀이나 베타 테스터에게만 특정 헤더를 심어서 신버전을 강제로 보게 할 때 사용합니다.

---

## 4. 인그레스 vs 서비스 메시 (Istio) 비교

인그레스가 이 기능을 수행할 수 있지만, 복잡한 마이크로서비스 환경에서는 한계가 있습니다.

| 기능 | Ingress (Nginx) | Service Mesh (Istio) |
| --- | --- | --- |
| **적용 위치** | 클러스터 **입구 (North-South)** | 서비스 **내부 통신 (East-West)** |
| **구현 방식** | 어노테이션(Annotation) 주입 | 사이드카(Sidecar) 프록시 제어 |
| **정교함** | 단순 비율, 헤더 매칭 | 미러링, 지연 주입, 회로 차단 등 고급 기능 |
| **주 용도** | 외부 사용자 대상 배포 제어 | 내부 서비스 간 버전 관리 및 테스트 |

**결론:** 인그레스의 L7 로드밸런싱 능력은 단순한 `Round Robin`을 넘어, 요청(Request)의 내용을 뜯어보고(Deep Packet Inspection) 판단하는 **지능형 라우팅** 단계까지 진화했습니다. 따라서 별도의 복잡한 장비 없이도 소프트웨어 레벨에서 카나리 배포가 가능한 것입니다.

Next Step: 더 강력한 트래픽 제어를 위한 'Istio Service Mesh'의 사이드카 패턴과 트래픽 미러링(Mirroring) 기술
