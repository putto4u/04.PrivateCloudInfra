기존에 작성하신 `wb-prod` 네임스페이스의 **`ng-web`** 디플로이먼트와 **`fr-end`** 서비스 이름을 그대로 유지하면서, **PVC 마운트**와 **외부 DB 접속 정보**를 느슨한 결합으로 통합한 최종 교재용 구성입니다.

---

### **정적 웹과 백엔드 로직이 통합된 Nginx 아키텍처 (기존 환경 유지)**

이 장에서는 기존에 운영 중인 `ng-web` 웹 서버에 **PVC를 통한 정적 파일 서비스**와 **외부 MySQL DB 연결** 기능을 통합합니다. 이름과 네임스페이스를 그대로 유지하여 기존 인프라와의 호환성을 보장합니다.

#### **1. 외부 데이터베이스 연결 설정 (External Service)**

워커 노드 OS에 설치된 MySQL을 클러스터 내부에서 `mysql-service`라는 이름으로 호출할 수 있도록 설정합니다.

```yaml
# 01-db-external.yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
  namespace: wb-prod  # 기존 네임스페이스와 통일
spec:
  type: ExternalName
  externalName: 192.168.100.1 # DB가 설치된 워커 노드의 IP

```

#### **2. 통합 웹 서비스 배포 (Deployment)**

기존 `ng-web` 디플로이먼트에 PVC 마운트 설정과 DB 접속 환경 변수를 추가하여 업데이트합니다.

```yaml
# 02-nginx-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ng-web        # 기존 이름 유지
  namespace: wb-prod  # 기존 네임스페이스 유지
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        env:
        # 외부 DB 접속을 위한 환경 변수 (mysql-service 참조)
        - name: DB_HOST
          value: "mysql-service"
        - name: DB_USER
          value: "admin"
        - name: DB_PASSWORD
          value: "putto4us"
        - name: DB_NAME
          value: "my_database"
        volumeMounts:
        # 기존에 생성한 PVC를 정적 파일 경로에 마운트
        - name: html-storage
          mountPath: /usr/share/nginx/html
      volumes:
      - name: html-storage
        persistentVolumeClaim:
          claimName: nginx-pvc # 기존에 생성한 PVC 이름

```

#### **3. 통합 접속 서비스 생성 (NodePort)**

기존에 사용하던 `fr-end` 서비스 이름을 유지하며, 외부에서 `30001` 포트로 접속할 수 있도록 설정합니다.

```yaml
# 03-nginx-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: fr-end        # 기존 이름 유지
  namespace: wb-prod  # 기존 네임스페이스 유지
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80
      nodePort: 30001  # 기존 포트 유지

```

---

#### **4. 실행 및 상태 확인 방법**

**리소스 배포:**

```bash
# 네임스페이스가 이미 존재한다는 가정하에 순차적 적용
kubectl apply -f 01-db-external.yaml
kubectl apply -f 02-nginx-deployment.yaml
kubectl apply -f 03-nginx-service.yaml

```

**상태 확인:**

* **Rolling Update 확인:** `kubectl rollout status deployment/ng-web -n wb-prod`
* **서비스 확인:** `kubectl get svc -n wb-prod`
* **접속 테스트:** `http://<노드-IP>:30001/` 접속 시 정적 파일과 DB 연동 로직이 정상 작동하는지 확인합니다.

---

### **전문가 팁**

* **이름의 중요성:** `metadata.name`이 기존과 동일하므로, `apply` 명령 실행 시 기존 리소스를 삭제하지 않고 **수정된 부분만 업데이트**하여 서비스 중단을 최소화합니다.
* **PVC 데이터 보호:** 파드가 업데이트되어 재시작되더라도, `nginx-pvc`에 저장된 데이터는 그대로 유지되어 새 파드에 다시 마운트됩니다.
* **비용 안내:** * **NodePort** 사용은 AWS에서 추가 비용이 들지 않습니다.
* 단, PVC용 **EBS/EFS 스토리지 비용**과 대량 트래픽 발생 시 **네트워크 전송 비용**은 표준 요금에 따라 발생합니다.



---

Next Step: 환경 변수를 Secret으로 전환하여 보안 설정 강화하기
(질문 주제: Secret 생성 및 적용)
