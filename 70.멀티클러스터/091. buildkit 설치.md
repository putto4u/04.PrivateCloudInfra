# nerdctl Minimal 환경에서의 이미지 빌드 전략 (BuildKit 구축)

**nerdctl Minimal 버전**은 빌드 명령(`nerdctl build`)을 내릴 수 있는 **클라이언트(Client)** 기능만 갖고 있으며, 실제로 이미지를 조립하는 **서버(Daemon)**인 **BuildKit**이 포함되어 있지 않습니다. 따라서 `build` 명령어를 실행하면 에러가 발생합니다.

또한, **Kubernetes(k8s) 자체는 이미지를 빌드하는 기능이 없습니다.** k8s는 만들어진 이미지를 가져와서(Pull) 실행(Run)하는 오케스트레이션 도구일 뿐입니다.

따라서 Minimal 버전에서 빌드를 수행하려면 **BuildKit 데몬(`buildkitd`)을 별도로 설치**해야 합니다. 다음은 실습실 환경(PC)에서 가장 적합한 설치 및 구성 방법입니다.

---

## 1. BuildKit 아키텍처 이해

빌드 작업은 다음과 같은 구조로 이루어집니다.

* **nerdctl (Client)**: 사용자가 `build` 명령을 내리고 Dockerfile을 전송합니다.
* **buildkitd (Server)**: 전송받은 명세서를 바탕으로 레이어를 조립하고 컨테이너 이미지를 생성합니다.

Minimal 버전 사용자는 **Server(`buildkitd`)**가 없는 상태이므로, 이를 수동으로 설치해 주어야 합니다.

---

## 2. 해결 방법: BuildKit 바이너리 별도 설치 (권장)

가장 안정적이고 표준적인 방법은 호스트 OS(우분투 등)에 BuildKit 바이너리를 직접 설치하여 `systemd` 서비스로 등록하는 것입니다.

### 1단계: BuildKit 다운로드 및 설치

```bash
# 1. 최신 버전 변수 설정
export BUILDKIT_VERSION=0.12.5

# 2. 다운로드
wget https://github.com/moby/buildkit/releases/download/v${BUILDKIT_VERSION}/buildkit-v${BUILDKIT_VERSION}.linux-amd64.tar.gz

# 3. 압축 해제 및 바이너리 이동 (/usr/local/bin)
# bin/ 폴더 안에 buildctl, buildkitd 등이 들어있음
tar -xf buildkit-v${BUILDKIT_VERSION}.linux-amd64.tar.gz
sudo mv bin/* /usr/local/bin/

```

### 2단계: Systemd 서비스 등록

매번 수동으로 실행할 수 없으므로, 시스템 부팅 시 자동으로 실행되도록 서비스 파일을 생성합니다.

```bash
# 서비스 파일 생성
sudo cat <<EOF | sudo tee /etc/systemd/system/buildkit.service
[Unit]
Description=BuildKit
Documentation=https://github.com/moby/buildkit
After=network.target containerd.service
Requires=containerd.service

[Service]
ExecStart=/usr/local/bin/buildkitd --oci-worker=true --containerd-worker=true
Type=notify
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

```

### 3단계: 서비스 실행 및 확인

```bash
# 데몬 리로드 및 실행
sudo systemctl daemon-reload
sudo systemctl enable --now buildkit

# 상태 확인 (Active: active (running) 확인)
sudo systemctl status buildkit

```

---

## 3. k8s 환경에서의 빌드 (참고)

질문하신 **"k8s에서 하나?"**에 대한 답변입니다.

### 방법 A: k8s 파드로 BuildKit 실행 (고급)

k8s 클러스터 내부에 BuildKit을 **파드(Pod)** 형태로 띄우고, `nerdctl`이 그 파드에 접속해서 빌드를 요청할 수 있습니다. 하지만 설정이 복잡하고(인증서, 통신 설정 등), 로컬 실습 환경에서는 **비효율적**입니다.

### 방법 B: Kaniko 사용 (k8s 네이티브 방식)

실무 k8s 환경(CI/CD 파이프라인)에서는 `nerdctl build` 대신 **[Kaniko](https://github.com/GoogleContainerTools/kaniko)**라는 도구를 사용합니다. Kaniko는 Docker 데몬이나 BuildKit 데몬 없이, k8s 파드 안에서 자체적으로 이미지를 빌드하여 레지스트리(Docker Hub 등)로 푸시합니다.

> **강사 가이드:**
> 수강생들의 PC(예비서버) 환경에서는 복잡한 k8s 파드 방식보다는 **'2. 해결 방법(바이너리 설치)'**을 통해 호스트에서 직접 빌드하게 하는 것이 교육상 혼란을 줄이고 트러블슈팅하기 좋습니다.

---

## 4. 빌드 테스트

설치가 완료되었으면 `nerdctl`이 자동으로 로컬에 실행 중인 `buildkitd`를 감지합니다.

```bash
# 테스트용 Dockerfile 생성
echo "FROM alpine" > Dockerfile
echo "CMD echo 'BuildKit Success'" >> Dockerfile

# 빌드 실행
# sudo를 사용하거나, buildkitd 소켓 권한이 필요함
sudo nerdctl build -t my-test-image:v1 .

```

**성공 시 출력 예시:**

```text
[+] Building 0.5s (5/5) FINISHED
 => [internal] load build definition from Dockerfile
 ...
 => => writing image sha256:...
 => => naming to docker.io/library/my-test-image:v1

```

### Next Step:

생성된 이미지를 로컬 k8s 클러스터에서 바로 사용하는 방법 (이미지 로드 및 태깅)
