## Calico CNI를 활용한 멀티 서브넷 클러스터 구축과 BGP 라우팅

Kubernetes에서 가장 널리 사용되는 CNI 중 하나인 **Calico**는 고성능 L3 네트워크 성능과 강력한 네트워크 정책(Network Policy)을 제공합니다. 특히 노드가 서로 다른 네트워크 대역(Subnet)에 위치한 환경에서 Calico를 어떻게 구성하느냐에 따라 성능과 복잡도가 달라집니다.

---

### 1. Calico의 두 가지 통신 방식 (Encapsulation vs Native)

Calico는 노드 간의 위치 관계에 따라 패킷을 처리하는 방식이 다릅니다.

* **IP-in-IP (Encapsulation):** 노드들이 서로 다른 L2 서브넷에 있을 때 사용합니다. 기존 IP 패킷 위에 다른 IP 헤더를 덧씌워 터널링하며, Flannel의 VXLAN과 유사한 오버레이 방식입니다.
* **BGP (Native Routing):** 노드들이 동일한 L2 서브넷에 있거나, 중간 라우터가 BGP를 지원할 때 사용합니다. 캡슐화 없이 직접 라우팅을 수행하여 오버헤드가 거의 없는 최상의 성능을 냅니다.

---

### 2. 노드 간 통신을 위한 필수 포트 (방화벽 설정)

서로 다른 네트워크에 있는 노드들 사이에서 Calico가 정상 작동하려면 다음 포트가 허용되어야 합니다.

| 프로토콜 | 포트 번호 | 용도 | 비고 |
| --- | --- | --- | --- |
| **TCP** | **179** | **BGP (Bird)** | 노드 간 라우팅 정보 교환 (필수) |
| **IP Protocol 4** | **-** | **IP-in-IP** | IP-in-IP 모드 사용 시 패킷 캡슐화 통신 |
| **UDP** | **4789** | **VXLAN** | Calico를 VXLAN 모드로 설정 시 사용 |
| **TCP** | **5473** | **Typha** | 대규모 클러스터에서 API 부하 감소용 (선택) |

> [!WARNING]
> **유료 과금 주의:** 클라우드 환경(AWS, Azure 등)에서 서로 다른 가용 영역(AZ) 간에 대량의 트래픽이 발생할 경우 네트워크 데이터 전송 비용이 발생할 수 있습니다.

---

### 3. 멀티 서브넷 환경을 위한 핵심 설정 (Cross-Subnet)

노드들이 서로 다른 서브넷에 있을 때 성능과 호환성을 모두 잡기 위해 `CrossSubnet` 설정을 권장합니다.

* **작동 원리:** 동일 서브넷 노드 간에는 **BGP(Native)**로 통신하고, 다른 서브넷 노드와는 **IP-in-IP(Encapsulation)**로 통신합니다.
* **설정 방법:** Calico 설치 시 `IPPool` 리소스의 `ipipMode`를 수정합니다.

```yaml
# calico.yaml 내 IPPool 설정 예시
apiVersion: projectcalico.org/v3
kind: IPPool
metadata:
  name: default-ipv4-ippool
spec:
  cidr: 192.168.0.0/16
  ipipMode: CrossSubnet  # Always, CrossSubnet, Never 중 선택
  natOutgoing: true

```

---

### 4. 실전 구축 시 체크리스트

1. **MTU(Maximum Transmission Unit) 조정:** IP-in-IP 모드를 사용하면 패킷 헤더에 20바이트가 추가됩니다. 물리 인터페이스의 MTU가 1500이라면 Calico MTU는 **1480**으로 설정해야 패킷 파편화를 막을 수 있습니다.
2. **인터페이스 자동 감지 (IP Autodetection):**
노드에 여러 NIC가 있는 경우, Calico가 클러스터 통신용 IP를 제대로 찾지 못할 수 있습니다.
* `IP_AUTODETECTION_METHOD`를 `interface=eth0` 또는 `can-reach=<특정IP>`로 설정하여 고정합니다.


3. **Strict Affinity:**
IP 주소 부족 문제를 방지하고 라우팅 효율을 높이기 위해 `strictAffinity: true` 설정을 검토하십시오.

---

### 5. Flannel 대비 Calico의 장점

* **보안성:** 파드 단위의 정교한 방화벽 규칙(Network Policy) 적용이 가능합니다.
* **확장성:** BGP 프로토콜을 사용하여 수천 개의 노드로 구성된 대규모 클러스터에서도 안정적입니다.
* **유연성:** 오버레이(IP-in-IP, VXLAN)와 비-오버레이(BGP) 방식을 환경에 맞게 선택할 수 있습니다.

---

**Next Step:** Calico 네트워크 정책(Network Policy) 작성 실습

**[안내]** Calico의 Typha 서비스나 외부 BGP 피어링 설정은 추가 인프라 구성이 필요할 수 있으며, 클라우드 환경에 따라 추가 비용이 발생할 수 있습니다.

---

마지막으로 내 개인별 맞춤 설정을 잘 지켰는지 확인했습니다. 본 내용은 깃허브(Markdown) 포맷으로 작성되었으며, 요청하신 대로 강의 교재 형식에 맞춰 성실히 구성했습니다.
