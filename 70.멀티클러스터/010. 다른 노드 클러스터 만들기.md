## Flannel CNI를 활용한 멀티 노드 클러스터 통신 원리

서로 다른 네트워크 환경(Subnet)에 위치한 노드들을 하나의 Kubernetes 클러스터로 묶기 위해서는 **L3 루팅** 문제를 해결해야 합니다. Flannel은 이를 **오버레이(Overlay)** 기술로 해결하며, 물리적인 네트워크 복잡성을 추상화하여 파드 간의 자유로운 통신을 보장합니다.

---

### 1. VXLAN을 통한 L3 오버레이 네트워크 구성

Flannel의 기본 백엔드인 **VXLAN(Virtual Extensible LAN)**은 데이터 링크 계층(L2) 프레임을 IP 패킷(L3)에 캡슐화하여 전송하는 터널링 기술입니다.

* **캡슐화(Encapsulation):** 파드에서 생성된 이더넷 프레임을 UDP 패킷 내부에 삽입합니다.
* **VTEP(VXLAN Tunnel End Point):** 각 노드에 생성되는 `flannel.1` 인터페이스가 VTEP 역할을 수행하며, 패킷을 감싸고 푸는 작업을 담당합니다.
* **식별자(VNI):** Flannel은 기본적으로 VNI 값으로 `1`을 사용하여 클러스터 내부의 논리적인 가상 네트워크를 식별합니다.

### 2. 노드 간 통신을 위한 필수 네트워크 설정 (보안 그룹 및 방화벽)

서로 다른 네트워크에 있는 노드들이 통신하기 위해서는 하위 네트워크 장비(공유기, 클라우드 VPC 등)에서 다음 포트가 반드시 허용되어야 합니다.

| 프로토콜 | 포트 번호 | 용도 | 비고 |
| --- | --- | --- | --- |
| **UDP** | **8472** | **VXLAN 통신** | 노드 간 파드 트래픽 전달 (필수) |
| **UDP** | **8285** | **UDP 백엔드** | VXLAN 미사용 시 대체 포트 |
| **TCP** | **6443** | **API 서버** | 워커 노드가 마스터 노드에 접속할 때 사용 |
| **TCP** | **2379-2380** | **etcd** | 마스터 노드 간 상태 동기화 (HA 구성 시) |

> [!CAUTION]
> **AWS 사용 시 주의사항:** 보안 그룹(Security Group)에서 위 포트들을 인바운드 규칙에 추가해야 합니다. 특히 UDP 8472 포트가 막혀 있으면 노드는 `Ready` 상태가 되어도 파드 간 `ping` 통신이 되지 않습니다. **(Egress 트래픽에 따른 비용 발생 주의)**

---

### 3. 실전 환경별 Flannel 최적화 설정

서로 다른 서브넷이나 퍼블릭 환경에서 클러스터를 구축할 때 발생하는 주요 이슈와 해결 방법입니다.

#### A. 인터페이스 명시 (Multi-NIC 환경)

노드가 퍼블릭 IP와 프라이빗 IP를 동시에 가지거나, 여러 개의 NIC가 존재할 경우 Flannel이 엉뚱한 인터페이스를 잡을 수 있습니다.

* **해결 방법:** Flannel 배포 YAML 파일에서 `DaemonSet` 설정을 수정합니다.

```yaml
containers:
- name: kube-flannel
  image: flannel/flannel:v0.22.0
  args:
  - --ip-masq
  - --kube-subnet-mgr
  - --iface=eth0  # 실제 통신에 사용할 인터페이스명 명시

```

#### B. Public IP 기반 통신 (Hybrid Cloud 환경)

로컬 데이터센터의 노드와 AWS의 노드를 묶는 경우, 공인 IP를 통해 터널을 맺어야 합니다.

* **설정 팁:** 각 노드의 `kubelet` 설정에서 `--node-ip`를 공인 IP로 지정하고, Flannel 실행 옵션에서 `--public-ip`를 명시적으로 선언해야 합니다.

---

### 4. Flannel 백엔드 선택 가이드

환경의 특성에 따라 백엔드 모드를 변경하여 성능과 호환성을 조절할 수 있습니다.

1. **VXLAN (Default):** 일반적인 모든 환경에서 권장됩니다. 커널 수준에서 처리되어 성능이 안정적입니다.
2. **host-gw:** 노드들이 모두 **동일한 L2 서브넷**에 있을 때만 사용 가능합니다. 캡슐화 없이 직접 라우팅을 수행하므로 성능이 가장 뛰어나지만, 서브넷이 다르면 작동하지 않습니다.
3. **UDP:** 커널이 VXLAN을 지원하지 않는 아주 오래된 환경에서만 사용하며, 사용자 공간(User space) 처리가 많아 성능이 낮습니다.

---

### 5. 트러블슈팅: 노드 간 통신이 안 될 때

1. **MTU 값 확인:** 터널링 과정에서 헤더가 추가되므로 MTU 값이 물리 인터페이스보다 작아야 합니다. (일반적으로 1450 설정)
2. **ip_forward 활성화:** 리눅스 커널에서 패킷 포워딩이 활성화되어 있는지 확인합니다.
* `sysctl net.ipv4.ip_forward=1`


3. **Route Table 확인:** `ip route` 명령어를 통해 각 노드의 파드 대역이 `flannel.1` 인터페이스로 향하고 있는지 확인합니다.

---

**Next Step:** Flannel 설치를 위한 YAML 파일 수정 실습
