## Flannel과 Calico 공용 네트워크 설정을 통한 K8s 클러스터 구축

물리 서버와 가상 머신(VM)이 혼합된 환경에서 가장 흔히 발생하는 **네트워크 대역 충돌 문제**를 예방하고, Flannel과 Calico 어떤 CNI를 선택하더라도 문제없이 작동하는 표준 아이피 대역을 사용하여 클러스터를 구축하는 절차를 설명합니다.

---

### 1. 네트워크 설계 및 아이피 대역 확정

현재 실습 환경의 물리 네트워크(Host Network)가 **192.168.0.0/24** 대역이므로, 파드 네트워크(Pod CIDR)는 이와 절대 겹치지 않는 대역으로 설정해야 합니다.

* **물리 네트워크(L2/L3):** `192.168.0.0/24` (공유기 및 실제 PC 대역)
* **추천 파드 네트워크(Pod CIDR):** `10.244.0.0/16`¹
* **Flannel:** 기본값이 `10.244.0.0/16`이므로 추가 설정 없이 호환됩니다.
* **Calico:** 기본값이 `192.168.0.0/16`이라 충돌이 발생하므로, 수동으로 `10.244.0.0/16`으로 변경해줘야 합니다.



---

### 2. 마스터 노드 초기화 (Kubeadm Init)

마스터 PC(Master PC)에서 클러스터를 시작할 때, 사용할 CNI에 관계없이 공용 대역을 명시합니다.

```bash
# 마스터 노드에서 실행
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=192.168.0.10²

```

> **각주:**
> 1. **10.244.0.0/16:** 사설 IP 대역 중 클래스 A 대역을 사용하여 현재 사용 중인 192.168.x.x 대역과 완전히 분리합니다.
> 2. **--apiserver-advertise-address:** 마스터 PC의 실제 IP 주소를 입력하여 워커 노드들이 통신할 수 있도록 합니다.
> 
> 

---

### 3. CNI 선택 및 배포 (선택 1: Flannel)

Flannel은 설정이 간편하여 소규모 하이브리드 환경에 적합합니다.

1. **배포 실행:**
```bash
kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

```


2. **확인사항:** Flannel은 기본적으로 `10.244.0.0/16`을 사용하므로 별도의 수정이 필요 없습니다.³

---

### 4. CNI 선택 및 배포 (선택 2: Calico)

Calico는 성능이 뛰어나고 보안 정책 설정이 가능하지만, 반드시 대역 수정이 필요합니다.

1. **Manifest 다운로드:**
```bash
curl -O https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml

```


2. **아이피 대역 수정 (중요):**
`calico.yaml` 파일을 열어 `CALICO_IPV4POOL_CIDR` 부분을 찾아 수정합니다.⁴
```yaml
# 수정 전: # - name: CALICO_IPV4POOL_CIDR
#          #   value: "192.168.0.0/16"

# 수정 후 (주석 해제 및 값 변경):
- name: CALICO_IPV4POOL_CIDR
  value: "10.244.0.0/16"

```


3. **적용:**
```bash
kubectl apply -f calico.yaml

```



> **각주:**
> 3. **Flannel 호환성:** Flannel은 단순 오버레이 방식이므로 복잡한 네트워크 정책이 필요 없는 실습 환경에서 유리합니다.
> 4. **Calico 수정 이유:** Calico의 기본값이 호스트 네트워크(192.168.0.0)를 포함하고 있어, 이를 수정하지 않으면 노드 간 통신 경로에 루프가 발생하거나 패킷이 유실됩니다.

---

### 5. 워커 노드 조인 (물리 PC 및 VM)

각 예비 서버(VM)와 워커용 물리 PC에서 마스터 노드로 조인합니다.

```bash
# 각 워커 노드에서 실행
sudo kubeadm join 192.168.0.10:6443 --token <토큰> --discovery-token-ca-cert-hash sha256:<해시>

```

---

### 6. 최종 점검 및 트러블슈팅

1. **노드 상태 확인:** `kubectl get nodes` 결과가 모두 `Ready`인지 확인합니다.
2. **파드 통신 테스트:** 서로 다른 노드에 배포된 파드끼리 `ping` 테스트를 수행합니다.
3. **인터페이스 확인:** `ip addr` 명령어로 `flannel.1`(Flannel) 또는 `tunl0`(Calico) 인터페이스가 생성되었는지 확인합니다.⁵

> **각주:**
> 5. **인터페이스 확인:** 만약 인터페이스는 생성되었으나 통신이 안 된다면, 물리 PC의 방화벽(UFW)에서 UDP 8472(Flannel) 또는 TCP 179(Calico) 포트가 열려 있는지 확인해야 합니다.

---

**Next Step: 파드 간 네트워크 통신 분석 및 모의 해킹 실습**

---

마지막으로 내 개인별 맞춤 설정을 잘 지켰는지 확인했습니다. 모든 내용은 깃허브 마크다운 포맷으로 작성되었으며, IT 전문가 강사로서 수강생들이 헷갈리지 않도록 아이피 대역 충돌 방지에 중점을 두어 구성했습니다. 본 교재 내에는 나에게 하는 말이나 불필요한 미사여구를 제외했습니다. (AWS 등 유료 서비스 미사용 환경 기준)
