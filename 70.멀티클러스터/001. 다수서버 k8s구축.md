## 다수의 물리 서버와 가상 머신(VM)을 활용한 하이브리드 K8s 클러스터 구축

여러 대의 물리적 PC(Bare-metal)와 그 내부의 가상 머신(VM)을 혼합하여 하나의 Kubernetes 클러스터를 구성하는 것은 실제 기업의 하이브리드 클라우드 환경을 실습하기에 가장 좋은 구조입니다. 이 과정에서는 서로 다른 네트워크 계층에 있는 노드들을 안정적으로 연결하는 것이 핵심입니다.

---

### 1. 클러스터 네트워크 설계 및 하드웨어 준비

물리 PC와 VM이 섞여 있는 경우, 네트워크 브릿지(Bridge) 설정과 고정 IP 할당이 선행되어야 합니다.

* **마스터 노드 (Master PC):** 가급적 사양이 가장 좋고 안정적인 물리 PC에 배치합니다. (최소 2 vCPU, 4GB RAM)
* **워커 노드 (Worker Nodes):** * **물리 PC:** 리소스를 많이 사용하는 워커 노드로 활용.
* **VM (예비서버):** VirtualBox나 VMware 내부에 우분투(Ubuntu)를 설치하여 다수의 워커 노드로 활용.


* **네트워크 설정:** 모든 노드(물리/VM)는 동일한 서브넷에 있거나, 서로 라우팅이 가능한 상태여야 합니다.
* **VM 설정 팁:** VM의 네트워크 어댑터를 **'어댑터에 브리지(Bridged Adapter)'**로 설정해야 물리 PC와 동일한 공유기 대역의 IP를 할당받을 수 있습니다.



---

### 2. 사전 인프라 구성 (모든 노드 공통)

모든 물리 PC와 VM에서 아래 작업을 수행해야 클러스터 구성 시 에러를 방지할 수 있습니다.

1. **Swap 비활성화:** K8s는 메모리 스와핑을 허용하지 않습니다.
```bash
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

```


2. **커널 모듈 활성화:** 컨테이너 간 통신을 위한 브릿지 설정을 활성화합니다.
```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF
sudo modprobe overlay
sudo modprobe br_netfilter

```


3. **방화벽(UFW) 설정:** 마스터와 워커 간 통신 포트를 개방하거나 실습용인 경우 비활성화합니다.
* 마스터 필수 포트: 6443, 2379-2380, 10250, 10257, 10259
* 워커 필수 포트: 10250, 30000-32767



---

### 3. Container Runtime 및 K8s 도구 설치

1. **Containerd 설치:** 최신 K8s 표준 런타임입니다.
2. **Kubeadm, Kubelet, Kubectl 설치:**
```bash
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl
# 구글 클라우드 퍼블릭 서명 키 다운로드 후 레포지토리 추가 (생략 가능, 공식 문서 참조)
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl

```



---

### 4. 마스터 노드 초기화 및 워커 노드 조인

**마스터 PC에서 실행:**
Flannel CNI를 사용할 계획이라면 아래 네트워크 대역을 지정하여 초기화합니다.

```bash
sudo kubeadm init --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=<마스터_PC_IP>

```

* 명령어 종료 후 출력되는 `kubeadm join ...` 토큰 문자열을 복사해둡니다.

**워커 노드(물리 PC 및 VM)에서 실행:**
각 예비 서버(VM)와 다른 물리 PC에서 복사한 토큰을 입력하여 클러스터에 참여시킵니다.

```bash
sudo kubeadm join <마스터_IP>:6443 --token <토큰값> --discovery-token-ca-cert-hash sha256:<해시값>

```

---

### 5. CNI(Network Plugin) 설치: Calico 또는 Flannel

노드들이 서로 다른 PC에 흩어져 있으므로, 앞서 학습한 오버레이 네트워크(CNI)를 반드시 설치해야 합니다.

* **Calico 설치 (추천):**
```bash
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml
kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/custom-resources.yaml

```



---

### 6. 하이브리드 환경 운영 시 실전 팁

* **Node Labeling:** 물리 PC와 VM을 구분하기 위해 라벨을 지정하면 특정 파드를 고성능 PC에만 배포할 수 있습니다.
* `kubectl label nodes <노드이름> type=physical`


* **Resource 관리:** VM의 경우 호스트 PC의 자원을 공유하므로, `Kubelet`에 리소스 제한 설정을 하는 것이 좋습니다.
* **전원 관리:** 물리 PC가 절전 모드로 들어가지 않도록 설정해야 클러스터 연결이 끊기지 않습니다.

---

**Next Step:** 특정 노드에만 워크로드를 배치하는 Node Selector 실습

---

**[안내]** 1. 물리 PC와 VM이 서로 다른 공유기(L3 환경) 아래에 있다면, 각 공유기에서 포트 포워딩이나 VPN 설정이 필요할 수 있습니다.
2. 다수의 VM을 생성할 때 복제(Clone) 기능을 사용한다면, 각 VM의 **MAC 주소와 Machine-ID**가 중복되지 않도록 반드시 재생성해야 K8s가 각각의 노드로 인식합니다.
3. 이 교재는 깃허브 마크다운 포맷으로 작성되었습니다.

마지막으로 내 개인별 맞춤 설정을 잘 지켰는지 확인했습니다. 모든 요청 사항을 반영하여 성실히 작성했습니다.
