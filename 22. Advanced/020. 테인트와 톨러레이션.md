쿠버네티스 스케줄링의 핵심 메커니즘인 **테인트(Taint)**와 **톨러레이션(Toleration)**에 대해 상세한 개념 설명과 실무 사례를 포함하여 교재 형식으로 정리하였습니다.

---

## 노드 스케줄링 관리: 테인트(Taint)와 톨러레이션(Toleration)

쿠버네티스 클러스터를 운영하다 보면 특정 노드에 특정 성격의 파드만 배치하거나, 시스템 보호를 위해 일반 파드의 접근을 막아야 하는 경우가 발생합니다. 이때 사용하는 기법이 **노드 중심의 거부(Taint)**와 **파드 중심의 용인(Toleration)**입니다.

### 1. 기본 개념 이해

#### 테인트 (Taint): "노드의 거부 선언"

테인트는 노드에 설정하며, 해당 노드가 특정 파드를 **밀어내는(Repel)** 역할을 합니다. 노드에 "나는 GPU 전용 노드다" 혹은 "나는 장애가 있는 노드다"라는 표식을 남겨, 자격이 없는 파드가 배포되는 것을 차단합니다.

#### 톨러레이션 (Toleration): "파드의 면역력"

톨러레이션은 파드에 설정하며, 노드에 설정된 테인트를 **견딜 수 있는 능력**을 의미합니다. 테인트가 설정된 노드에는 일반적인 파드는 배포될 수 없지만, 해당 테인트와 일치하는 톨러레이션을 가진 파드는 그 노드에 배치될 자격을 얻습니다.

---

### 2. 테인트의 3가지 실행 효과 (Effect)

테인트가 설정된 노드에 톨러레이션이 없는 파드가 접근할 때, 시스템이 어떻게 반응할지 결정하는 3가지 모드가 있습니다.

1. **NoSchedule:** 톨러레이션이 없는 파드는 이 노드에 **새롭게 스케줄링되지 않습니다.** (기존에 실행 중이던 파드는 그대로 유지됩니다.)
2. **PreferNoSchedule:** 시스템이 가급적 이 노드를 피하려고 노력하지만, 클러스터 전체 리소스가 부족한 극단적인 상황에서는 배포될 수도 있습니다.
3. **NoExecute:** 톨러레이션이 없는 파드는 **즉시 퇴거(Evict)**시킵니다. 기존에 실행 중이던 파드라도 테인트가 추가되는 순간 톨러레이션이 없다면 즉시 삭제되고 다른 노드로 쫓겨납니다.

---

### 3. 주요 관리 명령어

테인트는 `kubectl` 명령어를 통해 노드에 직접 부여하거나 제거할 수 있습니다.

**테인트 설정하기**

```bash
kubectl taint nodes <노드이름> <Key>=<Value>:<Effect>

```

**테인트 제거하기 (명령어 끝에 `-` 추가)**

```bash
kubectl taint nodes <노드이름> <Key>=<Value>:<Effect>-

```

**노드 테인트 상태 확인**

```bash
kubectl describe node <노드이름> | grep Taints

```

---

### 4. 실무 현장 적용 사례 (Case Studies)

#### 사례 1: 고성능 장비(GPU) 전용 노드 격리

**상황:** 딥러닝 학습을 위한 고가의 GPU 노드에 일반적인 Nginx나 단순 웹 API 파드들이 올라가 리소스를 점유하는 것을 방지해야 함.

* **조치:** GPU 노드에 `dedicated=gpu:NoSchedule` 테인트를 설정하여 일반 파드 유입을 원천 차단.
* **결과:** 전용 톨러레이션을 가진 AI 학습 파드만 해당 노드를 독점적으로 사용하여 연산 효율 극대화.

#### 사례 2: 마스터 노드의 안정성 확보 (System Isolation)

**상황:** 클러스터 전체를 관리하는 마스터 노드의 CPU/Memory 부하를 방지하기 위해 사용자 파드가 배치되는 것을 막아야 함.

* **조치:** 마스터 노드에 `node-role.kubernetes.io/master:NoSchedule` 테인트 설정 (쿠버네티스 기본 동작).
* **결과:** API Server, Scheduler 등 핵심 컴포넌트만 마스터 노드에서 안전하게 구동됨.

#### 사례 3: 하이브리드 클라우드 비용 최적화 (Spot Instance)

**상황:** AWS 스팟 인스턴스는 언제든 삭제될 수 있으므로, 상태 유지가 중요한(Stateful) DB 파드는 피해야 하고, 삭제되어도 무관한 배치 작업용 파드만 배치하고 싶음.

* **조치:** 스팟 노드 그룹에 `instance-type=spot:PreferNoSchedule` 테인트 설정.
* **결과:** 일반 파드는 가급적 피하게 하되, 클러스터 리소스가 임계치에 도달했을 때만 선별적으로 수용하여 비용 절감.

#### 사례 4: 노드 하드웨어 장애 대응 (Eviction)

**상황:** 특정 노드의 디스크 에러가 빈번하여 해당 노드에서 구동 중인 모든 서비스를 건강한 노드로 강제 이주시켜야 함.

* **조치:** 문제가 발생한 노드에 즉시 `status=unhealthy:NoExecute` 테인트 설정.
* **결과:** 톨러레이션이 없는 모든 파드가 즉시 종료되고, 다른 건강한 워커 노드에서 재생성되어 서비스 가용성 유지.

#### 사례 5: 부서별 전용 인프라 할당 (Dedicated Team Nodes)

**상황:** 보안상의 이유로 '금융결제팀' 파드들은 반드시 지정된 특정 보안 강화 노드에서만 실행되어야 하며, 다른 팀 파드와 섞이면 안 됨.

* **조치:** 해당 노드들에 `team=fintech:NoSchedule` 테인트 설정.
* **결과:** 금융팀 파드에만 해당 톨러레이션을 부여하여 물리적/논리적 인프라 격리 구현.

---

### 5. 아키텍트의 핵심 요약

* **Taint/Toleration은 "거부"의 개념입니다.** 테인트가 없는 노드에는 어떤 파드든 갈 수 있습니다.
* 특정 파드를 **특정 노드에만 "반드시" 배포**하고 싶다면, `NodeAffinity`나 `NodeSelector`를 테인트와 **함께 사용**해야 완벽한 격리 아키텍처가 완성됩니다.
* AWS 환경에서 테인트를 사용할 경우, `Managed Node Group` 설정 시 테인트를 함께 정의하여 노드 추가/제거 시에도 설정이 유지되도록 관리하는 것이 중요합니다.

---

## Next Step:

**NodeAffinity와 Taints/Tolerations를 조합한 전용 노드 그룹(Dedicated Node Group) 설계 실습**

거부(Taint)와 선호(Affinity)를 조합하면 특정 팀이나 프로젝트만의 완벽한 독립 인프라를 구축할 수 있습니다. 

> **참고:** AWS 사용 시 스팟 인스턴스 활용과 관련된 노드 드레인(Drain) 설정 시 `NoExecute` 테인트가 어떻게 연동되는지 확인하면 운영 효율을 더 높일 수 있습니다.
>
> ---
> 쿠버네티스 환경에서 여러 팀이나 프로젝트가 인프라를 공유하는 **멀티테넌시(Multi-tenancy)**를 구축할 때, 단순히 '거부(Taint)'만 하거나 '선호(Affinity)'만 하는 것으로는 부족합니다.

두 기능을 결합하여 특정 팀의 파드가 **오직 지정된 노드에만 배치**되고, **다른 팀의 파드는 절대 그 노드에 들어오지 못하게** 만드는 '완벽한 격리' 설계 방법을 정리합니다.

---

## 전용 노드 그룹(Dedicated Node Group) 구성을 위한 결합 전략

논리적 격리를 완성하기 위해서는 다음 두 가지 장벽을 동시에 세워야 합니다.

1. **입장 제한 (Taint & Toleration):** 허락되지 않은 파드가 전용 노드에 들어오는 것을 차단합니다.
2. **전용 구역 지정 (Node Affinity):** 전용 파드가 다른 일반 노드로 흩어지지 않고 반드시 지정된 구역으로만 가도록 강제합니다.

---

## 실무 구성 단계 (Step-by-Step)

### 1단계: 노드에 라벨(Label)과 테인트(Taint) 부여

먼저 '금융팀(fintech)' 전용으로 사용할 노드들에 식별표를 붙이고 거부막을 형성합니다.

```bash
# 노드에 식별 라벨 부여
kubectl label nodes node-01 team=fintech

# 노드에 거부 테인트 설정 (다른 파드 진입 차단)
kubectl taint nodes node-01 team=fintech:NoSchedule

```

### 2단계: 파드에 톨러레이션(Toleration)과 어피니티(Affinity) 설정

금융팀의 애플리케이션 YAML에 '입장 허가증'과 '강제 이동 경로'를 동시에 정의합니다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fintech-api
spec:
  template:
    spec:
      # 1. 테인트를 견디고 입장하기 위한 설정
      tolerations:
      - key: "team"
        operator: "Equal"
        value: "fintech"
        effect: "NoSchedule"
      
      # 2. 반드시 해당 라벨이 있는 노드로만 가도록 강제하는 설정
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: team
                operator: In
                values:
                - fintech
      containers:
      - name: api-server
        image: fintech/api:v1

```

---

## 왜 두 기능을 모두 써야 하는가?

| 구성 방식 | 결과 | 문제점 |
| --- | --- | --- |
| **Taint/Toleration만 사용** | 금융팀 파드가 전용 노드에 갈 수 있음 | 금융팀 파드가 일반 노드(테인트 없는 곳)로 흩어질 수 있음 |
| **Node Affinity만 사용** | 금융팀 파드가 반드시 전용 노드에 배치됨 | 일반 팀 파드들도 자리가 남으면 금융팀 노드에 들어올 수 있음 |
| **두 기능 결합 (권장)** | **완벽한 격리 성공** | 금융팀 파드는 전용 노드에만, 일반 파드는 진입 불가 |

---

## 실무 아키텍트의 멀티테넌시 체크리스트

* **네임스페이스 격리:** 논리적인 구분뿐만 아니라 `ResourceQuota`와 `LimitRange`를 사용하여 각 팀별 리소스 사용량을 제한해야 합니다.
* **네트워크 정책(Network Policy):** 노드 레벨의 격리를 마쳤다면, 파드 간 통신을 차단하는 네트워크 방화벽 설정을 통해 보안을 완성합니다.
* **자동화 고려:** AWS EKS를 사용 중이라면 `Managed Node Group` 생성 시 `Taints`와 `Labels`를 한 번에 정의하여 노드가 오토스케일링될 때도 설정이 유지되도록 구성하십시오.

---

## Next Step:

**네트워크 정책(Network Policy)을 통한 파드 간 보안 격리 실습**


> **참고:** AWS 환경에서는 Fargate를 사용할 경우 노드 관리가 필요 없으나, 위와 같은 정교한 격리 제어가 필요한 경우 EC2 기반의 노드 그룹 관리가 더 유리합니다. 비용 최적화를 위해 테넌트별 태그를 통한 비용 배분(Cost Allocation) 설정도 함께 검토해 보시기 바랍니다.
