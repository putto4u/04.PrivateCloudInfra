ìë™í™” ì „ë¬¸ê°€ì˜ ê´€ì ì—ì„œ, **Ansible Playbook**ì„ ì´ìš©í•œ Dockerì™€ Kubernetes(K8s) ì„¤ì¹˜ëŠ” ì¸í”„ë¼ë¥¼ ì¼ê´€ë˜ê³  ë°˜ë³µ ê°€ëŠ¥í•˜ë©° í™•ì¥ì„± ìˆê²Œ êµ¬ì¶•í•˜ëŠ” **ê°€ì¥ í‘œì¤€ì ì¸ ë°©ë²•**ì…ë‹ˆë‹¤.

Docker ì„¤ì¹˜ëŠ” ë¹„êµì  ê°„ë‹¨í•˜ì§€ë§Œ, K8s í´ëŸ¬ìŠ¤í„° êµ¬ì¶•ì€ \*\*`kubeadm`\*\*ì„ ê¸°ë°˜ìœ¼ë¡œ ë³µì¡í•œ ì„ í–‰ ì¡°ê±´ê³¼ ë§ˆìŠ¤í„°/ì›Œì»¤ ë…¸ë“œë³„ ì‘ì—…ì„ ìš”êµ¬í•©ë‹ˆë‹¤. ì´ ëª¨ë“  ê³¼ì •ì„ í•˜ë‚˜ì˜ Playbook ì„¸íŠ¸ë¡œ ìë™í™”í•˜ëŠ” ê²ƒì´ í•µì‹¬ì…ë‹ˆë‹¤.

### 1\. Ansible í™˜ê²½ ë° ì‚¬ì „ ì¤€ë¹„ ì‚¬í•­

Dockerì™€ K8s ì„¤ì¹˜ë¥¼ ìë™í™”í•˜ê¸° ì „ì— ë‹¤ìŒ ì‚¬í•­ì´ ì „ì œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

  * **Ansible ì»¨íŠ¸ë¡¤ ë…¸ë“œ:** Playbookì„ ì‹¤í–‰í•  ì¤‘ì•™ ì„œë²„(SSH ì ‘ì† ë° Ansible ì„¤ì¹˜ í•„ìˆ˜).
  * **ê´€ë¦¬ ëŒ€ìƒ ë…¸ë“œ(Target Nodes):** Dockerì™€ K8sê°€ ì„¤ì¹˜ë  VM ë˜ëŠ” ì„œë²„. (OS: Ubuntu ë˜ëŠ” CentOS ê¶Œì¥)
  * **SSH í‚¤ ê¸°ë°˜ ì¸ì¦:** ì»¨íŠ¸ë¡¤ ë…¸ë“œì—ì„œ ëª¨ë“  ëŒ€ìƒ ë…¸ë“œë¡œ ë¹„ë°€ë²ˆí˜¸ ì—†ì´ \*\*`ssh-copy-id`\*\*ë¥¼ í†µí•´ ì ‘ì† ê°€ëŠ¥í•´ì•¼ í•©ë‹ˆë‹¤. (`ansible_become: yes` ì‚¬ìš© ì‹œ sudo ë¹„ë°€ë²ˆí˜¸ ì—†ì´ ê¶Œí•œ ìƒìŠ¹ ê°€ëŠ¥)
  * **Inventory íŒŒì¼ êµ¬ì„±:** ë§ˆìŠ¤í„° ë…¸ë“œì™€ ì›Œì»¤ ë…¸ë“œë¥¼ ëª…í™•íˆ êµ¬ë¶„í•˜ëŠ” ê·¸ë£¹ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.

<!-- end list -->

```ini
[master]
k8s-master ansible_host=192.168.1.10

[worker]
k8s-worker1 ansible_host=192.168.1.11
k8s-worker2 ansible_host=192.168.1.12

[all:vars]
ansible_user=ubuntu 
ansible_become=yes # sudo ê¶Œí•œ ì‚¬ìš©
```

-----

### 2\. Playbookì„ ì´ìš©í•œ Docker ì„¤ì¹˜ (Container Runtime)

K8sëŠ” \*\*ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ì¸í„°í˜ì´ìŠ¤(CRI)\*\*ë¥¼ í•„ìš”ë¡œ í•©ë‹ˆë‹¤. **Containerd**ê°€ ì¿ ë²„ë„¤í‹°ìŠ¤ì˜ ê¸°ë³¸ ëŸ°íƒ€ì„ì´ì§€ë§Œ, Dockerë¥¼ í¬í•¨í•˜ì—¬ ì„¤ì¹˜í•˜ëŠ” ê²ƒì´ ê´€ë¦¬ í¸ì˜ì„±ì—ì„œ ìœ ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**`docker-install.yml`** (ëª¨ë“  ë…¸ë“œì—ì„œ ì‹¤í–‰)

```yaml
---
- name: ğŸš€ Install Docker (Container Runtime for K8s)
  hosts: all
  become: yes
  tasks:
    # 1. ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Update apt cache and install prerequisites
      ansible.builtin.apt:
        name: 
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
        state: present
        update_cache: yes

    # 2. Docker GPG í‚¤ ë° Repository ì¶”ê°€
    - name: Add Docker GPG apt Key
      ansible.builtin.apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
        
    - name: Add Docker Repository
      ansible.builtin.apt_repository:
        repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable
        state: present
        
    # 3. Docker Engine ë° ê´€ë ¨ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (containd.io í¬í•¨)
    - name: Install Docker Packages
      ansible.builtin.apt:
        name: 
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present

    # 4. ì¼ë°˜ ì‚¬ìš©ìì—ê²Œ Docker ê¶Œí•œ ë¶€ì—¬
    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
```

-----

### 3\. Playbookì„ ì´ìš©í•œ Kubernetes ì„¤ì¹˜ (kubeadm ê¸°ë°˜)

ì¿ ë²„ë„¤í‹°ìŠ¤ ì„¤ì¹˜ëŠ” **ìŠ¤ì™‘ ë¹„í™œì„±í™”, ë„¤íŠ¸ì›Œí¬ ì„¤ì •, Kube-tools ì„¤ì¹˜, í´ëŸ¬ìŠ¤í„° ì´ˆê¸°í™”**ì˜ 4ë‹¨ê³„ë¡œ ë‚˜ë‰©ë‹ˆë‹¤.

#### A. Pre-requisite Playbook (`k8s-prep.yml`)

K8s ì„¤ì¹˜ë¥¼ ìœ„í•œ ì„ í–‰ ì¡°ê±´(ëª¨ë“  ë…¸ë“œì—ì„œ í•„ìˆ˜)ì„ ì„¤ì •í•©ë‹ˆë‹¤.

```yaml
---
- name: âš™ï¸ Kubernetes Pre-requisites Setup
  hosts: all
  become: yes
  tasks:
    # 1. Swap ë©”ëª¨ë¦¬ ë¹„í™œì„±í™” (Kubelet ìš”êµ¬ ì‚¬í•­)
    - name: Disable swap permanently (comment out fstab entry)
      ansible.builtin.replace:
        path: /etc/fstab
        regexp: '^(\s*)([^#]+\s+swap\s+sw\s+.*)$'
        replace: '#\2'
        
    - name: Turn off swap immediately
      ansible.builtin.command: swapoff -a
      when: ansible_swaptotal_mb > 0

    # 2. ë¸Œë¦¿ì§€ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì— ëŒ€í•œ iptables í™•ì¸ ì„¤ì • (K8s ë„¤íŠ¸ì›Œí‚¹ í•„ìˆ˜)
    - name: Configure sysctl for Kubernetes networking
      ansible.builtin.sysctl:
        name: "{{ item }}"
        value: '1'
        state: present
        reload: yes
      loop:
        - net.bridge.bridge-nf-call-iptables
        - net.bridge.bridge-nf-call-ip6tables
        - net.ipv4.ip_forward
        
    # 3. Kubernetes Tools ì„¤ì¹˜ (kubeadm, kubelet, kubectl)
    - name: Add Kubernetes GPG Key
      ansible.builtin.apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present

    - name: Add Kubernetes Repository
      ansible.builtin.apt_repository:
        repo: deb https://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: kubernetes
        
    - name: Install kubelet, kubeadm, kubectl and hold their versions
      ansible.builtin.apt:
        name: 
          - kubelet={{ kube_version }}
          - kubeadm={{ kube_version }}
          - kubectl={{ kube_version }}
        state: present
        update_cache: yes

    - name: Mark K8s packages to hold (prevent accidental upgrade)
      ansible.builtin.dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop:
        - kubelet
        - kubeadm
        - kubectl
```

#### B. Master Node ì´ˆê¸°í™” (`k8s-master-init.yml`)

ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ í´ëŸ¬ìŠ¤í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ì›Œì»¤ ë…¸ë“œê°€ ì¡°ì¸í•  í† í°ì„ ìƒì„±í•©ë‹ˆë‹¤.

```yaml
---
- name: ğŸ‘‘ Initialize Kubernetes Master Node
  hosts: master
  become: yes
  vars:
    # ì˜ˆ: ì›í•˜ëŠ” K8s ë²„ì „ (Playbook ì‹¤í–‰ ì‹œ --extra-vars "kube_version=1.29.0-00" ë¡œ ë³€ê²½ ê°€ëŠ¥)
    kube_version: "1.29.0-00" 
    pod_network_cidr: "10.244.0.0/16" # Calico CNI í‘œì¤€ CIDR
  tasks:
    - name: Initialize the Kubernetes Cluster (kubeadm init)
      ansible.builtin.command: >
        kubeadm init 
        --pod-network-cidr={{ pod_network_cidr }} 
        --ignore-preflight-errors=NumCPU
      register: kubeadm_init_result # ê²°ê³¼ ì €ì¥

    - name: Create .kube directory for cluster config
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.kube
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
        
    - name: Copy admin.conf to user's .kube directory
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/{{ ansible_user }}/.kube/config
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    # Calico CNI ì„¤ì¹˜ (ë„¤íŠ¸ì›Œí¬ í”ŒëŸ¬ê·¸ì¸)
    - name: Install Calico CNI Network Plugin
      ansible.builtin.command: >
        kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

    # ì›Œì»¤ ë…¸ë“œ ì¡°ì¸ ëª…ë ¹ ìƒì„± (í† í° ì¶”ì¶œ)
    - name: Generate join command for worker nodes
      ansible.builtin.command: >
        kubeadm token create --print-join-command
      register: join_command_result
    
    - name: Display join command
      ansible.builtin.debug:
        msg: "Worker Join Command: {{ join_command_result.stdout }}"
      delegate_to: localhost # ê²°ê³¼ë¥¼ ì»¨íŠ¸ë¡¤ ë…¸ë“œ í„°ë¯¸ë„ì— ì¶œë ¥
```

#### C. Worker Node ì¡°ì¸ (`k8s-worker-join.yml`)

ì›Œì»¤ ë…¸ë“œë¥¼ í´ëŸ¬ìŠ¤í„°ì— í•©ë¥˜ì‹œí‚µë‹ˆë‹¤. (ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ì–»ì€ í† í° ì‚¬ìš©)

```yaml
---
- name: ğŸ¤ Join Worker Nodes to Cluster
  hosts: worker
  become: yes
  tasks:
    # Master Playbookì—ì„œ ìƒì„±ëœ í† í°ì„ ë³µì‚¬í•˜ì—¬ ì‹¤í–‰
    - name: Execute join command on worker nodes
      ansible.builtin.shell: 
        cmd: "{{ hostvars['k8s-master']['join_command_result']['stdout'] }}"
      register: join_output
      changed_when: join_output.rc == 0
```

-----

### 4\. ì‹¤í–‰ ìˆœì„œ ë° ë§ˆë¬´ë¦¬

Playbookì€ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

1.  **Docker ì„¤ì¹˜:**
    ```bash
    ansible-playbook docker-install.yml -i inventory
    ```
2.  **K8s ì‚¬ì „ ì¤€ë¹„:**
    ```bash
    ansible-playbook k8s-prep.yml -i inventory
    ```
3.  **ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”:**
    ```bash
    ansible-playbook k8s-master-init.yml -i inventory
    ```
4.  **ì›Œì»¤ ë…¸ë“œ ì¡°ì¸:**
    ```bash
    ansible-playbook k8s-worker-join.yml -i inventory
    ```

**ìµœì¢… í™•ì¸:** ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì—¬ ëª¨ë“  ë…¸ë“œê°€ **`Ready`** ìƒíƒœì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.

```bash
kubectl get nodes
```

ì´ ìë™í™”ëœ ì ‘ê·¼ ë°©ì‹ì€ DevOps í™˜ê²½ì—ì„œ ê°€ì¥ íš¨ìœ¨ì ì¸ í´ëŸ¬ìŠ¤í„° êµ¬ì¶• ë°©ë²•ì´ë©°, í•„ìš” ì‹œ **Kubespray**ì™€ ê°™ì€ ì „ë¬¸ì ì¸ Ansible ê¸°ë°˜ K8s ì„¤ì¹˜ ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
