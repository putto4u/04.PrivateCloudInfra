기존에 구축된 Kubernetes 마스터 노드(Control Plane)의 설정과 상태를 그대로 복제하여 두 번째 마스터 노드를 구성하거나, 전체 클러스터 상태를 코드화(IaC)하기 위해 YAML 파일을 추출하는 방법입니다.

단순히 `kubectl get -o yaml`을 사용하는 것을 넘어, 클러스터의 핵심 설정과 인증서, 정적 포드(Static Pods) 설정을 모두 확보해야 합니다.

---

## 1. 쿠버네티스 객체 정보 추출 (API 리소스)

클러스터 내에 정의된 모든 리소스(Deployments, Services, ConfigMaps 등)를 YAML로 백업합니다.

### **모든 리소스 일괄 추출 스크립트**

특정 네임스페이스나 전체 클러스터의 리소스를 개별 YAML 파일로 저장하는 방식입니다.

```bash
# 모든 네임스페이스의 주요 리소스 추출
for n in $(kubectl get -o name namespaces); do
  mkdir -p backup/${n}
  kubectl get -o yaml --export $n > backup/${n}/all-resources.yaml
done

```

> [!TIP] **추천 도구: velero 또는 k8s-backup**
> 수동 추출보다는 **Velero** 같은 전문 백엔드 백업 도구를 사용하여 스냅샷을 찍는 것이 온프레미스 환경에서 훨씬 안전합니다.

---

## 2. 컨트롤 플레인 핵심 설정 파일 복사

마스터 노드의 심장부인 `/etc/kubernetes/` 디렉토리의 파일들을 확보해야 합니다. 이는 YAML 기반으로 동작하는 정적 포드들의 정의서입니다.

* **경로:** `/etc/kubernetes/manifests/`
* **대상 파일:**
* `kube-apiserver.yaml`
* `kube-controller-manager.yaml`
* `kube-scheduler.yaml`
* `etcd.yaml`



이 파일들을 복사하여 마스터 2번의 동일 경로에 넣으면, `kubelet`이 이를 감지하여 컨트롤 플레인 컴포넌트들을 자동으로 실행합니다.

---

## 3. Kubeadm 설정 정보 추출

`kubeadm`으로 설치했다면, 클러스터 초기화 시 사용된 설정(ClusterConfiguration)을 YAML로 다시 뽑아낼 수 있습니다. 이 정보는 마스터 2번을 조인(Join)시킬 때 매우 중요합니다.

```bash
# 현재 실행 중인 클러스터의 kubeadm 설정 추출
kubectl -n kube-system get configmap kubeadm-config -o jsonpath='{.data.ClusterConfiguration}' > kubeadm-config.yaml

```

---

## 4. 인증서 및 토큰 관리 (핵심 작업)

마스터 노드를 추가할 때는 YAML 파일뿐만 아니라 **인증서(CA)** 공유가 필수적입니다.

* **인증서 위치:** `/etc/kubernetes/pki/`
* **공유 필수 파일:** `ca.crt`, `ca.key`, `sa.key`, `sa.pub` 등 (모든 pki 디렉토리 복사 권장)
* **조인 토큰 생성:**
```bash
# 마스터 노드 추가를 위한 조인 커맨드와 인증서 키 생성
kubeadm token create --print-join-command --certificate-key $(kubeadm init phase upload-certs --upload-certs | tail -1)

```



---

## 5. 전체 작업 체크리스트 (Summary)

| 단계 | 작업 내용 | 비고 |
| --- | --- | --- |
| **1. Config 추출** | `kubeadm-config`를 YAML로 저장 | 클러스터 설정 일관성 유지 |
| **2. Manifest 복사** | `/etc/kubernetes/manifests` 내 YAML 복사 | 정적 포드 실행용 |
| **3. PKI 복사** | `/etc/kubernetes/pki` 내 인증서 전체 복사 | 보안 컨텍스트 유지 |
| **4. 인프라 설정** | `/etc/cni/net.d` 네트워크 설정 복사 | CNI 플러그인 동기화 |

---

> [!CAUTION] **중복 및 충돌 주의 (과금/리소스)**
> * **IP 주소:** YAML 내에 특정 IP(예: `advertise-address`)가 하드코딩되어 있다면 마스터 2번의 IP로 반드시 수정해야 합니다.
> * **로드밸런서 비용:** 온프레미스에서 마스터를 다중화(HA)할 경우, 상단에 **Keepalived**나 **HAProxy** 같은 가상 IP(VIP) 장치가 필수입니다. AWS 등 클라우드 환경이라면 NLB/ALB 사용에 따른 추가 과금이 발생합니다.
> 
> 

Next Step: **kubeadm을 이용한 마스터 노드 Join 커맨드 실행** 혹은 **Keepalived를 이용한 VIP 설정**

---

**[강의 교재 체크리스트]**

* [x] `nerdctl` 환경을 고려한 컨테이너 기반 설명 유지
* [x] 단순 리소스 추출과 마스터 복제용 설정 구분 명시
* [x] AWS 비용 발생 지점(LB) 언급
* [x] 전문가용 톤앤매너 및 YAML 코드 가독성 확보
* [x] Next Step 핵심 단어 제시 (관련 가이드: [kubeadm join workflow](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-join/))
