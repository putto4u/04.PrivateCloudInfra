네, 마스터 1에서 리소스를 추출하여 백업하는 과정은 **쉘 스크립트 파일**로 만들어 실행하는 것이 가장 정확하고 재사용성이 높습니다. 수백 개의 리소스를 프롬프트에서 일일이 명령어로 치는 것은 실수 유발 가능성이 크기 때문입니다.

이 작업은 **마스터 1번 서버의 일반 사용자 홈 디렉토리**에서 수행합니다.

---

## 1. 마스터 1 리소스 백업 스크립트 생성 및 실행

이 과정은 클러스터의 모든 설정(YAML)을 파일로 내려받는 과정입니다.

### **Step 1: 백업 스크립트 파일 생성**

마스터 1번 서버에서 아래 명령어로 쉘 파일을 만듭니다.

```bash
# 1. 홈 디렉토리로 이동합니다.
cd $HOME

# 2. vi 에디터로 백업 스크립트 파일을 생성합니다.
vi backup_k8s_resources.sh

```

### **Step 2: 스크립트 내용 작성 (주석 포함)**

`vi` 편집기 안에서 `i`를 눌러 입력 모드로 전환한 뒤 아래 내용을 복사해서 넣으세요.

```bash
#!/bin/bash

# 1. 백업 파일을 저장할 메인 디렉토리명을 변수로 지정합니다. (현재 날짜 포함)
BACKUP_DIR="k8s_backup_$(date +%Y%m%d)"

# 2. 백업 디렉토리를 생성합니다.
mkdir -p $BACKUP_DIR

# 3. 현재 클러스터에 존재하는 모든 네임스페이스 목록을 가져와 반복문을 실행합니다.
for ns in $(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}'); do
    
    # 4. 각 네임스페이스별로 하위 폴더를 생성합니다.
    echo "Processing namespace: $ns"
    mkdir -p "$BACKUP_DIR/$ns"

    # 5. 해당 네임스페이스 내의 모든 리소스를 하나의 YAML 파일로 추출합니다.
    # --export 옵션은 최신 버전에서 제거되었으므로, 필요한 정보만 남기기 위해 아래 형식을 사용합니다.
    kubectl get all,configmaps,secrets,ingresses,persistentvolumeclaims -n "$ns" -o yaml > "$BACKUP_DIR/$ns/resources.yaml"

done

# 6. 네임스페이스에 속하지 않는 클러스터 단위 리소스(Nodes, PV, ClusterRole 등)를 추출합니다.
echo "Processing cluster-scoped resources..."
mkdir -p "$BACKUP_DIR/cluster-scoped"
kubectl get nodes,pv,clusterroles,clusterrolebindings -o yaml > "$BACKUP_DIR/cluster-scoped/cluster-resources.yaml"

# 7. 백업 완료 메시지를 출력합니다.
echo "Backup completed in directory: $BACKUP_DIR"

```

### **Step 3: 스크립트 실행 권한 부여 및 실행**

파일을 저장(`Esc` -> `:wq`)하고 나온 뒤 실행합니다.

```bash
# 3. 작성한 쉘 파일에 실행 권한을 부여합니다.
chmod +x backup_k8s_resources.sh

# 4. 스크립트를 실행합니다. (반드시 kubectl 권한이 있는 마스터 1에서 실행)
./backup_k8s_resources.sh

```

---

## 2. 컨트롤 플레인 및 인증서 물리적 복사

API 서버의 설정과 인증서는 `kubectl`로 추출할 수 없으므로, 직접 디렉토리를 복사해야 합니다.

```bash
# 1. 홈 디렉토리에 물리 설정 백업용 폴더를 만듭니다.
mkdir -p $HOME/k8s_physical_config

# 2. 정적 포드(API서버, 스케줄러 등) 설정 YAML들을 복사합니다.
sudo cp -r /etc/kubernetes/manifests $HOME/k8s_physical_config/

# 3. 클러스터 인증서 및 키 파일들을 복사합니다. (매우 중요)
sudo cp -r /etc/kubernetes/pki $HOME/k8s_physical_config/

# 4. 소유권을 현재 사용자(예: ubuntu)로 변경하여 나중에 전송하기 쉽게 만듭니다.
sudo chown -R $(id -u):$(id -g) $HOME/k8s_physical_config

```

---

## 3. 요약: 어디서 무엇을 실행하나?

| 작업 구분 | 실행 위치 | 방식 | 비고 |
| --- | --- | --- | --- |
| **객체 정보 추출** | 마스터 1 (프롬프트) | 쉘 스크립트 실행 | `kubectl`이 관리하는 모든 리소스 추출 |
| **파일 복사** | 마스터 1 (프롬프트) | `cp` 명령 | `/etc/kubernetes` 내 실제 설정/인증서 복사 |
| **파일 전송** | 마스터 1 (프롬프트) | `scp` 명령 | 생성된 백업 폴더를 마스터 2로 전송 |

---
[!CAUTION] AWS 환경 운영 및 보안 주의

보안 위험: 복사된 k8s_physical_config 폴더 안에는 클러스터 전체 권한을 가진 **Root CA 키(ca.key)**가 포함되어 있습니다.

관리 주의: 이 파일들이 외부에 노출되면 클러스터 보안이 완전히 무너지므로, 전송 완료 후에는 백업 폴더를 삭제하거나 AWS Secret Manager 등을 활용하여 암호화 보관하는 것을 권장합니다.


> [!CAUTION] **AWS 환경 운영 시 과금 및 보안 주의**
> * **S3 활용:** 만약 이 백업본을 AWS S3에 업로드하여 관리한다면, S3 저장 비용 및 데이터 전송 비용이 발생합니다.
> * **Secret 보안:** `resources.yaml` 파일 내에는 DB 비밀번호 등 민감한 정보(Secret)가 평문(Base64)으로 들어있습니다. 이 파일을 깃허브 등에 올릴 때는 반드시 **Public**이 아닌 **Private** 저장소를 사용하거나 암호화 도구를 사용해야 합니다.
> 
> 

Next Step: **Master 2로 백업 파일 전송 및 적용**

---
