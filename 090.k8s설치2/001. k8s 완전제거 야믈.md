# 프로젝트: Kubernetes 클러스터 완전 초기화 및 잔존물 제거 (Deep Reset)

Kubernetes 운영 중 CNI(Flannel, Calico 등)를 교체하거나, 이전 설치의 잔존물로 인해 재설치가 실패하는 경우를 대비한 **완벽한 초기화(Deep Reset)** 프로세스입니다. 단순히 `kubeadm reset`만 수행할 경우 가상 네트워크 인터페이스나 iptables 규칙이 남아 재설치 시 충돌을 일으킬 수 있습니다.

---

### 1. 초기화가 필요한 주요 상황

* **CNI 교체**: Calico에서 Flannel로 변경하거나 그 반대의 경우
* **네트워크 충돌**: Pod 네트워크 대역(CIDR) 변경이 필요한 경우
* **설치 실패 후 재시도**: `kubeadm init` 도중 에러로 인해 환경이 불투명해진 경우
* **노드 역할 변경**: 워커 노드를 클러스터에서 완전히 제거하고 재편성할 때

---

### 2. Ansible Playbook: k8s_deep_reset.yml

이 플레이북은 `kubeadm reset`을 포함하여 CNI 가상 인터페이스 삭제, iptables 초기화, 설정 파일 물리적 제거를 수행합니다.

```yaml
- name: Kubernetes 클러스터 완전 초기화 및 잔존물 제거
  hosts: all
  become: yes
  tasks:
    # [1] K8s 기본 초기화 실행
    - name: Kubeadm Reset 실행
      shell: |
        kubeadm reset -f
        rm -rf /etc/cni/net.d
      ignore_errors: yes

    # [2] 서비스 중지 및 런타임 정리
    - name: Kubelet 및 컨테이너 런타임 중지
      systemd:
        name: "{{ item }}"
        state: stopped
      loop: [kubelet, containerd]
      ignore_errors: yes

    # [3] 네트워크 인터페이스 및 라우팅 삭제 (CNI 잔존물 제거)
    - name: CNI 가상 네트워크 인터페이스 강제 삭제
      shell: |
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        ip link delete calico-vpp-tap0 || true
        ip link delete tunl0 || true
        # bridge 인터페이스가 남아있을 경우 삭제
        ip link set dev cni0 down || true
        ip link delete cni0 type bridge || true
      ignore_errors: yes

    # [4] Iptables 및 IPVS 규칙 초기화 (네트워크 꼬임 방지)
    - name: Iptables 규칙 전면 초기화
      shell: |
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
        ipvsadm --clear || true
      ignore_errors: yes

    # [5] 물리적 디렉토리 및 설정 파일 완전 제거
    - name: K8s 관련 데이터 디렉토리 삭제
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /var/lib/cni
        - "{{ ansible_facts['env']['HOME'] }}/.kube"
        - "/root/.kube"

    # [6] 시스템 재시작 (권장사항이나 필요시 수동 실행)
    - name: Containerd 서비스 재시작 (정화된 상태로 대기)
      systemd:
        name: containerd
        state: restarted

```

---

### 3. 초기화 후 수동 확인 작업 (Checklist)

플레이북 실행 후 **예비서버(pc)**에서 아래 명령어로 잔존물이 없는지 최종 확인합니다.

1. **네트워크 인터페이스 확인**:
```bash
ip a

```


> `cni0`, `flannel.1`, `calico` 등의 명칭이 포함된 인터페이스가 없어야 합니다.


2. **커널 라우팅 테이블 확인**:
```bash
route -n

```


> 10.244.0.0(Pod CIDR) 등으로 향하는 라우팅 경로가 삭제되었는지 확인합니다.


3. **프로세스 확인**:
```bash
ps -ef | grep kube

```


> `kubelet`, `kube-apiserver` 등이 실행 중이지 않아야 합니다.



---

### 4. 실전 팁: 완전 정화 후 재설치 전략

* **순서의 중요성**: 모든 **예비서버(pc)**를 먼저 `deep_reset` 한 뒤에, **마스터 PC**에서 다시 `k8s_setup.yml`을 돌려 패키지 상태를 점검하고 `kubeadm init`을 수행해야 합니다.
* **브릿지 필터링 재확인**: 초기화 과정에서 `sysctl` 설정이 초기화될 수 있으므로, 재설치 시 `net.bridge.bridge-nf-call-iptables = 1` 값이 살아있는지 반드시 확인해야 합니다 (제공된 설치 플레이북에 포함되어 있음).

> **AWS 비용 참고**: 초기화 작업 자체는 비용을 발생시키지 않으나, 문제를 해결하지 못해 인스턴스를 계속 켜둘 경우 EC2 사용료가 부과됩니다. 해결이 안 될 경우 인스턴스를 종료(Terminate)하고 새로 생성하는 것이 시간과 비용 면에서 효율적일 수 있습니다.

---

Next Step: CNI(Calico/Flannel) 문제 해결 및 트래픽 로그 분석

---

이 플레이북은 클러스터 상태를 '공장 초기화' 수준으로 되돌립니다. CNI가 꼬여서 파드 간 통신이 안 될 때 가장 효과적인 해결책입니다.

Next Step: MetalLB 및 Ingress 재설정 가이드
