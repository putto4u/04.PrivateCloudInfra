쿠버네티스 클러스터를 수동으로 하나씩 초기화하는 것은 번거로울 뿐만 아니라 실수로 네트워크 설정을 누락할 위험이 있습니다. 이를 자동화하기 위해 **앤서블(Ansible) 플레이북**을 활용하여 마스터 PC와 예비서버(Worker PC) 전체를 한 번에, 안전하게 초기화하는 코드를 구성했습니다.

---

## 쿠버네티스 완전 제거 및 초기화 플레이북 (Ansible)

이 플레이북은 SSH 연결이 끊기지 않도록 `iptables` 정책을 먼저 보호하고, 잔류 파일과 가상 네트워크 인터페이스를 완벽히 소거합니다.

### 1. `k8s_cleanup.yml` 파일 작성

```yaml
---
- name: Kubernetes Cluster Complete Cleanup
  hosts: all
  become: yes
  vars:
    # 삭제할 쿠버네티스 관련 디렉토리 목록
    k8s_directories:
      - /etc/kubernetes
      - /var/lib/kubelet
      - /var/lib/etcd
      - /etc/cni
      - /opt/cni/bin
      - /var/lib/cni
      - /var/run/calico
      - ~/.kube

  tasks:
    - name: 1. Kubeadm 초기화 실행
      shell: kubeadm reset -f
      ignore_errors: yes

    - name: 2. 컨테이너 및 런타임 정리 (containerd)
      shell: |
        crictl ps -a -q | xargs -r crictl stop
        crictl ps -a -q | xargs -r crictl rm
      ignore_errors: yes

    - name: 3. 네트워크 정책 안전 확보 (SSH 차단 방지)
      # iptables 정책을 ACCEPT로 먼저 변경하여 세션 유실 방지
      shell: |
        iptables -P INPUT ACCEPT
        iptables -P FORWARD ACCEPT
        iptables -P OUTPUT ACCEPT
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X

    - name: 4. 마운트 잔류 확인 및 해제
      # kubelet 관련 마운트가 남아있으면 디렉토리 삭제가 안 되므로 해제
      shell: |
        if mount | grep -q /var/lib/kubelet; then
          cut -d ' ' -f 3 /proc/mounts | grep /var/lib/kubelet | xargs -r umount -l
        fi

    - name: 5. 쿠버네티스 패키지 완전 삭제
      apt:
        name:
          - kubeadm
          - kubectl
          - kubelet
          - kubernetes-cni
        state: absent
        purge: yes
        autoremove: yes

    - name: 6. 잔류 디렉토리 강제 삭제
      file:
        path: "{{ item }}"
        state: absent
      loop: "{{ k8s_directories }}"

    - name: 7. 가상 네트워크 인터페이스 제거
      shell: |
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        ip link show | grep cali | awk '{print $2}' | cut -d'@' -f1 | xargs -r -I {} ip link delete {}
        ip neigh flush all

    - name: 8. 시스템 재부팅 (선택 사항)
      # 커널 네트워크 스택을 완전히 깨끗하게 하기 위해 재부팅을 수행할 수 있습니다.
      reboot:
        reboot_timeout: 300

```

---

### 2. 플레이북 주요 설계 포인트

* **Idempotency (멱등성):** 이미 삭제된 상태에서 다시 실행해도 에러가 발생하지 않도록 `ignore_errors`와 조건문을 적절히 사용했습니다.
* **네트워크 안전장치:** `iptables -P INPUT ACCEPT`를 패키지 삭제 및 규칙 초기화보다 먼저 배치하여, 원격 관리 중인 마스터 PC와 예비서버의 SSH 연결이 끊어지는 대참사를 방지합니다.
* **강제 언마운트:** 워커 노드(예비서버)에서 자주 발생하는 '디렉토리 삭제 불가' 에러를 해결하기 위해 `/proc/mounts`를 참조하여 관련 경로를 모두 `umount` 합니다.

---

### 3. 실전 실행 가이드

앤서블 인벤토리 파일(`hosts.ini`)에 마스터와 워커 그룹을 지정한 후 실행합니다.

```bash
# 플레이북 실행 명령
ansible-playbook -i hosts.ini k8s_cleanup.yml

```

> [!TIP]
> **강사 전용 체크포인트**
> 재설치 전, 모든 노드에서 `ip addr` 명령어를 통해 `cni0`나 `flannel.1` 인터페이스가 사라졌는지 수강생들과 함께 확인하세요. 이 인터페이스들이 남아있으면 다음 실습에서 네트워크 대역 충돌이 발생할 확률이 매우 높습니다.

---

> [!NOTE]
> **과금 및 유료 서비스 안내**
> * **AWS NAT Gateway:** 플레이북 실행 후 패키지 재설치를 위해 대량의 데이터를 다운로드할 경우, NAT Gateway를 통과하는 트래픽에 대해 과금이 발생합니다. (GB당 데이터 처리 비용 발생)
> * **AWS EBS:** 플레이북으로 파일을 지우더라도 EBS 볼륨 자체는 남아있습니다. 실습이 완전히 종료되었다면 인스턴스를 종료(Terminate)하여 볼륨이 함께 삭제되도록 해야 보관 비용을 절감할 수 있습니다.
> 
> 

Next Step: **Kubernetes Multi-node Cluster Deployment with Ansible**

---

마스터와 워커 노드 전체에 일괄 적용 가능한 앤서블 플레이북 형식으로 구성했습니다. 네트워크 세션 보호를 위한 `iptables` 정책 설정을 최상단에 배치하여 안전성을 확보했으며, 재설치 시 충돌 없는 환경을 보장하도록 설계했습니다.
