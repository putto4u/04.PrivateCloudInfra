# 프로젝트: Kubernetes 클러스터 완전 초기화 및 잔존물 제거 (Deep Reset)

본 프로젝트는 CNI 교체, 네트워크 설정 오류, 또는 클러스터 재설치가 필요한 경우 기존의 모든 설정과 네트워크 잔존물을 완벽하게 제거하는 과정을 다룹니다. 단순히 `kubeadm reset` 명령만으로는 제거되지 않는 가상 네트워크 인터페이스와 커널 규칙을 앤서블(Ansible)을 통해 일괄 정화합니다.

---

### 1. 개요 및 목적

* **목적**: 클러스터 재설치 시 발생할 수 있는 네트워크 충돌 및 설정 오염 방지
* **핵심 작업**: `kubeadm reset`, CNI 인터페이스 삭제, iptables/IPVS 규칙 초기화, 데이터 디렉토리 물리적 삭제
* **준비물**: 앤서블이 설치된 컨트롤 노드(마스터 PC), 대상 예비서버(pc) 정보가 담긴 인벤토리 파일

---

### 2. Ansible Playbook: `k8s_deep_reset.yml`

이 플레이북은 노드의 상태를 Kubernetes 설치 전의 'Clean' 상태로 되돌리는 데 최적화되어 있습니다.

```yaml
- name: Kubernetes 클러스터 완전 초기화 및 잔존물 제거 (Deep Reset)
  hosts: all
  become: yes
  tasks:
    # [1] K8s 기본 초기화 (소프트웨어적 리셋)
    - name: Kubeadm Reset 실행
      shell: |
        kubeadm reset -f
        rm -rf /etc/cni/net.d
      ignore_errors: yes

    # [2] 서비스 및 런타임 제어
    - name: 관련 서비스 중지
      systemd:
        name: "{{ item }}"
        state: stopped
      loop: [kubelet, containerd]
      ignore_errors: yes

    # [3] 네트워크 잔존물 강제 정화 (CNI 오염 제거 핵심)
    - name: 가상 네트워크 인터페이스 및 브릿지 삭제
      shell: |
        ip link set dev cni0 down || true
        ip link delete cni0 type bridge || true
        ip link delete flannel.1 || true
        ip link delete calico-vpp-tap0 || true
        ip link delete tunl0 || true
        ip link delete nodelocaldns || true
      ignore_errors: yes

    # [4] 네트워크 규칙(L3/L4) 초기화
    - name: Iptables 및 IPVS 규칙 전면 삭제
      shell: |
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
        ipvsadm --clear || true
      ignore_errors: yes

    # [5] 파일 시스템 정리 (물리적 삭제)
    - name: K8s 관련 데이터 및 설정 디렉토리 영구 삭제
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/kubernetes
        - /var/lib/kubelet
        - /var/lib/etcd
        - /var/lib/cni
        - /var/run/calico
        - "{{ ansible_facts['env']['HOME'] }}/.kube"
        - "/root/.kube"

    # [6] 시스템 정화 확인을 위한 런타임 재시작
    - name: Containerd 재시작 (정화된 상태 적용)
      systemd:
        name: containerd
        state: restarted

```

---

### 3. 실행 방법 (Execution Guide)

앤서블 컨트롤 노드(마스터 PC)에서 아래 순서대로 명령을 수행합니다.

1. **대상 서버 통신 확인**:
```bash
ansible all -i hosts.ini -m ping

```


2. **플레이북 실행**:
```bash
# -K 옵션을 통해 sudo 권한 실행 (패스워드 필요 시)
ansible-playbook -i hosts.ini k8s_deep_reset.yml -K

```


3. **특정 노드만 초기화할 경우**:
```bash
ansible-playbook -i hosts.ini k8s_deep_reset.yml -l worker1 -K

```



---

### 4. 확인 및 검증 방법 (Verification)

플레이북 실행 후, 각 **예비서버(pc)**에 접속하여 다음 항목들을 체크하여 완벽히 초기화되었는지 확인합니다.

| 확인 항목 | 실행 명령어 | 정상 상태 결과 |
| --- | --- | --- |
| **네트워크 인터페이스** | `ip a` | `cni0`, `flannel.1`, `tunl0` 등의 인터페이스가 목록에서 사라짐 |
| **프로세스 상태** | `ps -ef | grep kube` |
| **설정 파일 존재 여부** | `ls /etc/kubernetes` | "No such file or directory" 메시지 출력 |
| **Iptables 규칙** | `sudo iptables -L -n` | KUBE-SERVICES 등 K8s 전용 체인이 모두 사라지고 기본 정책만 남음 |
| **라우팅 경로** | `route -n` | Pod CIDR(예: 10.244.0.0)로 향하는 경로가 사라짐 |

---

### 5. 실전 팁 및 주의사항

* **시스템 재부팅**: 초기화 작업 후 네트워크 스택의 완벽한 정리를 위해 가능하다면 노드를 한 번 `reboot` 하는 것이 가장 안전합니다.
* **인벤토리 관리**: 초기화할 노드와 유지할 노드를 인벤토리 파일(`hosts.ini`)에서 명확히 구분하여 실수로 운영 중인 노드를 초기화하지 않도록 주의하십시오.
* **AWS 환경 주의사항**:
* **과금**: EC2 인스턴스를 사용 중이라면 초기화 중에도 가동 시간(Instance Hours)은 계속 산정됩니다. 작업을 멈출 때는 반드시 인스턴스를 '중지' 하십시오.
* **보안 그룹**: CNI를 교체하여 포트 요구사항이 변경되었다면, AWS 보안 그룹(Security Group) 규칙도 함께 업데이트해야 통신이 가능합니다.



---

Next Step: kubeadm init을 활용한 클러스터 재구성 및 네트워크 플러그인 설치

---

프로젝트 목적에 맞게 초기화 및 잔존물 제거를 위한 전문 가이드로 구성했습니다. 특히 `ip link`와 `iptables` 정화 과정을 강화하여 재설치 시 발생할 수 있는 변수를 차단했습니다.

Next Step: Calico와 Flannel CNI 선택 기준 및 성능 비교 분석
