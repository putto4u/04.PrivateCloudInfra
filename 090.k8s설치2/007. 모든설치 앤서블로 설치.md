지적하신 대로 **Ansible**과 `hosts.ini`를 활용하면 마스터 노드 초기화부터 모든 워커 노드의 조인, 환경 설정까지 전체 공정을 **코드 기반(IaC)**으로 한 번에 자동화할 수 있습니다.

수작업으로 처리하던 복잡한 과정들을 하나의 플레이북으로 통합하여 구성해 드립니다.

---

## 쿠버네티스 구축 및 환경 최적화 자동화 (Ansible)

### 1. 인벤토리 파일 설정 (`hosts.ini`)

먼저 클러스터에 참여할 노드들의 정보를 정의합니다.

```ini
[masters]
k8s-master ansible_host=192.168.0.200

[workers]
k8s-worker01 ansible_host=192.168.0.201
k8s-worker02 ansible_host=192.168.0.202

[all:vars]
ansible_user=master
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
k8s_version='1.30.14-1.1'
pod_network_cidr='10.244.0.0/16'

```

---

### 2. 통합 플레이북 작성 (`k8s-deploy.yml`)

이 플레이북은 패키지 설치부터 조인 토큰 생성, `admin.conf` 배포 및 자동 완성 설정까지 모든 단계를 포함합니다.

```yaml
---
- name: Kubernetes 클러스터 구축 및 최적화
  hosts: all
  become: yes
  tasks:
    - name: 1. OS 환경 및 런타임(containerd) 설치
      apt:
        name: [containerd, bash-completion]
        state: present
        update_cache: yes

    - name: 2. K8s 도구 설치 및 버전 고정
      apt:
        name:
          - "kubelet={{ k8s_version }}"
          - "kubeadm={{ k8s_version }}"
          - "kubectl={{ k8s_version }}"
        state: present
      register: k8s_tools

    - name: 도구 버전 고정
      shell: apt-mark hold kubelet kubeadm kubectl
      when: k8s_tools.changed

- name: 마스터 노드 초기화 및 설정
  hosts: masters
  become: yes
  tasks:
    - name: kubeadm init 실행 (이미 초기화된 경우 무시)
      shell: |
        kubeadm init --pod-network-cidr={{ pod_network_cidr }} --kubernetes-version=1.30.14
      args:
        creates: /etc/kubernetes/admin.conf

    - name: 관리자 환경 설정 (.kube/config)
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: admin.conf 복사
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "/home/{{ ansible_user }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

    - name: 조인 명령어 추출
      shell: kubeadm token create --print-join-command
      register: join_command

    - name: 자동 완성 및 별칭 설정
      lineinfile:
        path: "/home/{{ ansible_user }}/.bashrc"
        line: "{{ item }}"
      with_items:
        - "source <(kubectl completion bash)"
        - "alias k=kubectl"
        - "complete -o default -F __start_kubectl k"

- name: 워커 노드 조인 및 환경 설정
  hosts: workers
  become: yes
  vars:
    join_cmd: "{{ hostvars[groups['masters'][0]]['join_command']['stdout'] }}"
  tasks:
    - name: 클러스터 조인 실행
      shell: "{{ join_cmd }} --cri-socket /run/containerd/containerd.sock"
      args:
        creates: /etc/kubernetes/kubelet.conf

    - name: 워커 노드용 .kube/config 배포 (마스터의 파일 전송)
      file:
        path: "/home/{{ ansible_user }}/.kube"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: 마스터의 admin.conf를 워커로 복사
      copy:
        content: "{{ hostvars[groups['masters'][0]]['ansible_facts']['file_contents'] | default(lookup('file', '/etc/kubernetes/admin.conf')) }}"
        dest: "/home/{{ ansible_user }}/.kube/config"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'

```

---

### 3. 실행 방법 및 확인

#### 실행 단계

마스터 노드 또는 관리 PC에서 아래 명령어를 실행합니다.

```bash
# 플레이북 구동
ansible-playbook -i hosts.ini k8s-deploy.yml -K

```

#### 확인 방법

설치가 완료되면 마스터 노드에서 다음 명령어로 클러스터 상태를 확인합니다.

```bash
# 1. 노드 상태 확인
k get nodes

# 2. 자동 완성 작동 확인
# k get po [TAB][TAB] 을 눌러서 자동 완성이 되는지 확인

```

---

### 4. 실전 활용 팁 및 트러블슈팅

* **Idempotency (멱등성):** 이 플레이북은 `creates` 옵션을 사용하여 이미 구축된 경우 중복 실행되지 않도록 설계되었습니다.
* **권한 문제:** `become: yes`를 통해 모든 명령은 root 권한으로 실행되며, 최종 설정 파일만 일반 사용자의 소유로 변경합니다.

---

### AWS 환경 및 비용 참고

* **EBS 성능:** 다수의 노드에 동시에 패키지를 설치하므로, `gp3` 볼륨의 경우 **처리량(Throughput)** 설정에 따라 설치 속도가 달라질 수 있습니다.
* **비용:** Ansible 실행 자체는 무료입니다. 다만, 모든 노드에서 동시에 `apt update`를 수행하므로 AWS 리전 외부망과의 통신에 따른 **Data Transfer 비용**이 발생할 수 있으나, 이는 수동 구축 시와 동일한 수준입니다.

---

Next Step: Ansible을 이용한 CNI(Calico) 및 Helm 자동 설치 확장

---

수동으로 수십 번 타이핑하던 과정을 Ansible 플레이북 하나로 통합했습니다. 이제 `hosts.ini`에 워커 노드 IP만 추가하면 10대든 100대든 한 번에 클러스터를 확장할 수 있습니다. 다음은 어떤 부분을 자동화해 드릴까요?
