이미 모든 설정이 완료된 **Golden VM 이미지**가 있다면, 이제 인프라 자동화의 핵심은 **"이미지의 복제"**와 **"개별 설정(Hostname, IP)의 주입"**입니다. 테라폼(Terraform) 없이 앤서블(Ansible)만 있는 환경이라면, 새로운 VM이 부팅된 후 앤서블이 네트워크 설정을 원격으로 수정하는 방식을 사용해야 합니다.

---

## 1. 앤서블을 이용한 VM 사후 설정 자동화 (Post-Provisioning)

Golden VM으로 생성된 새 서버들은 초기에는 원본과 동일한 호스트네임과 설정을 가지고 있습니다. 이를 각각의 환경에 맞게 자동 수정하는 플레이북입니다.

### [설계] vars_files를 활용한 설정 자동화

각 서버의 정보를 별도의 변수 파일로 관리하거나, 인벤토리에 직접 정의하여 실행합니다.

```yaml
---
- name: Golden VM 복제 후 시스템 개별화 (Ansible/Compiler 포함 환경)
  hosts: all
  become: yes
  tasks:
    # 1. 호스트네임 및 식별 정보 수정
    - name: 새로운 호스트네임 설정
      hostname:
        name: "{{ node_hostname }}"

    - name: /etc/hosts 내 루프백 주소 업데이트
      lineinfile:
        path: /etc/hosts
        regexp: '^127.0.1.1'
        line: "127.0.1.1 {{ node_hostname }}"

    # 2. 네트워크 인터페이스 초기화 및 고정 IP 주입
    - name: Netplan 고정 IP 설정 (기존 설정 덮어쓰기)
      copy:
        dest: /etc/netplan/01-netcfg.yaml
        content: |
          network:
            version: 2
            renderer: networkd
            ethernets:
              eth0:  # AWS/IDC 환경에 맞는 인터페이스 이름 확인 필요
                dhcp4: no
                addresses:
                  - "{{ static_ip }}/24"
                routes:
                  - to: default
                    via: "{{ gateway_ip }}"
                nameservers:
                  addresses: [8.8.8.8, 8.8.4.4]

    # 3. 중복 식별자 제거 (복제된 VM에서 가장 중요한 단계)
    - name: Machine-ID 초기화 (로그 및 통신 중복 방지)
      shell: |
        truncate -s 0 /etc/machine-id
        rm /var/lib/dbus/machine-id
        ln -s /etc/machine-id /var/lib/dbus/machine-id

    - name: SSH 호스트 키 재생성 (보안을 위해 복제본마다 새로 생성)
      shell: |
        rm -f /etc/ssh/ssh_host_*
        dpkg-reconfigure openssh-server

    # 4. 네트워크 설정 적용 및 재시작
    - name: 네트워크 설정 즉시 반영
      shell: netplan apply
      async: 10
      poll: 0

```

---

## 2. 인벤토리(Inventory) 관리 방식

각 VM마다 달라야 하는 값을 `hosts.ini`에 정의하여 앤서블이 이를 읽어 작업하게 합니다.

```ini
[k8s_cluster]
# [접속IP] [변경할호스트네임] [할당할고정IP]
192.168.1.100  inventory_hostname_short=k8s-master  static_ip=192.168.1.10  gateway_ip=192.168.1.1
192.168.1.101  inventory_hostname_short=k8s-worker1 static_ip=192.168.1.11  gateway_ip=192.168.1.1
192.168.1.102  inventory_hostname_short=k8s-worker2 static_ip=192.168.1.12  gateway_ip=192.168.1.1

```

---

## 3. 실무형 자동화 워크플로우 (IaC 시나리오)

1. **Golden VM 복제**: 하이퍼바이저(VMware, Proxmox 등)나 클라우드(AWS)에서 이미지를 복제하여 새 인스턴스를 생성합니다.
2. **임시 접속**: 초기에는 DHCP나 기존 Golden VM의 IP로 접속합니다.
3. **앤서블 실행**: 위 플레이북을 돌려 **Hostname**과 **Static IP**를 주입합니다.
4. **반영 완료**: 새 IP로 재접속하여 작업을 이어갑니다.

---

### 💡 실무자 팁: Cloud-Init 활용 권장

만약 VM이 부팅될 때 아예 설정을 다 끝내고 싶다면, Golden VM 안에 **Cloud-Init**을 심어두는 것이 가장 고도화된 방법입니다. VM을 생성할 때 `user-data`만 넘겨주면 부팅 시점에 이미 IP와 이름이 바뀐 상태로 올라옵니다.

---

### ⚠️ 비용 및 유료 전환 주의사항

* **AWS 스토리지**: Golden VM 이미지를 AMI로 저장할 경우, 이미지 용량만큼 **EBS Snapshot 비용**이 부과됩니다. (사용하지 않는 이미지는 주기적으로 삭제하는 것이 좋습니다.)
* **고정 IP**: AWS EC2에서 **Elastic IP(탄력적 IP)**를 사용할 경우, 인스턴스에 연결되어 있지 않거나 인스턴스가 중지된 상태에서는 **시간당 과금**이 발생하므로 주의가 필요합니다.

Next Step: Netplan 인터페이스 이름 자동 감지 및 Cloud-Init 연동 설정 방법
