네, 현재 테라폼이 없는 환경이라면 **Ansible(앤서블)**을 사용하여 1단계(OS 최적화)부터 3단계(K8s 도구 설치)까지를 하나의 **YAML 플레이북**으로 묶어 실행하는 것이 가장 완벽한 실무형 IaC 방식입니다.

강사님의 마스터 PC에서 수강생 PC(예비 서버)들을 대상으로 한 번에 설정을 밀어 넣는 시나리오로 구성해 드리겠습니다.

---

## 1. Ansible을 이용한 OS 및 K8s 환경 준비 (1~3단계 통합)

이 YAML 파일은 각 서버에 접속하여 스왑 해제, 커널 설정, 컨테이너 런타임 및 K8s 도구 설치를 자동으로 수행합니다.

### [설계] k8s_setup_playbook.yaml 생성

```yaml
- name: 이전 클러스터 정보 초기화 (강제 모드)
      shell: |
        # 1. 관련 프로세스 강제 종료 및 서비스 중지
        systemctl stop kubelet || true
        killall -9 kubelet kube-proxy 2>/dev/null || true
        
        # 2. 컨테이너 런타임 초기화 (실행 중인 컨테이너 강제 중지)
        crictl ps -q | xargs -r crictl stop || true
        
        # 3. 마운트된 볼륨 해제 (가장 빈번한 멈춤 원인)
        df | grep /var/lib/kubelet | awk '{print $6}' | xargs -r umount -l || true
        
        # 4. kubeadm reset 실행 (이미 프로세스를 죽였으므로 빠르게 통과)
        kubeadm reset -f
        
        # 5. 잔여 파일 및 네트워크 인터페이스 강제 삭제
        rm -rf /etc/cni/net.d
        rm -rf /var/lib/kubelet/*
        rm -rf /etc/kubernetes/*
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        
        # 6. iptables 완전 초기화
        iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X
      when: kube_config.stat.exists
      async: 120 # 최대 2분으로 제한 (넘어가면 에러 발생시키도록)
      poll: 5
```

---

## 2. 실행 방법

마스터 PC(또는 강사님 PC)에서 앤서블을 통해 대상 서버들에게 명령을 내립니다.

### ① 인벤토리(hosts) 파일 작성

대상 서버들의 IP를 지정합니다.

```bash
# hosts.ini 파일 생성
[k8s_nodes]
192.168.1.10  # 마스터 후보
192.168.1.11  # 워커 후보
192.168.1.12  # 워커 후보

```

### ② 플레이북 실행

```bash
# 앤서블 실행 명령어
ansible-playbook -i hosts.ini k8s_setup_playbook.yaml -u master -K

```

---

## 3. 실행 후 단계 (4단계~5단계)

위의 앤서블 작업이 끝나면 모든 서버는 `kubeadm` 명령어를 실행할 준비가 완료된 상태입니다. 이후부터는 앞서 정리한 것처럼 **마스터 노드에서만** 직접 `kubeadm init --config kubeadm-init.yaml`을 실행하시면 됩니다.

---

### 💡 실무자 팁: 왜 이렇게 하나요?

* **일관성:** 20대, 100대의 서버가 있더라도 단 한 번의 실행으로 모두 **동일한 커널 설정과 동일한 버전**을 갖게 됩니다.
* **복구력:** 새로운 서버를 추가해야 할 때, 이 플레이북에 IP만 추가하고 실행하면 즉시 클러스터 참여 준비가 끝납니다.

Next Step: Ansible로 생성된 서버들 중 한 곳에서 마스터 노드 초기화 수행하기

---

앤서블을 활용하여 쿠버네티스 외부 인프라 레이어를 YAML로 자동화하는 방법을 구성해 드렸습니다.

Next Step: 앤서블로 마스터 노드 초기화(`kubeadm init`)까지 완전히 자동화하는 방법을 알아볼까요?
