ë„¤, í˜„ì¬ í…Œë¼í¼ì´ ì—†ëŠ” í™˜ê²½ì´ë¼ë©´ **Ansible(ì•¤ì„œë¸”)**ì„ ì‚¬ìš©í•˜ì—¬ 1ë‹¨ê³„(OS ìµœì í™”)ë¶€í„° 3ë‹¨ê³„(K8s ë„êµ¬ ì„¤ì¹˜)ê¹Œì§€ë¥¼ í•˜ë‚˜ì˜ **YAML í”Œë ˆì´ë¶**ìœ¼ë¡œ ë¬¶ì–´ ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì™„ë²½í•œ ì‹¤ë¬´í˜• IaC ë°©ì‹ì…ë‹ˆë‹¤.

ê°•ì‚¬ë‹˜ì˜ ë§ˆìŠ¤í„° PCì—ì„œ ìˆ˜ê°•ìƒ PC(ì˜ˆë¹„ ì„œë²„)ë“¤ì„ ëŒ€ìƒìœ¼ë¡œ í•œ ë²ˆì— ì„¤ì •ì„ ë°€ì–´ ë„£ëŠ” ì‹œë‚˜ë¦¬ì˜¤ë¡œ êµ¬ì„±í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

## 1. Ansibleì„ ì´ìš©í•œ OS ë° K8s í™˜ê²½ ì¤€ë¹„ (1~3ë‹¨ê³„ í†µí•©)

ì´ YAML íŒŒì¼ì€ ê° ì„œë²„ì— ì ‘ì†í•˜ì—¬ ìŠ¤ì™‘ í•´ì œ, ì»¤ë„ ì„¤ì •, ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ë° K8s ë„êµ¬ ì„¤ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### [ì„¤ê³„] k8s_setup_playbook.yaml ìƒì„±

```yaml
---
- name: Kubernetes OS ë° í™˜ê²½ ìµœì í™” (1~3ë‹¨ê³„)
  hosts: all
  become: yes
  tasks:
    # 1ë‹¨ê³„: OS ì„¤ì •
    - name: ì €ì¥ì†Œ í†µì‹ ì„ ìœ„í•œ í•„ìˆ˜ ë„êµ¬ í™•ì¸
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes

    - name: ìŠ¤ì™‘(Swap) ë©”ëª¨ë¦¬ ë¹„í™œì„±í™”
      shell: |
        swapoff -a
        sed -i '/swap/s/^/#/' /etc/fstab

    - name: ì»¤ë„ ëª¨ë“ˆ ë¡œë“œ ì„¤ì •
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: ì»¤ë„ ëª¨ë“ˆ ì¦‰ì‹œ ë¡œë“œ
      modprobe:
        name: "{{ item }}"
        state: present
      loop:
        - overlay
        - br_netfilter

    - name: ì»¤ë„ íŒŒë¼ë¯¸í„°(sysctl) ì„¤ì •
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/k8s.conf
      loop:
        - { name: 'net.bridge.bridge-nf-call-iptables', value: '1' }
        - { name: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
        - { name: 'net.ipv4.ip_forward', value: '1' }

    # 2ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„(Containerd) ì„¤ì¹˜
    - name: Containerd ì„¤ì¹˜ ë° ì„¤ì •
      apt:
        name: containerd
        state: present
        update_cache: yes

    - name: Containerd ê¸°ë³¸ ì„¤ì • ìƒì„± ë° SystemdCgroup í™œì„±í™”
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
      notify: restart containerd

    - name: í‚¤ë§ ì €ì¥ìš© ë””ë ‰í† ë¦¬ ìƒì„± 
      file: 
        path: /etc/apt/keyrings 
        state: directory 
        mode: '0755'
    - name: ê¸°ì¡´ì— ì˜ëª»ëœ K8s ê´€ë ¨ ì„¤ì • ë° ìºì‹œ ê°•ì œ ì‚­ì œ (ì²­ì†Œ)
      shell: |
        rm -f /etc/apt/sources.list.d/kubernetes.list
        rm -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        rm -f /etc/apt/keyrings/kubernetes-apt-keyring.asc
        apt-get clean
        rm -rf /var/lib/apt/lists/*
      #args:
        #warn: false

    - name: K8s ê³µì‹ GPG í‚¤ ë‹¤ìš´ë¡œë“œ ë° ë³€í™˜
      shell: |
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: K8s ê³µì‹ ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ (signed-by ì ìš©)
      apt_repository: 
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /" 
        filename: kubernetes 
        state: present 
        update_cache: yes

    # 3ë‹¨ê³„: K8s ë„êµ¬(v1.30) ì„¤ì¹˜
    - name: K8s v1.30 ë„êµ¬ ì„¤ì¹˜
      apt:
        name:
          - kubelet=1.30.*
          - kubeadm=1.30.*
          - kubectl=1.30.*
        state: present
        update_cache: yes

    - name: ë²„ì „ ì—…ë°ì´íŠ¸ ê³ ì •
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: [kubelet, kubeadm, kubectl]

# 4ë‹¨ê³„: í´ëŸ¬ìŠ¤í„° ì œì–´ ê¶Œí•œ ì„¤ì • (ë§ˆìŠ¤í„° ë…¸ë“œ ì „ìš©)
    - name: kubeconfig ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0755'

    - name: admin.conf íŒŒì¼ì„ ì‚¬ìš©ì kubeconfigë¡œ ë³µì‚¬
      copy:
        src: /etc/kubernetes/admin.conf
        dest: "{{ ansible_env.HOME }}/.kube/config"
        remote_src: yes
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_id }}"
        mode: '0600'
      ignore_errors: yes  # ì›Œì»¤ ë…¸ë“œì—ì„œëŠ” admin.confê°€ ì—†ìœ¼ë¯€ë¡œ ì—ëŸ¬ ë¬´ì‹œ ì„¤ì •

  handlers:
    - name: restart containerd
      service:
        name: containerd
        state: restarted
```

---

## 2. ì‹¤í–‰ ë°©ë²•

ë§ˆìŠ¤í„° PC(ë˜ëŠ” ê°•ì‚¬ë‹˜ PC)ì—ì„œ ì•¤ì„œë¸”ì„ í†µí•´ ëŒ€ìƒ ì„œë²„ë“¤ì—ê²Œ ëª…ë ¹ì„ ë‚´ë¦½ë‹ˆë‹¤.

### â‘  ì¸ë²¤í† ë¦¬(hosts) íŒŒì¼ ì‘ì„±

ëŒ€ìƒ ì„œë²„ë“¤ì˜ IPë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
# hosts.ini íŒŒì¼ ìƒì„±
[k8s_nodes]
192.168.1.10  # ë§ˆìŠ¤í„° í›„ë³´
192.168.1.11  # ì›Œì»¤ í›„ë³´
192.168.1.12  # ì›Œì»¤ í›„ë³´

```

### â‘¡ í”Œë ˆì´ë¶ ì‹¤í–‰

```bash
# ì•¤ì„œë¸” ì‹¤í–‰ ëª…ë ¹ì–´
ansible-playbook -i hosts.ini k8s_setup_playbook.yaml -u master -K

```

---

## 3. ì‹¤í–‰ í›„ ë‹¨ê³„ (4ë‹¨ê³„~5ë‹¨ê³„)

ìœ„ì˜ ì•¤ì„œë¸” ì‘ì—…ì´ ëë‚˜ë©´ ëª¨ë“  ì„œë²„ëŠ” `kubeadm` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ì¤€ë¹„ê°€ ì™„ë£Œëœ ìƒíƒœì…ë‹ˆë‹¤. ì´í›„ë¶€í„°ëŠ” ì•ì„œ ì •ë¦¬í•œ ê²ƒì²˜ëŸ¼ **ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ** ì§ì ‘ `kubeadm init --config kubeadm-init.yaml`ì„ ì‹¤í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

---

### ğŸ’¡ ì‹¤ë¬´ì íŒ: ì™œ ì´ë ‡ê²Œ í•˜ë‚˜ìš”?

* **ì¼ê´€ì„±:** 20ëŒ€, 100ëŒ€ì˜ ì„œë²„ê°€ ìˆë”ë¼ë„ ë‹¨ í•œ ë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë‘ **ë™ì¼í•œ ì»¤ë„ ì„¤ì •ê³¼ ë™ì¼í•œ ë²„ì „**ì„ ê°–ê²Œ ë©ë‹ˆë‹¤.
* **ë³µêµ¬ë ¥:** ìƒˆë¡œìš´ ì„œë²„ë¥¼ ì¶”ê°€í•´ì•¼ í•  ë•Œ, ì´ í”Œë ˆì´ë¶ì— IPë§Œ ì¶”ê°€í•˜ê³  ì‹¤í–‰í•˜ë©´ ì¦‰ì‹œ í´ëŸ¬ìŠ¤í„° ì°¸ì—¬ ì¤€ë¹„ê°€ ëë‚©ë‹ˆë‹¤.

Next Step: Ansibleë¡œ ìƒì„±ëœ ì„œë²„ë“¤ ì¤‘ í•œ ê³³ì—ì„œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™” ìˆ˜í–‰í•˜ê¸°

---

ì•¤ì„œë¸”ì„ í™œìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ ì™¸ë¶€ ì¸í”„ë¼ ë ˆì´ì–´ë¥¼ YAMLë¡œ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ êµ¬ì„±í•´ ë“œë ¸ìŠµë‹ˆë‹¤.

Next Step: ì•¤ì„œë¸”ë¡œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”(`kubeadm init`)ê¹Œì§€ ì™„ì „íˆ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¼ê¹Œìš”?
