---
```
- name: Kubernetes v1.30 환경 최적화 및 설치 (최종본)
  hosts: all
  become: yes
  vars:
    internal_network: "192.168.100.0/24"  # 실습 환경 대역에 맞춰 수정

  tasks:
    # [방화벽] 노드 간 통신을 위해 특정 대역 및 포트 허용
    - name: 방화벽 설정 - 내부 대역 및 필수 포트 개방
      ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        from_ip: "{{ item.from | default(omit) }}"
        proto: tcp
      loop:
        - { from: "{{ internal_network }}" }      # 내부 노드 간 전 포트 신뢰
        - { port: '22' }                          # SSH 관리용
        - { port: '6443' }                        # API Server 전용
        - { port: '10250' }                       # Kubelet API
        - { port: '30000:32767' }                 # 외부 서비스 노출용 NodePort 대역

    - name: 방화벽 활성화
      ufw:
        state: enabled
        policy: deny

    # [OS 최적화] K8s 구동을 위한 커널 및 메모리 설정
    - name: 필수 도구 및 스왑 비활성화
      apt:
        name: [ca-certificates, curl, gnupg, ufw]
        update_cache: yes
    
    - name: Swap 메모리 비활성화 (K8s 성능 및 안정성 필수 요구사항)
      shell: |
        swapoff -a
        sed -i '/swap/s/^/#/' /etc/fstab

    - name: 커널 모듈 로드 설정 (overlay, br_netfilter)
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: 커널 모듈 즉시 로드
      shell: |
        modprobe overlay
        modprobe br_netfilter

    # [핵심] 네트워크 파라미터 설정 (L3 포워딩 및 브릿지 필터링 활성화)
    - name: sysctl 네트워크 파라미터 설정 파일 생성
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - name: sysctl 설정 즉시 적용
      command: sysctl --system

    # [런타임] Containerd 설치 및 Cgroup 드라이버 설정
    - name: Containerd 설치 및 설정 (SystemdCgroup 활성화 핵심)
      shell: |
        apt-get install -y containerd
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        # Kubelet의 Cgroup 관리 방식과 일치시키기 위해 true로 변경
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
      notify: restart containerd

    # [K8s 패키지] 저장소 및 키 전면 삭제 후 새로 생성 (강제 정화 버전)
    - name: APT 시스템 잠금 해제 및 기존 설정 강제 제거
      shell: |
        # 1. 실행 중인 자동 업데이트 프로세스 강제 종료
        systemctl stop unattended-upgrades || true
        killall -9 apt-get apt dpkg 2>/dev/null || true
        
        # 2. APT 락 파일 물리적 제거
        rm -f /var/lib/apt/lists/lock /var/cache/apt/archives/lock /var/lib/dpkg/lock*
        
        # 3. 꼬인 리포지토리 및 키링 파일 삭제
        rm -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        rm -f /etc/apt/sources.list.d/kubernetes.list
        
        # 4. APT 캐시 초기화
        apt-get clean
        rm -rf /var/lib/apt/lists/*
        dpkg --configure -a
      ignore_errors: yes

    - name: 키링 디렉토리 생성
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: K8s v1.30 GPG 키 다운로드 및 변환
      shell: |
        # 1. 키를 받기 전 패키지 목록 최신화 및 필수 도구(curl) 확인
        apt-get update -o Acquire::ForceIPv4=true
        apt-get install -y curl gnupg
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: K8s 소스 리스트 추가
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /"
        filename: kubernetes

    - name: K8s 도구 설치 및 버전 업데이트 고정
      apt:
        name: ["kubelet=1.30.*", "kubeadm=1.30.*", "kubectl=1.30.*"]
      
    - name: 패키지 홀드 설정
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: [kubelet, kubeadm, kubectl]

    # [권한 설정] 마스터 노드 관리자 설정
    - name: kubeconfig 디렉토리 생성 및 권한 설정
      file:
        path: "{{ ansible_facts['env']['HOME'] }}/.kube"
        state: directory
        mode: '0755'

  handlers:
    - name: restart containerd
      service:
        name: containerd
        state: restarted
```
