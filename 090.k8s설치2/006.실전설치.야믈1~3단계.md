
---

## 1. Ansibleì„ ì´ìš©í•œ OS ë° K8s í™˜ê²½ ì¤€ë¹„ (1~3ë‹¨ê³„ í†µí•©)

ì´ YAML íŒŒì¼ì€ ê° ì„œë²„ì— ì ‘ì†í•˜ì—¬ ìŠ¤ì™‘ í•´ì œ, ì»¤ë„ ì„¤ì •, ì»¨í…Œì´ë„ˆ ëŸ°íƒ€ì„ ë° K8s ë„êµ¬ ì„¤ì¹˜ë¥¼ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
1. í´ëŸ¬ìŠ¤í„° ê°•ì œ ì´ˆê¸°í™” ì „ìš© íŒŒì¼
k8s_reset.yaml
ì´ë¯¸ í´ëŸ¬ìŠ¤í„°ê°€ êµ¬ì¶•ëœ ìƒíƒœì—ì„œ í™˜ê²½ì„ ì™„ì „íˆ ë°€ê³  ë‹¤ì‹œ ì‹œì‘í•˜ê³  ì‹¶ì„ ë•Œ ì‹¤í–‰í•©ë‹ˆë‹¤.

### k8s_reset.yaml

```YAML
---
- name: Kubernetes í´ëŸ¬ìŠ¤í„° í™˜ê²½ ê°•ì œ ì´ˆê¸°í™”
  hosts: all
  become: yes
  tasks:
    - name: kubeconfig ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      stat:
        path: /etc/kubernetes/admin.conf
      register: kube_config

    - name: í´ëŸ¬ìŠ¤í„° ì •ë³´ ê°•ì œ ì‚­ì œ (ë©ˆì¶¤ ë°©ì§€ ë¡œì§ ì ìš©)
      shell: |
        # 1. ì„œë¹„ìŠ¤ ì¤‘ì§€ ë° ê´€ë ¨ í”„ë¡œì„¸ìŠ¤ ê°•ì œ ì¢…ë£Œ
        systemctl stop kubelet || true
        killall -9 kubelet kube-proxy 2>/dev/null || true
        
        # 2. ëŸ°íƒ€ì„ ë‚´ ì‹¤í–‰ ì¤‘ì¸ ëª¨ë“  ì»¨í…Œì´ë„ˆ ì¤‘ì§€
        crictl ps -q | xargs -r crictl stop || true
        
        # 3. ë§ˆìš´íŠ¸ëœ ë³¼ë¥¨ í•´ì œ (Lazy unmountë¡œ í”„ë¡œì„¸ìŠ¤ ì ìœ  ë¬´ê´€í•˜ê²Œ í•´ì œ)
        df | grep /var/lib/kubelet | awk '{print $6}' | xargs -r umount -l || true
        
        # 4. kubeadm ì´ˆê¸°í™” ì‹¤í–‰
        kubeadm reset -f
        
        # 5. CNI ì„¤ì • ë° ì”ì—¬ ë°ì´í„° ì™„ì „ ì‚­ì œ
        rm -rf /etc/cni/net.d /var/lib/kubelet/* /etc/kubernetes/*
        ip link delete cni0 || true
        ip link delete flannel.1 || true
        
        # 6. iptables ê·œì¹™ ì´ˆê¸°í™” (ë„¤íŠ¸ì›Œí¬ ê¼¬ì„ ë°©ì§€ í•µì‹¬)
        iptables -F && iptables -t nat -F && iptables -X
      when: kube_config.stat.exists
      async: 120  # ëŒ€ê·œëª¨ ë³¼ë¥¨ í•´ì œ ì‹œ ë©ˆì¶¤ ë°©ì§€ë¥¼ ìœ„í•´ ë¹„ë™ê¸° ì²˜ë¦¬
      poll: 5
```


### [ì„¤ê³„] k8s_setup_playbook.yaml ìƒì„±

```yaml
---
- name: Kubernetes v1.30 í™˜ê²½ ìµœì í™” ë° ì„¤ì¹˜ (ìµœì¢…ë³¸)
  hosts: all
  become: yes
  vars:
    internal_network: "192.168.100.0/24"  # ì‹¤ìŠµ í™˜ê²½ ëŒ€ì—­ì— ë§ì¶° ìˆ˜ì •

  tasks:
    # [ë°©í™”ë²½] ë…¸ë“œ ê°„ í†µì‹ ì„ ìœ„í•´ íŠ¹ì • ëŒ€ì—­ ë° í¬íŠ¸ í—ˆìš©
    - name: ë°©í™”ë²½ ì„¤ì • - ë‚´ë¶€ ëŒ€ì—­ ë° í•„ìˆ˜ í¬íŠ¸ ê°œë°©
      ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        from_ip: "{{ item.from | default(omit) }}"
        proto: tcp
      loop:
        - { from: "{{ internal_network }}" }      # ë‚´ë¶€ ë…¸ë“œ ê°„ ì „ í¬íŠ¸ ì‹ ë¢°
        - { port: '22' }                          # SSH ê´€ë¦¬ìš©
        - { port: '6443' }                        # API Server ì „ìš©
        - { port: '10250' }                       # Kubelet API
        - { port: '30000:32767' }                 # ì™¸ë¶€ ì„œë¹„ìŠ¤ ë…¸ì¶œìš© NodePort ëŒ€ì—­

    - name: ë°©í™”ë²½ í™œì„±í™”
      ufw:
        state: enabled
        policy: deny

    # [OS ìµœì í™”] K8s êµ¬ë™ì„ ìœ„í•œ ì»¤ë„ ë° ë©”ëª¨ë¦¬ ì„¤ì •
    - name: í•„ìˆ˜ ë„êµ¬ ë° ìŠ¤ì™‘ ë¹„í™œì„±í™”
      apt:
        name: [ca-certificates, curl, gnupg, ufw]
        update_cache: yes
    
    - name: Swap ë©”ëª¨ë¦¬ ë¹„í™œì„±í™” (K8s ì„±ëŠ¥ ë° ì•ˆì •ì„± í•„ìˆ˜ ìš”êµ¬ì‚¬í•­)
      shell: |
        swapoff -a
        sed -i '/swap/s/^/#/' /etc/fstab

    - name: ì»¤ë„ ëª¨ë“ˆ ë° íŒŒë¼ë¯¸í„° ì ìš© (L2 ë¸Œë¦¬ì§€ íŠ¸ë˜í”½ ê°€ì‹œì„± í™•ë³´)
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: "overlay\nbr_netfilter"
    
    - name: ëª¨ë“ˆ ì¦‰ì‹œ ë¡œë“œ ë° sysctl ì„¤ì •
      shell: |
        modprobe overlay && modprobe br_netfilter
        sysctl --system

    # [ëŸ°íƒ€ì„] Containerd ì„¤ì¹˜ ë° Cgroup ë“œë¼ì´ë²„ ì„¤ì •
    - name: Containerd ì„¤ì¹˜ ë° ì„¤ì • (SystemdCgroup í™œì„±í™” í•µì‹¬)
      shell: |
        apt-get install -y containerd
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
        # Kubeletì˜ Cgroup ê´€ë¦¬ ë°©ì‹ê³¼ ì¼ì¹˜ì‹œí‚¤ê¸° ìœ„í•´ trueë¡œ ë³€ê²½
        sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
      notify: restart containerd

    # [K8s íŒ¨í‚¤ì§€] ì €ì¥ì†Œ ì •ë¹„ ë° v1.30 ì„¤ì¹˜
    - name: GPG í‚¤ ë° ì €ì¥ì†Œ ì²­ì†Œ (ê¸°ì¡´ ì¸ì¦ ì—ëŸ¬ ë°©ì§€ìš©)
      shell: |
        rm -f /etc/apt/keyrings/kubernetes-apt-keyring.gpg
        rm -f /etc/apt/sources.list.d/kubernetes.list
        apt-get clean && rm -rf /var/lib/apt/lists/*

    - name: K8s v1.30 GPG í‚¤ ë‹¤ìš´ë¡œë“œ ë° ë³€í™˜
      shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: ìì£¼ ëŠê¸°ëŠ” ì§€ì  K8s ì†ŒìŠ¤ ë¦¬ìŠ¤íŠ¸ ì¶”ê°€ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜  
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /"
        filename: kubernetes

    - name: K8s ë„êµ¬ ì„¤ì¹˜ ë° ë²„ì „ ì—…ë°ì´íŠ¸ ê³ ì • (ìš´ì˜ ì¤‘ ë²„ì „ ê¼¬ì„ ë°©ì§€)
      apt:
        name: ["kubelet=1.30.*", "kubeadm=1.30.*", "kubectl=1.30.*"]
      
    - name: íŒ¨í‚¤ì§€ í™€ë“œ ì„¤ì •
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: [kubelet, kubeadm, kubectl]

    # [ê¶Œí•œ ì„¤ì •] ë§ˆìŠ¤í„° ë…¸ë“œ ê´€ë¦¬ì ì„¤ì •
    - name: kubeconfig ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
      file:
        path: "{{ ansible_facts['env']['HOME'] }}/.kube"
        state: directory
        mode: '0755'



  handlers:
    - name: restart containerd
      service:
        name: containerd
        state: restarted
```

---

## 2. ì‹¤í–‰ ë°©ë²•

ë§ˆìŠ¤í„° PC(ë˜ëŠ” ê°•ì‚¬ë‹˜ PC)ì—ì„œ ì•¤ì„œë¸”ì„ í†µí•´ ëŒ€ìƒ ì„œë²„ë“¤ì—ê²Œ ëª…ë ¹ì„ ë‚´ë¦½ë‹ˆë‹¤.

### â‘  ì¸ë²¤í† ë¦¬(hosts) íŒŒì¼ ì‘ì„±

ëŒ€ìƒ ì„œë²„ë“¤ì˜ IPë¥¼ ì§€ì •í•©ë‹ˆë‹¤.

```bash
# hosts.ini íŒŒì¼ ìƒì„±
[k8s_nodes]
192.168.1.10  # ë§ˆìŠ¤í„° í›„ë³´
192.168.1.11  # ì›Œì»¤ í›„ë³´
192.168.1.12  # ì›Œì»¤ í›„ë³´

```

### â‘¡ í”Œë ˆì´ë¶ ì‹¤í–‰

```bash
# ì•¤ì„œë¸” ì‹¤í–‰ ëª…ë ¹ì–´
ansible-playbook -i hosts.ini k8s_setup_playbook.yaml -u master -K

```

---

## 3. ì‹¤í–‰ í›„ ë‹¨ê³„ (4ë‹¨ê³„~5ë‹¨ê³„)

ìœ„ì˜ ì•¤ì„œë¸” ì‘ì—…ì´ ëë‚˜ë©´ ëª¨ë“  ì„œë²„ëŠ” `kubeadm` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•  ì¤€ë¹„ê°€ ì™„ë£Œëœ ìƒíƒœì…ë‹ˆë‹¤. ì´í›„ë¶€í„°ëŠ” ì•ì„œ ì •ë¦¬í•œ ê²ƒì²˜ëŸ¼ **ë§ˆìŠ¤í„° ë…¸ë“œì—ì„œë§Œ** ì§ì ‘ `kubeadm init --config kubeadm-init.yaml`ì„ ì‹¤í–‰í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

---

### ğŸ’¡ ì‹¤ë¬´ì íŒ: ì™œ ì´ë ‡ê²Œ í•˜ë‚˜ìš”?

* **ì¼ê´€ì„±:** 20ëŒ€, 100ëŒ€ì˜ ì„œë²„ê°€ ìˆë”ë¼ë„ ë‹¨ í•œ ë²ˆì˜ ì‹¤í–‰ìœ¼ë¡œ ëª¨ë‘ **ë™ì¼í•œ ì»¤ë„ ì„¤ì •ê³¼ ë™ì¼í•œ ë²„ì „**ì„ ê°–ê²Œ ë©ë‹ˆë‹¤.
* **ë³µêµ¬ë ¥:** ìƒˆë¡œìš´ ì„œë²„ë¥¼ ì¶”ê°€í•´ì•¼ í•  ë•Œ, ì´ í”Œë ˆì´ë¶ì— IPë§Œ ì¶”ê°€í•˜ê³  ì‹¤í–‰í•˜ë©´ ì¦‰ì‹œ í´ëŸ¬ìŠ¤í„° ì°¸ì—¬ ì¤€ë¹„ê°€ ëë‚©ë‹ˆë‹¤.

Next Step: Ansibleë¡œ ìƒì„±ëœ ì„œë²„ë“¤ ì¤‘ í•œ ê³³ì—ì„œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™” ìˆ˜í–‰í•˜ê¸°

---

ì•¤ì„œë¸”ì„ í™œìš©í•˜ì—¬ ì¿ ë²„ë„¤í‹°ìŠ¤ ì™¸ë¶€ ì¸í”„ë¼ ë ˆì´ì–´ë¥¼ YAMLë¡œ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ êµ¬ì„±í•´ ë“œë ¸ìŠµë‹ˆë‹¤.

Next Step: ì•¤ì„œë¸”ë¡œ ë§ˆìŠ¤í„° ë…¸ë“œ ì´ˆê¸°í™”(`kubeadm init`)ê¹Œì§€ ì™„ì „íˆ ìë™í™”í•˜ëŠ” ë°©ë²•ì„ ì•Œì•„ë³¼ê¹Œìš”?
