# 프로젝트: Kubernetes v1.30 자동화 설치 및 재설치 가이드

이 프로젝트는 **앤서블(Ansible)**을 활용하여 여러 대의 **예비서버(pc)**에 Kubernetes v1.30 환경을 자동으로 구축하고, 설치 실패 시에도 안전하게 재시행할 수 있는 멱등성(Idempotency) 확보에 초점을 맞춥니다.

---

### 1. 인프라 구성 정의

| 역할 | 명칭 | 주요 임무 |
| --- | --- | --- |
| **컨트롤 노드** | **마스터 PC** | 앤서블 플레이북 실행 및 클러스터 배포 관리 |
| **타겟 노드** | **예비서버(pc)** | Kubernetes 컴포넌트(Kubeadm, Kubelet 등) 설치 대상 |

> **AWS 과금 주의**: EC2 인스턴스를 사용하여 실습할 경우, 인스턴스 유형(t3.medium 이상 권장) 및 사용 시간에 따라 비용이 발생합니다. 실습 종료 후 반드시 인스턴스를 '중지'하거나 '종료'하세요.

---

### 2. [핵심] Ansible Playbook: k8s_setup.yml

기존 코드에서 실패 시 재실행 안정성을 강화한 최종본입니다.

```yaml
- name: Kubernetes v1.30 환경 최적화 및 설치 (멱등성 강화 버전)
  hosts: all
  become: yes
  vars:
    internal_network: "192.168.100.0/24"

  tasks:
    # [1] 시스템 잠금 및 꼬인 패키지 복구 (재설치 시 핵심)
    - name: APT 시스템 상태 정상화
      shell: |
        systemctl stop unattended-upgrades || true
        killall -9 apt-get apt dpkg 2>/dev/null || true
        dpkg --configure -a
        apt-get clean
      ignore_errors: yes

    # [2] 네트워크 및 커널 최적화
    - name: Swap 메모리 비활성화
      shell: |
        swapoff -a
        sed -i '/swap/s/^/#/' /etc/fstab

    - name: 커널 모듈 로드 설정
      copy:
        dest: /etc/modules-load.d/k8s.conf
        content: |
          overlay
          br_netfilter

    - name: 커널 모듈 즉시 로드
      command: modprobe {{ item }}
      loop: [overlay, br_netfilter]

    - name: sysctl 네트워크 파라미터 설정
      copy:
        dest: /etc/sysctl.d/k8s.conf
        content: |
          net.bridge.bridge-nf-call-iptables  = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward                 = 1

    - name: sysctl 설정 즉시 적용
      command: sysctl --system

    # [3] 런타임(Containerd) 설치 및 멱등성 기반 설정
    - name: Containerd 설치
      apt:
        name: containerd
        state: present
        update_cache: yes

    - name: Containerd 기본 설정 파일 생성 (존재하지 않을 때만)
      shell: |
        mkdir -p /etc/containerd
        containerd config default > /etc/containerd/config.toml
      args:
        creates: /etc/containerd/config.toml

    - name: Containerd Cgroup 드라이버를 systemd로 설정
      replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'
      notify: restart containerd

    # [4] Kubernetes v1.30 패키지 설정
    - name: GPG 키 및 저장소 설정 (중복 방지)
      shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
      args:
        creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg

    - name: K8s 소스 리스트 추가
      apt_repository:
        repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.30/deb/ /"
        filename: kubernetes
        update_cache: yes

    - name: K8s 도구(1.30.x) 설치 및 버전 고정
      apt:
        name: ["kubelet=1.30.*", "kubeadm=1.30.*", "kubectl=1.30.*"]
        state: present
        force: yes

    - name: 패키지 업데이트 고정 (Hold)
      dpkg_selections:
        name: "{{ item }}"
        selection: hold
      loop: [kubelet, kubeadm, kubectl]

    # [5] 방화벽 설정
    - name: UFW 규칙 적용 (내부 네트워크 및 필수 포트)
      ufw:
        rule: allow
        port: "{{ item.port | default(omit) }}"
        from_ip: "{{ item.from | default(omit) }}"
        proto: tcp
      loop:
        - { from: "{{ internal_network }}" }
        - { port: '22' }
        - { port: '6443' }
        - { port: '10250' }
        - { port: '30000:32767' }

    - name: UFW 활성화 및 기본 차단 설정
      ufw:
        state: enabled
        policy: deny

  handlers:
    - name: restart containerd
      service:
        name: containerd
        state: restarted

```

---

### 3. 프로젝트 실행 및 재시행 가이드

#### 1) 초기 실행 방법

**마스터 PC**에서 인벤토리 파일을 지정하여 실행합니다.

```bash
ansible-playbook -i hosts.ini k8s_setup.yml -K

```

#### 2) 설치 실패 후 재실행 시나리오

작업 도중 네트워크 끊김이나 패키지 락으로 실패했을 경우, 수동 조치 없이 **동일한 명령어를 다시 실행**하면 됩니다.

* **설정 파일**: `creates` 옵션에 의해 기존 설정이 존재하면 덮어쓰지 않고 건너뜁니다.
* **패키지**: 이미 설치된 경우 `present` 상태를 확인하고 다음 단계로 넘어갑니다.
* **방화벽**: 중복된 규칙은 무시하고 최종 상태(Enabled)만 유지합니다.

---

### 4. 트러블슈팅 및 실전 팁

* **Containerd 설정 꼬임**: 만약 `config.toml` 설정이 잘못되었다면, 해당 파일을 삭제(`rm`)하고 플레이북을 재실행하면 깨끗한 기본값으로 다시 생성됩니다.
* **GPG 키 오류**: 키 다운로드 도중 실패하여 파일이 깨졌다면 `/etc/apt/keyrings/` 내의 `.gpg` 파일을 삭제 후 재시행하세요.
* **APT 락 지속**: `dpkg --configure -a`가 포함되어 있어 대부분의 잠금 문제는 자동 해결되지만, 지속될 경우 리부팅 후 재실행이 가장 확실합니다.

---

Next Step: kubeadm init을 이용한 클러스터 초기화 및 CNI 연동

---

요청하신 대로 재실행 시 안정성을 극대화한 플레이북과 교재 형식을 구성했습니다. 앤서블의 `replace`와 `creates` 옵션을 활용하여 강사님의 **마스터 PC**에서 언제든 **예비서버**들을 일관된 상태로 만들 수 있습니다.

Next Step: Kubernetes Pod Network(Calico/Flannel) 설치 및 상태 확인
