쿠버네티스 클러스터를 제거하는 과정은 단순한 패키지 삭제를 넘어, 커널에 적용된 네트워크 규칙과 파일 시스템에 분산된 설정들을 완벽히 정리하는 과정입니다. 이 가이드는 재설치 시 발생할 수 있는 충돌을 원천 차단하고, 시스템 네트워크의 안정성을 유지하며 초기 상태로 되돌리는 표준 절차를 다룹니다.

---

## 쿠버네티스 안전 제거 및 초기화 가이드

### 1. 클러스터 초기화 및 런타임 정리

가장 먼저 `kubeadm`을 통해 노드의 상태를 초기화하고 실행 중인 컨테이너들을 정리합니다.

```bash
# 1.1 클러스터 설정 초기화
# 이 명령은 로컬의 kubelet 설정과 인증서 등을 초기화합니다.
sudo kubeadm reset -f

# 1.2 컨테이너 런타임 프로세스 중지 및 삭제
# containerd를 사용하는 경우 남아있는 컨테이너와 샌드박스를 모두 제거합니다.
sudo crictl ps -a -q | xargs -r sudo crictl stop
sudo crictl ps -a -q | xargs -r sudo crictl rm

```

### 2. 네트워크 정책 안전 확보 (가장 중요)

네트워크 규칙을 초기화할 때 외부 접속(SSH 등)이 끊기지 않도록 기본 정책(Policy)을 먼저 확인하고 수정해야 합니다.

```bash
# 2.1 iptables 기본 정책을 ACCEPT로 변경
# INPUT 체인이 DROP으로 되어 있을 경우 규칙 초기화 시 접속이 차단되므로 반드시 수행합니다.
sudo iptables -P INPUT ACCEPT
sudo iptables -P FORWARD ACCEPT
sudo iptables -P OUTPUT ACCEPT

# 2.2 모든 iptables 규칙 초기화
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

```

### 3. 쿠버네티스 패키지 및 서비스 완전 삭제

시스템 바이너리와 자동 실행 설정들을 제거합니다.

```bash
# 3.1 관련 패키지 삭제
sudo apt-get purge -y kubeadm kubectl kubelet kubernetes-cni 'kube*' 

# 3.2 불필요한 의존성 패키지 정리
sudo apt-get autoremove -y

```

### 4. 잔류 데이터 및 디렉토리 강제 삭제

디렉토리가 남아있으면 재설치 시 이전 인증서나 데이터가 동기화되어 에러를 유발합니다.

```bash
# 4.1 설정 및 데이터 디렉토리 제거
sudo rm -rf ~/.kube
sudo rm -rf /etc/kubernetes/
sudo rm -rf /var/lib/kubelet/
sudo rm -rf /var/lib/etcd/
sudo rm -rf /etc/cni/
sudo rm -rf /opt/cni/bin
sudo rm -rf /var/lib/cni/
sudo rm -rf /var/run/calico

```

### 5. 가상 네트워크 인터페이스 정리

CNI(Calico, Flannel 등)가 생성한 가상 브리지와 가상 인터페이스를 제거하여 커널 네트워크 스택을 정화합니다.

```bash
# 5.1 CNI 인터페이스 삭제
# 호스트의 물리 NIC(eth0 등)는 건드리지 않고 가상 인터페이스만 삭제합니다.
sudo ip link delete cni0
sudo ip link delete flannel.1
sudo ip link show | grep cali | awk '{print $2}' | cut -d'@' -f1 | xargs -r -I {} sudo ip link delete {}

# 5.2 라우팅 테이블 및 ARP 캐시 정리
sudo ip route flush proto bird
sudo ip neigh flush all

```

---

### 실전 점검 및 시스템 복구

* **마운트 잔류 확인:** `/var/lib/kubelet/pods/` 하위에 파일 시스템이 마운트되어 삭제되지 않는 경우가 있습니다. `mount | grep kubelet`으로 확인 후 `umount`를 선행하세요.
* **시스템 재부팅 권장:** 위 과정을 마친 후 `sudo reboot`을 통해 커널 메모리에 남은 브리지 정보와 가상 경로를 완전히 초기화하는 것을 권장합니다.
* **환경 변수 확인:** `.bashrc` 또는 `.zshrc`에 등록된 쿠버네티스 관련 별칭(alias)이나 환경 변수(`KUBECONFIG` 등)가 있다면 함께 정리하세요.

---

> [!NOTE]
> **과금 및 유료 서비스 안내**
> * **AWS EC2:** 인스턴스 내부 설정 초기화는 추가 비용이 발생하지 않으나, 인스턴스가 켜져 있는 동안의 시간당 비용은 계속 청구됩니다.
> * **AWS EBS:** `/var/lib/etcd` 등에 마운트된 별도의 EBS 볼륨이 있다면, 클러스터를 삭제하더라도 볼륨을 직접 삭제하지 않으면 보관 비용이 발생합니다.
> * **NAT Gateway:** 네트워크 초기화 후 시스템 업데이트나 패키지 재설치를 위해 외부와 통신할 경우 NAT Gateway 트래픽 과금이 발생할 수 있으니 유의하십시오.
> 
> 

Next Step: **Kubernetes Installation (kubeadm)**

---

마스터 노드와 워커 노드의 초기화 과정은 **90% 이상 동일**합니다. 다만, 마스터 노드는 클러스터 전체의 상태 정보(etcd)와 제어 평면 설정을 포함하고 있고, 워커 노드는 주로 포드(Pod) 실행 환경과 네트워크 구성에 집중되어 있다는 차이가 있습니다.

교재의 구성을 위해 마스터와 워커 노드 구분 없이 통합하여 실행할 수 있는 **완전 초기화 프로세스**로 정리합니다.

---

## 노드 유형별 초기화 정밀 체크리스트

### 1. 통합 초기화 명령 (공통)

마스터와 워커 구분 없이 모든 노드에서 아래 과정을 순차적으로 실행합니다. 워커 노드에서는 etcd 데이터가 없으므로 해당 디렉토리 삭제 시 무시하고 진행됩니다.

```bash
# 1.1 노드 설정 초기화
# 워커 노드에서는 마스터와의 연결 정보를, 마스터에서는 클러스터 구성을 초기화합니다.
sudo kubeadm reset -f

# 1.2 런타임 및 프로세스 정리 (공통)
sudo crictl ps -a -q | xargs -r sudo crictl stop
sudo crictl ps -a -q | xargs -r sudo crictl rm

```

### 2. 네트워크 스택 정화 (공통 및 필수)

워커 노드에서 가장 중요한 단계입니다. CNI가 생성한 가상 인터페이스와 라우팅 규칙이 남아있으면 재설치 후 포드 간 통신이 불가능해집니다.

```bash
# 2.1 iptables 정책 보호 (원격 접속 유실 방지)
sudo iptables -P INPUT ACCEPT
sudo iptables -P FORWARD ACCEPT
sudo iptables -P OUTPUT ACCEPT
sudo iptables -F && sudo iptables -t nat -F && sudo iptables -t mangle -F && sudo iptables -X

# 2.2 가상 인터페이스 및 라우팅 정리
# 워커 노드에 생성된 cali* 또는 flannel.1 인터페이스를 삭제합니다.
sudo ip link delete cni0
sudo ip link delete flannel.1
sudo ip link show | grep cali | awk '{print $2}' | cut -d'@' -f1 | xargs -r -I {} sudo ip link delete {}
sudo ip neigh flush all

```

### 3. 노드별 데이터 디렉토리 관리

마스터 노드에서만 의미 있는 데이터가 일부 있으나, 스크립트의 범용성을 위해 전체 삭제를 권장합니다.

| 구분 | 마스터 노드 (Master) | 워커 노드 (Worker) |
| --- | --- | --- |
| **/etc/kubernetes** | 인증서, API 서버 설정 (핵심) | Kubelet 접속 정보 (핵심) |
| **/var/lib/etcd** | 클러스터 DB 데이터 (삭제 필수) | 없음 (무시됨) |
| **/var/lib/kubelet** | 포드 볼륨, 마운트 정보 (삭제 필수) | 포드 볼륨, 마운트 정보 (삭제 필수) |

```bash
# 디렉토리 강제 삭제
sudo rm -rf ~/.kube /etc/kubernetes/ /var/lib/kubelet/ /var/lib/etcd/ /etc/cni/ /opt/cni/bin /var/lib/cni/

```

---

### 실전 팁: 워커 노드 전용 주의사항

* **마운트 해제:** 워커 노드는 실제로 포드(Pod)의 볼륨이 마운트되는 곳입니다. `/var/lib/kubelet/pods` 하위에 외부 스토리지(NFS, EBS 등)가 마운트되어 있다면 `rm -rf` 실행 전 반드시 `umount`를 확인해야 합니다.
* **호스트 네임:** 클러스터를 재구성할 때 호스트 네임이 이전과 동일하면 마스터 노드에서 이전 노드 정보를 캐시하고 있을 수 있습니다. 재설치 전 `kubectl delete node <노드명>`으로 마스터에서 기존 워커 정보를 지웠는지 확인하세요.

---

> [!NOTE]
> **과금 및 유료 서비스 안내**
> * **AWS EC2:** 인스턴스를 중지(Stop)하더라도 할당된 **EBS 볼륨 비용**은 계속 발생합니다. 완전히 초기화하고 연습을 마친 후에는 인스턴스를 종료(Terminate)해야 추가 과금을 막을 수 있습니다.
> * **EBS Snapshots:** 초기화 직전 상태를 백업하기 위해 스냅샷을 생성하면, 스냅샷 보관 용량에 비례하여 비용이 청구됩니다.
> * **Public IP:** AWS 인스턴스에 탄력적 IP(EIP)를 할당한 경우, 인스턴스가 실행 중이지 않을 때에도 시간당 비용이 발생할 수 있습니다.
> 
> 

Next Step: **Kubernetes Multinode Cluster Deployment**

---

워커 노드도 마스터와 동일한 절차를 거치는 것이 재설치 시 발생할 수 있는 '고스트 인터페이스' 문제를 방지하는 가장 확실한 방법입니다. 특히 CNI 관련 인터페이스 삭제는 워커 노드에서 더욱 정밀하게 수행되어야 함을 반영했습니다.

나에게 하는 말: 워커 노드 역시 `iptables` 규칙이 복잡하게 얽히므로, 마스터와 동일하게 `-P ACCEPT` 정책을 먼저 적용하는 것이 SSH 세션 보호를 위해 필수적입니다. 이 부분을 강조하여 교재의 안정성을 높였습니다.
