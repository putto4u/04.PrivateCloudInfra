### 마이크로서비스 아키텍처: 약한 결합(Loose Coupling)을 위한 FastAPI 백엔드 구축

본 섹션에서는 Kubernetes(k8s)의 핵심 철학인 **약한 결합(Loose Coupling)**을 구현합니다. 약한 결합이란 클라이언트(프론트엔드 등)가 백엔드의 구체적인 상태(Pod의 IP, 개수, 위치)를 알 필요 없이, 추상화된 단일 진입점(Service)을 통해 통신하는 방식을 의미합니다.

이를 위해 FastAPI 백엔드 Pod를 3개로 복제(Replica)하여 가용성을 확보하고, 이들을 하나의 논리적 서비스로 묶는 Deployment와 Service 매니페스트를 작성합니다.

---

#### 1. Deployment 및 Service 명세서 (YAML)

아래 코드는 3개의 FastAPI 인스턴스를 생성하는 `Deployment`와, 외부에서 이를 접속할 수 있게 해주는 `Service`를 하나의 파일로 정의한 내용입니다. 모든 리소스는 `wb-prod` 네임스페이스에서 격리되어 실행됩니다.

* **파일명:** `fastapi-ori.yaml`

```yaml

---
# [2] Deployment: 오리진 애플리케이션 (3 Replicas)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi            # [Simple] 이름을 단순화
  namespace: wb-prod       # [Prod] 운영 네임스페이스 적용
  labels:
    app: fastapi
spec:
  replicas: 3              # [Availability] 3개의 복제본 유지
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
      - name: fastapi-container
        image: tiangolo/uvicorn-gunicorn-fastapi:python3.9
        ports:
        - containerPort: 80

---
# [3] Service: 약한 결합의 접속점
apiVersion: v1
kind: Service
metadata:
  name: fastapi-svc
  namespace: wb-prod
spec:
  selector:
    app: fastapi           # [Loose Coupling] 라벨을 통해 파드들을 자동 연결
  ports:
    - protocol: TCP
      port: 80             # 내부 포트
      targetPort: 80       # 컨테이너 포트
      nodePort: 30001      # 외부 접속 포트
  type: NodePort

```

---

#### 2. 배포 및 실행 방법

작성된 YAML 파일을 클러스터에 적용하여 리소스를 생성합니다. 네임스페이스가 적용되었으므로 확인 시 반드시 `-n wb-prod` 옵션이 필요합니다.

**Step 1: 매니페스트 적용**

```bash
kubectl apply -f fastapi-origin.yaml

```

**Step 2: 배포 상태 실시간 확인**
Pod가 3개가 정상적으로 생성(Running)되고 있는지, Service가 IP를 할당받았는지 확인합니다.

```bash
# Pod 생성 과정 모니터링 (네임스페이스 wb-prod 지정 필수)
kubectl get pods -n wb-prod -l app=fastapi -w

# Service 및 NodePort 포트 확인
kubectl get svc -n wb-prod fastapi-service

```

**출력 예시:**

```text
NAME                       READY   STATUS    RESTARTS   AGE
fastapi-5d4767c8-abc1      1/1     Running   0          15s
fastapi-5d4767c8-def2      1/1     Running   0          15s
fastapi-5d4767c8-ghi3      1/1     Running   0          15s

```

---

#### 3. 브라우저 접속 및 약한 결합 확인

서비스가 정상적으로 로드밸런싱(트래픽 분산)을 수행하는지 브라우저를 통해 확인합니다.

1. **접속 주소 확인:**
* **로컬/VM 환경:** `http://localhost:30001` 또는 `http://<VM_IP>:30001`
* **AWS EKS 환경:** 워커 노드의 **Public IP** 확인 후 `http://<Node_Public_IP>:30001`
* *Tip:* AWS 보안 그룹(Security Group)에서 인바운드 규칙에 `TCP 30001` 포트가 열려 있어야 접속 가능합니다.


2. **브라우저 확인:**
* 웹 브라우저 주소창에 위 주소를 입력합니다.
* FastAPI 기본 페이지(JSON 응답: `{"message": "Hello World"}`)가 출력되면 성공입니다.


3. **약한 결합(Loose Coupling) 검증:**
* 터미널에서 `kubectl delete` 명령어로 3개 중 하나의 Pod를 강제로 삭제합니다.
* 네임스페이스(`-n wb-prod`)를 반드시 명시해야 합니다.


```bash
# 파드 하나 강제 삭제
kubectl delete pod -n wb-prod <POD_NAME>

```


* **결과:** Kubernetes가 즉시 새로운 `fastapi` Pod를 생성하여 3개를 유지(Self-healing)합니다. 브라우저에서 새로고침을 해도 서비스(`fastapi-service`)가 끊김 없이 정상 응답합니다.



---

**Next Step:** 현재 구축된 오리진(Stateless) 아키텍처에 데이터 영속성을 위한 PVC(PersistentVolumeClaim)를 약한 결합 방식으로 추가하기
