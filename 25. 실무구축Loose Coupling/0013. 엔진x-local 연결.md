## Nginx와 Local Path 볼륨의 느슨한 결합(Loose Coupling) 구성

애플리케이션의 실행 정의(Deployment)와 데이터 저장 정의(PVC)를 분리하여 관리하는 것은 쿠버네티스 운영의 핵심입니다. 이전의 Nginx 설정 파일에 볼륨 연결부만 추가하여, 서비스 설정과 스토리지 자원을 독립적으로 운영할 수 있도록 구성합니다.

---

### 1. 스토리지 자원 정의 (`ng-pvc.yaml`)

애플리케이션과 상관없이 클러스터로부터 1GiB의 공간을 확보하는 선언입니다. 이 파일만으로는 아무런 동작을 하지 않으며, 누군가 이 이름을 불러주기를 기다리는 독립된 자원입니다.

```yaml
# ng-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ng-static-pvc
  namespace: wb_prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 1Gi

```

---

### 2. 애플리케이션 정의 (`ng-web-vol.yaml`)

이전의 Nginx 배포 설정에 **"데이터는 ng-static-pvc라는 이름의 공간에서 가져온다"**는 연결 고리만 추가한 형태입니다. 이것이 바로 **느슨한 결합**입니다. 배포판(Deployment)은 스토리지가 실제로 어느 노드의 어느 경로에 있는지 알 필요가 없으며, 오직 PVC 이름만 참조합니다.

```yaml
# ng-web-vol.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ng-web
  namespace: wb_prod
  labels:
    app: nginx
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
        volumeMounts:
        - name: web-data
          mountPath: /usr/share/nginx/html # 컨테이너 내부 경로
      volumes:
      - name: web-data
        persistentVolumeClaim:
          claimName: ng-static-pvc # PVC 이름을 통해 느슨하게 연결

```

---

### 3. 왜 이것이 느슨한 결합인가?

1. **독립적 교체**: 만약 나중에 `local-path`가 아닌 고성능 클라우드 스토리지로 바꾸고 싶다면, `ng-web-vol.yaml`은 그대로 두고 `ng-pvc.yaml`의 스토리지 클래스만 수정하면 됩니다.
2. **생명주기 분리**: Deployment를 삭제하더라도 PVC는 별도로 존재하므로, 실수로 애플리케이션을 지워도 데이터는 보존될 수 있는 구조를 가집니다.
3. **추상화**: 개발자는 실제 서버의 하드디스크 경로를 알 필요 없이 `ng-static-pvc`라는 이름만 알면 데이터를 저장할 수 있습니다.

---

### 4. 실습 확인 절차

**설정 적용**

```bash
# 순서에 상관없이 적용 가능 (결합이 느슨하기 때문)
kubectl apply -f ng-pvc.yaml -n wb-prod
kubectl apply -f ng-web-vol.yaml -n wb-prod

```

**연결 상태 확인**

```bash
# PVC와 PV가 정상적으로 Bound 되었는지 확인
kubectl get pvc,pv -n wb_prod

# Pod 상세 정보에서 볼륨 마운트 여부 확인
kubectl describe pod ng-web -n wb_prod | grep -A 5 Volumes

```

> [!IMPORTANT]
> **과금 관련 안내**:
> 본 설정은 노드 내부의 디스크를 활용하므로 **추가적인 AWS EBS 비용 등은 발생하지 않습니다.** 하지만 실습 환경의 워커 노드 루트 볼륨 용량을 공유하므로 과도한 데이터 적재는 주의하십시오.

---

Next Step: **PVC 삭제 시 데이터 보존 여부를 결정하는 Reclaim Policy 설정**

---
## 볼륨 연결 구조 및 물리적 저장 경로

쿠버네티스에서 **Local Path Provisioner**를 통해 PVC를 생성하면, 추상화된 논리적 계층이 실제 노드의 물리적 디렉토리와 컨테이너 내부 경로를 연결합니다.

---

### 1. 경로 연결 요약

볼륨의 연결은 크게 세 단계로 이루어집니다: **[노드의 물리 경로] → [PV/PVC] → [컨테이너 내부 경로]**.

* **노드(Host) 측 경로**: `/opt/local-path-provisioner/<PV_이름>_<네임스페이스>_<PVC_이름>`
* **컨테이너(Nginx) 측 경로**: `/usr/share/nginx/html`

---

### 2. 상세 연결 매커니즘

1. **노드 물리 디렉토리**:
Local Path Provisioner는 기본적으로 워커 노드의 `/opt/local-path-provisioner` 아래에 데이터를 저장합니다. PVC가 생성되면 이 경로 아래에 고유한 디렉토리가 자동으로 생성됩니다.
2. **포드 볼륨 마운트**:
`ng-web-vol.yaml` 설정에 따라, 위에서 생성된 노드의 디렉토리가 Nginx 컨테이너 내부의 `/usr/share/nginx/html` 경로로 마운트됩니다.
3. **데이터 동기화**:
이제 노드의 해당 디렉토리에 파일을 넣으면 Nginx 웹 서버가 그 파일을 즉시 서비스하게 되며, 반대로 컨테이너 안에서 생성한 파일도 노드 디렉토리에 영구적으로 저장됩니다.

---

### 3. 실습: 실제 연결 경로 확인하기

수강생들이 실제 연결을 눈으로 확인할 수 있도록 다음 과정을 수행합니다.

**단계 1: PV 이름 확인**
먼저 PVC와 연결된 PV의 이름을 알아내야 노드의 정확한 디렉토리 명을 알 수 있습니다.

```bash
kubectl get pvc ng-static-pvc -n wb_prod
# 예: pvc-a1b2c3d4... 와 같은 PV 이름 확인

```

**단계 2: 워커 노드 접속 및 경로 확인**
실제 해당 포드가 떠 있는 워커 노드에 SSH로 접속하여 아래 경로로 이동합니다.

```bash
# 워커 노드 터미널에서 실행
cd /opt/local-path-provisioner/
ls -F
# 출력 예시: pvc-a1b2c3d4..._wb_prod_ng-static-pvc/

```

**단계 3: 파일 생성 테스트**
노드에서 파일을 생성하고 Nginx가 이를 인식하는지 확인합니다.

```bash
# 노드 디렉토리 안에서 실행
echo "This is Local Path Data" > index.html

# 포드 내부에서 확인
kubectl exec -it <ng-web-pod-name> -n wb_prod -- cat /usr/share/nginx/html/index.html

```

---

### 4. 핵심 정리

* **느슨한 결합의 이점**: 사용자는 `/opt/...`라는 복잡한 노드 경로를 몰라도 `ng-static-pvc`라는 이름만 연결하면 쿠버네티스가 알아서 물리적 경로를 매핑해 줍니다.
* **영속성**: 포드가 삭제되고 다른 이름으로 다시 생성되어도, 동일한 PVC 이름을 참조한다면 노드에 저장된 `/opt/local-path-provisioner/...` 내부의 데이터는 그대로 유지됩니다.

> [!IMPORTANT]
> **과금 및 자원 안내**:
> 노드의 로컬 경로를 직접 사용하므로 **추가적인 AWS EBS 과금은 발생하지 않습니다.** 하지만 해당 경로가 위치한 노드의 루트 디스크(`/`) 용량을 사용하므로, 디스크 풀(Full) 장애가 발생하지 않도록 관리해야 합니다.

---

Next Step: **노드의 기본 저장 경로(/opt/...)를 다른 디스크 경로로 변경하는 설정 방법**
