## FastAPI와 영구 저장소(PVC)의 결합 및 데이터 서비스 구축

애플리케이션 로직(FastAPI)과 영구 저장소(back-pvc)를 연결하여, API를 통해 입력받은 데이터를 물리적 디스크에 저장하고 다시 조회하는 실무 환경을 구축합니다.

---

### 1. 볼륨이 적용된 FastAPI 정의 (`fastapi-app.yaml`)

기존 FastAPI 설정에 볼륨 마운트 설정을 추가합니다. 두 리소스는 `back-pvc`라는 이름을 통해 **느슨한 결합**을 유지하며 연결됩니다.

```yaml
# fastapi-app.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-web
  namespace: wb_prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
      - name: fastapi-container
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
          - |
            pip install fastapi uvicorn;
            cat <<EOF > main.py
            from fastapi import FastAPI
            import os

            app = FastAPI()
            FILE_PATH = "/data/storage/message.txt"

            @app.get("/")
            def read_root():
                return {"message": "FastAPI with PVC is Running"}

            @app.get("/write")
            def write_file(content: str = "Default Data"):
                os.makedirs(os.path.dirname(FILE_PATH), exist_ok=True)
                with open(FILE_PATH, "a") as f:
                    f.write(content + "\n")
                return {"status": "success", "written": content}

            @app.get("/read")
            def read_file():
                if os.path.exists(FILE_PATH):
                    with open(FILE_PATH, "r") as f:
                        return {"data": f.readlines()}
                return {"data": "No file found"}
            EOF
            python3 -m uvicorn main:app --host 0.0.0.0 --port 8000
        volumeMounts:
        - name: data-volume
          mountPath: /data/storage      # 컨테이너 내 저장 경로
      volumes:
      - name: data-volume
        persistentVolumeClaim:
          claimName: back-pvc           # 미리 생성한 PVC 이름 지정

```

---

### 2. 설치 및 실행 방법

작성된 YAML 파일을 클러스터에 적용하고 시스템의 연결 상태를 점검합니다.

**단계 1: 설정 적용**

```bash
kubectl apply -f fastapi-app.yaml

```

**단계 2: 포드 및 볼륨 상태 확인**

```bash
# 포드 실행 확인
kubectl get pods -n wb_prod

# PVC 바인딩 확인
kubectl get pvc back-pvc -n wb_prod

```

---

### 3. 브라우저 확인 및 데이터 영속성 테스트

FastAPI의 자동 API 문서 기능과 파일 시스템 연결을 확인합니다.

1. **API 문서 접속**:
* 주소: `http://<Worker-Node-IP>:38000/docs`


2. **데이터 쓰기 테스트**:
* `/write` API의 `Try it out` 버튼을 누르고 `content`에 메시지를 입력 후 실행합니다.


3. **데이터 읽기 테스트**:
* `/read` API를 호출하여 방금 저장한 메시지가 출력되는지 확인합니다.


4. **영속성 검증**:
* `kubectl delete pod [포드이름] -n wb_prod` 명령으로 포드를 삭제합니다.
* 새 포드가 생성된 후 다시 `/read`를 호출했을 때 데이터가 유지되어 있다면 성공입니다.



---

### 4. 핵심 관리 포인트

* **동적 매핑**: 사용자는 컨테이너의 `/data/storage`만 바라보지만, 실제 데이터는 워커 노드의 로컬 경로에 안전하게 격리되어 저장됩니다.
* **상태 유지**: 애플리케이션 코드가 수정되어 포드가 재배포되어도, 별도의 파일 시스템인 `back-pvc`를 사용하므로 데이터 유실이 없습니다.

> [!IMPORTANT]
> **과금 관련 안내**:
> 본 구성은 클라우드 유료 스토리지(EBS 등)를 사용하지 않고 인스턴스의 로컬 디스크 공간을 사용하므로 **추가적인 과금이 발생하지 않습니다.**

---

Next Step: **FastAPI 서비스에 도메인을 연결하기 위한 Ingress 설정 방법**

---

Next Step: **back-pvc**
