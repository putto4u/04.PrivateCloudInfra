### [실습] Deployment와 PVC 연결 (볼륨 마운트)

이전 단계에서 정의한 `FastAPI` 애플리케이션(Deployment)과 저장소(PVC)는 현재 독립적으로 존재합니다. 애플리케이션이 데이터를 영구적으로 저장할 수 있도록, 이 둘을 **약한 결합(Loose Coupling)** 방식으로 연결하는 YAML을 작성합니다.

이미 생성된 Deployment 리소스에 볼륨 설정을 추가하는 방식(Patch)으로 진행합니다.

---

### 1. 연결 원리: Volume과 VolumeMount

Kubernetes에서 스토리지 연결은 두 단계로 이루어집니다.

1. **Volume 정의:** 파드 수준에서 사용할 스토리지 리소스(PVC)를 선언합니다.
2. **VolumeMount 설정:** 선언된 볼륨을 컨테이너 내부의 특정 경로와 연결합니다.

### 2. 작성 코드: `03.fastapi-mount.yaml`

기존의 `Deployment` 명세에 `volumes`와 `volumeMounts` 항목을 추가하여 재배포(Apply)하면, 파드가 재생성되면서 스토리지가 연결됩니다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi           # 기존 Deployment와 동일한 이름 (수정 모드)
  namespace: wb-prod      # [필수] 동일한 네임스페이스
spec:
  replicas: 3
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
      - name: fastapi-container
        image: tiangolo/uvicorn-gunicorn-fastapi:python3.9
        ports:
        - containerPort: 80
        
        # [핵심 1] 컨테이너 내부 경로 설정
        volumeMounts:
        - name: data-storage       # 아래 volumes에서 정의한 이름과 일치해야 함
          mountPath: /app/data     # 컨테이너 내부에서 데이터가 저장될 경로
          
      # [핵심 2] 사용할 스토리지(PVC) 지정
      volumes:
      - name: data-storage         # 볼륨의 별칭 (자유롭게 지정)
        persistentVolumeClaim:
          claimName: back-pvc      # 앞서 생성한 PVC 이름 (정확히 일치해야 함)

```

### 3. 적용 및 검증

작성한 파일을 클러스터에 적용하여 기존 파드를 교체하고 마운트 상태를 확인합니다.

**A. 설정 적용**

```bash
kubectl apply -f 03.fastapi-mount.yaml

```

* `configured` 메시지가 뜨면 정상적으로 기존 Deployment가 수정된 것입니다.

**B. 마운트 확인**
파드 내부로 진입하여 지정한 경로(`mountPath`)에 파일 시스템이 연결되었는지 확인합니다.

```bash
# 1. 파드 이름 확인
kubectl get pods -n wb-prod

# 2. 파드 내부 접속 (파드명 변경 필요)
kubectl exec -it <POD_NAME> -n wb-prod -- /bin/bash

# 3. 마운트 경로 확인 (내부 쉘)
df -h | grep /app/data
# 출력 예: /dev/sdb ... /app/data (용량이 PVC 요청량과 비슷한지 확인)

```

---

### [Tip] 왜 '약한 결합'인가?

이 방식은 **애플리케이션(Deployment)**과 **인프라(PVC/PV)**의 생명주기를 분리합니다.

* **Deployment**는 "나는 `back-pvc`라는 이름의 저장소가 필요해"라고만 선언합니다.
* 실제 스토리지가 AWS EBS인지, NFS인지, 로컬 디스크인지는 **PVC**와 **StorageClass**가 담당합니다.
* 따라서 개발자는 인프라의 상세 내용을 몰라도 `claimName`만 알면 스토리지를 사용할 수 있습니다.

---

**Next Step:** 파드 내부에서 더미 파일 생성 후, 다른 파드나 로컬 경로에서 데이터 유지 확인

---

Deployment 파일에 PVC 연결 설정을 추가하여 "약한 결합"을 유지하면서 스토리지를 마운트하는 YAML 코드를 작성해 드렸습니다.
