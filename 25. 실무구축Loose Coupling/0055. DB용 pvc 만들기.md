## MySQL 전용 로컬 패스(Local Path) 영구 저장소 구축 가이드

데이터베이스의 안정성을 확보하기 위해 수동으로 경로를 지정하는 `hostPath` 방식 대신, 쿠버네티스가 물리적 경로를 자동으로 생성하고 관리하는 **Local Path Provisioner** 기반의 영구 저장소(PVC)를 구축합니다.

이 과정은 실제 데이터가 담길 '그릇'을 먼저 준비하는 단계이며, 쓰기 전용 서버 1개와 읽기 전용 서버 2개를 위해 총 3개의 독립적인 공간을 확보합니다.

---

### 1. 스토리지 설계 구조

하나의 워커 노드 내에서 디렉토리를 물리적으로 분리하여 데이터 혼선을 방지합니다.

* **mysql-pvc-primary**: 쓰기 전용(Master) 서버의 데이터 저장소 (2Gi)
* **mysql-pvc-replica-1**: 첫 번째 읽기 전용(Slave) 서버의 데이터 저장소 (2Gi)
* **mysql-pvc-replica-2**: 두 번째 읽기 전용(Slave) 서버의 데이터 저장소 (2Gi)

---

### 2. DB 전용 PVC 정의 (`mysql-storage.yaml`)

`storageClassName: local-path`를 사용하여 동적 프로비저닝(Dynamic Provisioning)을 활성화합니다.

```yaml
# mysql-storage.yaml
# --- 1. 쓰기 전용(Primary) PVC ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-primary
  namespace: wb_prod         # 작업 네임스페이스 지정
spec:
  accessModes:
    - ReadWriteOnce          # 하나의 노드에서 읽기/쓰기 가능
  storageClassName: local-path # 로컬 패스 프로비저너 사용
  resources:
    requests:
      storage: 2Gi           # 저장 용량 2GB 할당
---
# --- 2. 읽기 전용(Replica-1) PVC ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-replica-1
  namespace: wb_prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 2Gi
---
# --- 3. 읽기 전용(Replica-2) PVC ---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-replica-2
  namespace: wb_prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 2Gi

```

---

### 3. 설치 및 실행 방법

**단계 1: PVC 생성**
작성한 스토리지 설정 파일을 클러스터에 적용합니다.

```bash
kubectl apply -f mysql-storage.yaml

```

**단계 2: 생성 상태 확인**

```bash
kubectl get pvc -n wb_prod

```

> **참고**: `STATUS`가 `Pending`으로 표시되는 것은 정상입니다. `local-path`는 실제로 이 볼륨을 사용할 MySQL 포드가 생성되어 어느 노드에 배치될지 결정된 순간 물리적인 공간을 할당(Bound)합니다.

---

### 4. 핵심 관리 포인트

* **동적 생성 (Dynamic)**: 관리자가 노드에 접속하여 `mkdir`로 폴더를 미리 만들 필요가 없습니다. 포드가 생성되는 시점에 `/opt/local-path-provisioner/` 하위에 고유한 디렉토리가 자동 생성됩니다.
* **데이터 보존**: 나중에 배포할 MySQL 포드를 삭제하거나 업데이트하더라도, 이 PVC에 담긴 데이터는 삭제되지 않고 안전하게 보존됩니다.
* **독립성 확보**: 각각의 PVC는 서로 다른 디렉토리를 사용하므로, 3개의 MySQL 인스턴스가 서로의 데이터를 간섭하지 않습니다.

---

### 5. 트러블슈팅 가이드

* **SC(StorageClass) 미확인**: `kubectl get sc` 명령어를 실행했을 때 `local-path`라는 이름의 스토리지 클래스가 존재해야 합니다.
* **용량 제한**: 워커 노드의 디스크 용량이 부족할 경우 볼륨 할당이 실패할 수 있으므로 `df -h` 명령어로 노드의 잔여 용량을 확인하십시오.

> [!IMPORTANT]
> **과금 관련 안내**:
> 본 방식은 인프라의 로컬 디스크를 활용하므로 **추가적인 클라우드 스토리지 과금이 발생하지 않습니다.**

---

Next Step: **생성된 3개의 PVC를 각각의 MySQL Primary 및 Replica 포드에 연결(Mount)하기**

---

Next Step: **back-pvc**
