## Ingress를 이용한 서비스 통합 및 경로 기반 라우팅

인그레스(Ingress)는 클러스터 외부의 HTTP/HTTPS 요청을 내부 서비스로 전달하는 스마트한 게이트웨이 역할을 합니다. 로드밸런서 서비스 없이 단일 고정 IP(`192.168.0.251`)를 통해 요청된 경로(Path)에 따라 각각 다른 서버로 트래픽을 분산하는 **경로 기반 라우팅(Path-based Routing)**을 구축합니다.

---

### 1. 인그레스 설정의 핵심 구조

각 서버는 독립적으로 존재하며, 인그레스가 이를 논리적으로 묶어주는 **느슨한 결합** 구조를 가집니다.

* **Host IP**: `192.168.0.251` (고정 외부 IP)
* **Routing Rule**:
* `/` (Root) → `fr-end` 서비스 (Nginx) 연결
* `/vew` (Python) → `py-service` 서비스 (Python 3) 연결
* `/bucket` (API) → `fastapi-service` 서비스 (FastAPI) 연결



---

### 2. 인그레스 정의 (`wb-ingress.yaml`)

별도의 외부 로드밸런서 없이 특정 고정 IP를 사용하여 트래픽을 처리하도록 설정된 매니페스트입니다.

```yaml
# wb-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wb-ingress
  namespace: wb_prod
  annotations:
    kubernetes.io/ingress.class: "nginx"
    # 경로 끝의 '/' 처리를 위한 설정 (Rewrite)
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  # 로드밸런서가 없는 환경에서 고정 IP를 명시적으로 사용하는 규칙
  rules:
  - host: "192.168.0.251"
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: fr-end
            port:
              number: 80
      - path: /vew
        pathType: Prefix
        backend:
          service:
            name: py-service
            port:
              number: 80
      - path: /bucket
        pathType: Prefix
        backend:
          service:
            name: fastapi-service
            port:
              number: 80

```

---

### 3. 설치 및 실행 방법

**단계 1: 설정 적용**

```bash
kubectl apply -f wb-ingress.yaml

```

**단계 2: 인그레스 상태 확인**

```bash
# 설정한 Host IP(192.168.0.251)가 정상적으로 바인딩되었는지 확인
kubectl get ingress -n wb_prod

```

---

### 4. 브라우저 확인 방법

이제 포트 번호(`30080` 등)를 입력할 필요 없이 고정 IP와 서비스 경로만으로 각각의 서버에 접속할 수 있습니다.

1. **Nginx 접속 (Root)**:
* 주소: `http://192.168.0.251/`
* 결과: Nginx 기본 페이지 또는 공유된 `index.html` 출력


2. **Python 웹 접속 (/vew)**:
* 주소: `http://192.168.0.251/vew`
* 결과: Python 기본 웹서버의 파일 목록 출력


3. **FastAPI 접속 (/bucket)**:
* 주소: `http://192.168.0.251/bucket`
* 결과: FastAPI 서버의 JSON 응답 출력



---

### 5. 트러블 슈팅 (Troubleshooting)

**Q1. 404 Not Found 에러가 발생합니다.**

* **원인**: 인그레스 설정의 `path`와 실제 컨테이너 내부 애플리케이션이 기대하는 경로가 다를 때 발생합니다.
* **해결**: `nginx.ingress.kubernetes.io/rewrite-target: /` 주석(Annotation)이 포함되어 있는지 확인하십시오.

**Q2. IP 접속이 되지 않습니다.**

* **원인**: 인그레스 컨트롤러(Nginx Ingress Controller 등)가 클러스터에 미리 설치되어 있지 않거나, 해당 IP가 호스트 네트워크에서 도달 불가능한 경우입니다.
* **해결**: 인그레스 컨트롤러 포드의 상태를 확인하고, 워커 노드에서 해당 IP로 통신이 가능한지 점검하십시오.

**Q3. 특정 경로만 접속이 안 됩니다.**

* **원인**: 인그레스에 기재된 서비스 이름(`service.name`)이 실제 실행 중인 서비스 이름과 일치하지 않는 경우입니다.
* **해결**: `kubectl get svc -n wb_prod` 명령어로 서비스 이름을 다시 확인하십시오.

---

### 6. 핵심 관리 포인트

* **느슨한 결합**: 인그레스는 개별 서버의 설정에 관여하지 않고 오직 트래픽의 통로만 결정합니다. 따라서 특정 서버가 죽거나 교체되어도 인그레스 설정 전체를 바꿀 필요가 없습니다.
* **포트 통합**: 여러 서비스가 각각 다른 `NodePort`를 쓰더라도, 사용자에게는 `80`(표준 HTTP) 포트 하나로 통합된 경험을 제공합니다.

> [!IMPORTANT]
> **과금 및 자원 안내**:
> 인그레스 자체는 쿠버네티스의 소프트웨어 객체이므로 **추가 비용이 발생하지 않습니다.** 로드밸런서 서비스를 사용하지 않으므로 외부 클라우드 과금 요소도 없습니다.

---

Next Step: **인그레스에 TLS 인증서를 적용하여 HTTPS(443) 보안 접속 설정하기**

---

Next Step: **back-pvc**
