## Ingress Nginx 컨트롤러 설치 가이드

쿠버네티스 클러스터의 외부 관문 역할을 하는 **Ingress Nginx Controller**를 설치하는 표준 절차입니다. 운영 편의성과 버전 관리를 위해 **Helm(패키지 매니저)** 방식을 권장하며, 환경에 따라 Manifest(YAML) 방식도 선택할 수 있습니다.

---

### 1. Helm을 이용한 설치 (권장)

가장 안정적이고 관리가 쉬운 방법입니다. 차트 저장소를 추가하고 최신 버전을 내려받아 설치합니다.

**1단계: 저장소(Repository) 추가 및 업데이트**

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

```

**2단계: 네임스페이스 생성 및 설치**

```bash
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace

```

**[옵션] 로컬 VM/Bare Metal 환경용 설정 (NodePort)**
클라우드 로드밸런서가 없는 환경(PC, 온프레미스)에서는 서비스 타입을 `NodePort`로 강제 지정해야 접속이 용이합니다.

```bash
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace \
  --set controller.service.type=NodePort \
  --set controller.service.nodePorts.http=30080 \
  --set controller.service.nodePorts.https=30443

```

---

### 2. Manifest(YAML)를 이용한 설치 (빠른 설치)

Helm 없이 단순히 `kubectl` 명령어로 설치할 때 사용합니다. (베어메탈용 표준 배포판 기준)

```bash
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/baremetal/deploy.yaml

```

*(참고: 버전(v1.8.2)은 호환성에 따라 변경될 수 있습니다.)*

---

### 3. 환경별 서비스 구성 차이점 (중요)

설치 후 `Service`의 타입에 따라 외부 접속 방식이 달라집니다.

| 환경 | Service Type | 동작 방식 | 과금 여부 |
| --- | --- | --- | --- |
| **AWS EKS / EC2** | **LoadBalancer** | AWS Classic LB(또는 NLB)가 자동으로 생성되어 공인 IP를 할당받습니다. | **유료 (ELB 요금 발생)** |
| **PC / VM / On-prem** | **NodePort** | 노드의 IP와 지정된 포트(30000-32767)를 통해 접속합니다. | 무료 |
| **PC + MetalLB** | **LoadBalancer** | MetalLB가 사설 IP 대역에서 가상 IP(External-IP)를 할당해 줍니다. | 무료 |

---

### 4. 설치 검증 (Verification)

설치가 완료되면 컨트롤러 파드와 서비스가 정상적으로 떴는지 확인합니다.

```bash
# 1. 파드 상태 확인 (Running 상태여야 함)
kubectl get pods -n ingress-nginx

# 2. 서비스 상태 및 외부 접속 주소 확인
kubectl get svc -n ingress-nginx

```

* **성공 기준:**
* **AWS:** `EXTERNAL-IP` 항목에 `xxx.elb.amazonaws.com` 주소가 표시됨.
* **NodePort:** `EXTERNAL-IP`는 `<none>`이지만 `PORT(S)`에 `80:30080/TCP`와 같이 포트가 매핑됨.
* **실패:** `Pending` 상태가 5분 이상 지속되면 로드밸런서 할당 실패(권한 문제 등) 또는 리소스 부족 의심.



---

### 5. 트러블슈팅 (자주 발생하는 문제)

1. **Webhook 에러:** `Internal error occurred: failed calling webhook...` 에러 발생 시, 이전 설치 잔재가 남은 것이므로 `ValidatingWebhookConfiguration`을 삭제해야 합니다.
2. **Pending 상태 (AWS):** 서브넷(Subnet) 설정에 태그가 없거나 인터넷 게이트웨이(IGW) 연결이 안 된 Private Subnet에 배포된 경우입니다.

---

**Next Step: 인그레스(Ingress) 리소스 배포 및 도메인 기반 라우팅 실습**

* 테스트용 웹 애플리케이션(Deployment + Service) 배포
* `host` 기반 인그레스 YAML 작성
* `/etc/hosts` 파일 변조를 통한 로컬 도메인 접속 테스트
