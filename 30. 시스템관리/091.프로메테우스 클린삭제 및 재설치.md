`kube-prometheus-stack`(All-in-One)은 프로메테우스, 그라파나, 얼럿매니저 및 각종 설정(CRD)이 하나로 묶여 있어 삭제 시 일반적인 방법으로는 잔재가 많이 남습니다. 완전히 깨끗하게 삭제하고 다시 설치하는 과정을 정리해 드립니다.

---

## 프로메테우스 스택(All-in-One) 클린 삭제 및 재설치

모니터링 스택은 일반 파드와 달리 **CRD(Custom Resource Definitions)**를 생성하므로, 헬름(Helm) 삭제 후에도 남은 자원을 수동으로 정리해야 재설치 시 설정 충돌을 막을 수 있습니다.

### 1. 스택 완전 삭제 단계

#### 1) Helm 차트 삭제

먼저 설치된 릴리즈를 삭제합니다.

```bash
# prometheus라는 이름으로 설치한 경우
helm uninstall prometheus -n monitoring

```

#### 2) CRD(사용자 정의 리소스) 삭제

`kube-prometheus-stack`은 프로메테우스 동작을 위한 전용 리소스 정의를 생성합니다. 이를 삭제하지 않으면 재설치 시 이전 설정이 꼬이게 됩니다.

```bash
# 프로메테우스 관련 모든 CRD 조회 및 삭제
kubectl get crd | grep coreos.com | awk '{print $1}' | xargs kubectl delete crd

```

#### 3) 네임스페이스 및 잔재 정리

설정값(ConfigMap)과 비밀번호(Secret) 등이 남아있을 수 있는 네임스페이스를 완전히 삭제합니다.

```bash
kubectl delete namespace monitoring

```

---

### 2. 재설치 전 리소스 최적화 설정 (`values.yaml`)

PC 리소스 부족을 방지하기 위해, 재설치 시에는 반드시 설정을 경량화하여 배포해야 합니다. 아래 내용을 `my-values.yaml` 파일로 저장합니다.

```yaml
# 실습 최적화 경량화 설정
prometheus:
  prometheusSpec:
    retention: 2h          # 보관 기간을 2시간으로 단축
    retentionSize: "500Mi" # 최대 용량 제한
    scrapeInterval: "30s"  # 수집 주기를 늘려 CPU 부하 감소
    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "500m"

grafana:
  resources:
    requests:
      memory: "128Mi"
    limits:
      memory: "256Mi"

# 실습에 불필요한 컴포넌트 비활성화
alertmanager:
  enabled: false
prometheus-node-exporter:
  enabled: true # 노드 메트릭은 필요하므로 유지

```

---

### 3. 클린 재설치 실행

준비된 경량 설정 파일을 적용하여 설치를 진행합니다.

```bash
# 1. 레포지토리 업데이트
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# 2. 경량 설정(values.yaml)을 적용하여 설치
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  -f my-values.yaml

```

---

### 4. 설치 후 정상 작동 확인

재설치가 완료되면 다음 명령어로 파드들이 제한된 리소스 내에서 정상적으로 실행되는지 확인합니다.

1. **파드 상태 확인:** `kubectl get pods -n monitoring` (모두 Running인지 확인)
2. **리소스 사용량 확인:** `kubectl top pods -n monitoring` (설정한 Limit를 넘지 않는지 확인)
3. **웹 UI 접속:** 인그레스나 포트 포워딩을 통해 그라파나 대시보드 접속 확인.

---

> **AWS 운영 및 과금 주의**
> * **EBS 볼륨 확인:** 프로메테우스는 데이터를 저장하기 위해 PVC를 생성합니다. 삭제 시 PV가 자동으로 지워지지 않을 수 있으니, AWS 콘솔의 **Volumes** 메뉴에서 미사용 볼륨이 남아 과금되지 않는지 꼭 확인하십시오.
> * **로드밸런서 비용:** 서비스 타입을 `LoadBalancer`로 설정할 경우 ELB 비용이 발생하므로, 내부 실습 시에는 `NodePort`나 `Ingress`를 권장합니다.
> 
> 

---

**Next Step: 프로메테우스 메트릭 수집(Scraping) 대상 추가 및 대시보드 구성**

* ServiceMonitor 개념 및 작성법
* FastAPI 메트릭 노출(Prometheus Client) 설정
* Grafana 커스텀 대시보드 임포트 방법
