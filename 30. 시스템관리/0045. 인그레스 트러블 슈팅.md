# Module: Kubernetes Ingress Traffic Routing & Rewrite Strategy

## 1. Ingress 설계의 핵심 이슈 분석

제공된 파일 목록과 기존 `wb-ingress.yaml`을 분석했을 때, 실무 운영 환경(VM IP 접속)에서 발생할 수 있는 세 가지 문제점이 발견되었습니다. 이를 수정하여 안정적인 라우팅이 가능한 아키텍처를 설계합니다.

### 1.1 Host 필드와 IP 주소 제약

기존 설정(`host: "192.168.100.251"`)은 인그레스 컨트롤러에 따라 유효하지 않을 수 있습니다. 쿠버네티스 Ingress 표준 스펙에서 `host` 필드는 FQDN(도메인 이름)을 원칙으로 합니다. IP로 직접 접속하거나 특정 도메인이 없는 개발 환경에서는 **host 필드를 생략**하여 들어오는 모든 트래픽을 허용하는 것이 모범 사례(Best Practice)입니다.

### 1.2 Rewrite Target의 오해

기존 설정(`nginx.ingress.kubernetes.io/rewrite-target: /`)은 모든 하위 경로 트래픽을 백엔드의 루트(`/`)로 강제 변경합니다.

* **문제점:** `/bucket/image.png`를 요청해도 백엔드(`fastapi-svc`)는 `/`만 전달받아 이미지를 찾을 수 없게 됩니다.
* **해결책:** **정규표현식(Regex)**과 **캡처 그룹(Capture Group)**을 사용하여, `/bucket` 뒤에 붙은 하위 경로(`/image.png`)를 보존하여 백엔드에 전달해야 합니다.

### 1.3 경로 오타 수정

기존 파일에서 `/vew`로 작성된 경로는 `/view`의 오타로 판단되므로, 표준적인 네이밍 컨벤션에 맞춰 수정합니다.

---

## 2. [수정 완료] wb-ingress.yaml

아래 코드는 Nginx Ingress Controller의 **Regex Rewrite** 기능을 활용하여 3개의 서비스(`fr-end`, `py-service`, `fastapi-svc`)를 단일 진입점으로 통합합니다.

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: wb-ingress
  namespace: wb-prod
  annotations:
    # [핵심 1] Nginx Ingress Class 지정
    kubernetes.io/ingress.class: "nginx"
    
    # [핵심 2] 경로 재작성(Rewrite) 로직 고도화
    # ($2)는 path 설정에서 두 번째 괄호(.*)에 해당하는 값을 의미함
    # 즉, /bucket/abc 요청 시 -> 백엔드에는 /abc 로 전달됨
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    
    # [선택] 업로드 용량 제한 해제 (필요 시)
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"

spec:
  # host 필드를 삭제하여 IP(192.168.100.251) 및 모든 도메인 접속 허용
  rules:
  - http:
      paths:
      # 1. Frontend 서비스 (Root 경로)
      # / 로 시작하는 모든 요청을 처리
      - path: /()?(.*)
        pathType: Prefix
        backend:
          service:
            name: fr-end
            port:
              number: 80

      # 2. Python Web Server (/view 경로)
      # /view 로 들어오는 요청을 py-service로 라우팅
      # 예: /view/index.html -> py-service의 /index.html 로 전달
      - path: /view(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: py-service
            port:
              number: 80

      # 3. FastAPI Server (/bucket 경로)
      # /bucket 으로 들어오는 요청을 fastapi-svc로 라우팅
      # 예: /bucket/items -> fastapi-svc의 /items 로 전달
      - path: /bucket(/|$)(.*)
        pathType: Prefix
        backend:
          service:
            name: fastapi-svc
            port:
              number: 80

```

---

## 3. 상세 설정 가이드 및 아키텍처 설명

### 3.1 Rewrite 정규식 동작 원리

`path`에 설정된 정규식과 `rewrite-target`은 다음과 같이 상호작용합니다.

| 사용자 요청 URL | Ingress Path 설정 | 캡처 그룹($2) 내용 | 최종 백엔드 전달 경로 |
| --- | --- | --- | --- |
| `http://IP/` | `/()?(.*)` | (없음) | `/` (`fr-end`) |
| `http://IP/view/data.txt` | `/view(/ | $)(.*)` | `data.txt` |

* **`/view(/|$)(.*)` 의미:**
* `/view`로 시작하고,
* 그 뒤에 슬래시(`/`)가 오거나 문장이 끝(`$`)나며,
* 그 뒤의 나머지 모든 문자(`.*`)를 캡처하여 변수로 저장한다.



### 3.2 백엔드 서비스 연결 점검

* **fr-end:** `ng-web.yml`에 정의된 `fr-end` 서비스(Port 80)와 연결됩니다. 이는 정적 웹페이지(HTML)를 제공하는 엔트리 포인트입니다.
* **py-service:** `py-web.yaml`에 정의된 `py-service` 서비스(Port 80 -> Target 8000)와 연결됩니다. `python -m http.server`는 루트 경로(`/`)를 기준으로 파일을 서빙하므로 Rewrite가 필수적입니다.
* **fastapi-svc:** `fastapi-mount.yml`에 정의된 `fastapi-svc` 서비스(Port 80)와 연결됩니다. FastAPI 내부 라우터가 `/items`, `/users` 등으로 정의되어 있다면, Rewrite를 통해 `/bucket` 접두어를 떼고 전달해야 정상 작동합니다.

### 3.3 접속 테스트 방법

설정 적용 후 브라우저 또는 `curl`을 통해 다음과 같이 테스트합니다.

1. **메인 페이지:** `http://192.168.100.251/`
2. **파이썬 파일 서버:** `http://192.168.100.251/view/`
3. **FastAPI 앱:** `http://192.168.100.251/bucket/` (FastAPI에 루트(`/`) 엔드포인트가 정의되어 있어야 함)

---

**Next Step:**
Ingress 설정 적용(`kubectl apply`) 후 실제 접속 테스트 및 404 에러 시 트러블슈팅 방법
