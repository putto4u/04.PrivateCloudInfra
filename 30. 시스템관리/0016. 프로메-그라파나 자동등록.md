# All-in-One 설치 시 모니터링 자동 등록 여부 및 범위

결론부터 말씀드리면, **'All-in-One'(주로 `kube-prometheus-stack` Helm 차트나 통합 매니페스트)으로 설치했다면, 클러스터 자체(인프라)는 100% 자동으로 등록되고 모니터링됩니다.** 별도로 그라파나에 노드를 추가하거나 데이터 소스를 연결할 필요가 없습니다.

다만, 사용자가 배포한 **개별 애플리케이션(FastAPI, Nginx 등)**의 상세 지표는 추가 설정(`ServiceMonitor`)이 필요할 수 있습니다.

---

## 1. 자동으로 되는 것 (Infrastructure & Cluster)

`All-in-One` 설치 패키지는 쿠버네티스 내부의 **서비스 디스커버리(Service Discovery)** 기능을 활용하여 다음 요소들을 자동으로 찾아내고 수집합니다.

1. **데이터 소스 연결 (Data Source):**
* 그라파나가 프로메테우스를 바라보도록 설정하는 과정이 **프로비저닝(Provisioning)** 설정 파일에 이미 포함되어 있습니다. 설치 즉시 그라파나에서 데이터를 조회할 수 있습니다.


2. **노드 리소스 (Node Exporter):**
* 모든 노드(마스터, 워커)에 `DaemonSet` 형태로 `node-exporter`가 자동 배포됩니다.
* 새로운 워커 노드(`vm2`)가 추가되면, 프로메테우스가 이를 감지하고 **자동으로 수집 대상(Target)에 추가**합니다.


3. **쿠버네티스 상태 (Kube-State-Metrics):**
* 파드의 상태(Running, Pending), 배포 개수, 리플리카셋 현황 등 쿠버네티스 오브젝트의 상태 정보가 자동으로 수집됩니다.


4. **기본 대시보드:**
* `Node Exporter Full`, `Kubernetes / Compute Resources / Namespace (Pods)` 등의 고품질 대시보드가 미리 탑재되어 있습니다.



---

## 2. 수동으로 해줘야 하는 것 (Custom Application)

인프라가 아닌, **내가 직접 만든 앱(FastAPI, Web Server 등)의 내부 지표**를 보고 싶다면 '연결 고리'를 만들어줘야 합니다.

1. **애플리케이션 설정:**
* 앱이 `/metrics` 경로로 메트릭을 뱉어내고 있어야 합니다. (예: FastAPI의 `prometheus-fastapi-instrumentator`)


2. **ServiceMonitor 등록:**
* 프로메테우스에게 "내 앱(`fastapi`)이 여기 있으니 수집해가라"고 알려주는 `ServiceMonitor`라는 CRD(Custom Resource Definition) 리소스를 생성해야 합니다.
* 이것을 등록하지 않으면 프로메테우스는 해당 파드가 존재하는지는 알지만, 그 안의 **애플리케이션 레벨 데이터(HTTP 요청 수, 응답 시간 등)**는 수집하지 않습니다.



---

## 3. 자동 등록 확인 방법

설치가 잘 되었고, 자동으로 수집 중인지 확인하려면 그라파나가 아니라 **프로메테우스 UI**에서 확인하는 것이 가장 정확합니다.

1. **프로메테우스 UI 접속** (`http://<마스터IP>:9090`)
2. 상단 메뉴의 **Status > Targets** 클릭.
3. 목록 확인:
* `node-exporter` (각 노드 IP별로 UP 상태여야 함)
* `kubelet`
* `apiserver`
* `coredns`
* 위 항목들이 모두 **UP (초록색)** 상태라면, 그라파나에서도 자동으로 보입니다.



---

Next Step: 내 애플리케이션(FastAPI 등)을 프로메테우스가 수집하도록 ServiceMonitor 작성 및 등록 실습
