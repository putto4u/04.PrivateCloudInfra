### 가상 머신(VM) 및 LVM 디스크 용량 확장 가이드

가상 환경에서 디스크 용량을 추가로 할당했음에도 시스템에서 인식하지 못하는 문제를 해결하기 위해, 가상 미디어 관리부터 OS 내부의 논리 볼륨 확장까지의 전 과정을 정리한 교재입니다.

---

#### 1. 디스크 확장 프로세스의 이해

가상 머신의 디스크를 확장하는 과정은 크게 세 단계로 나뉩니다. 단순히 가상 머신 설정에서 숫자를 키우는 것만으로는 부족하며, OS 내부에서 하드웨어 변경 사항을 반영해 주어야 합니다.

1. **가상 머신 설정(S/W) 단계:** VirtualBox 등 하이퍼바이저에서 가상 디스크의 물리적 크기 확장
2. **LVM 관리 단계:** 물리 볼륨(PV), 볼륨 그룹(VG), 논리 볼륨(LV) 순서로 용량 반영
3. **파일 시스템 단계:** 확장된 볼륨 크기에 맞춰 실제 파일 시스템 리사이징

---

#### 2. VirtualBox 가상 디스크 크기 조정

먼저 가상 머신을 종료한 후, 실제 디스크 파일의 크기를 늘려줍니다.

* **설정 경로:** [파일] → [가상 미디어 관리자]
* **작업 내용:** 해당 `.vdi` 파일을 선택하고 하단의 크기 슬라이더를 조정하여 원하는 용량(예: 50GB → 100GB)으로 변경한 후 **[적용]**을 클릭합니다.

---

#### 3. 리눅스 LVM 파티션 확장 실습

디스크 크기를 늘린 후 가상 머신을 부팅하여 아래 명령어를 순차적으로 실행합니다.

**① 물리 볼륨(PV) 확장**
커널이 인식한 물리 파티션의 크기 변경을 LVM에 알립니다.

```bash
df -hT

sudo pvresize /dev/sda3

```

* **결과 확인:** `Physical volume "/dev/sda3" changed` 메시지가 출력되어야 합니다.

**② 볼륨 그룹(VG) 및 논리 볼륨(LV) 확장**
볼륨 그룹의 남은 여유 공간을 모두 루트(`/`) 논리 볼륨에 할당합니다.

```bash
# 볼륨 그룹 여유 공간(VFree) 확인
sudo vgs

# 논리 볼륨을 100% 여유 공간만큼 확장
sudo lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv

```

**③ 파일 시스템 리사이징 (최종 반영)**
실제 운영체제가 사용하는 파일 시스템이 늘어난 공간을 사용하도록 동기화합니다.

```bash
# ext4 파일 시스템인 경우
sudo resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv

# xfs 파일 시스템인 경우
sudo xfs_growfs /

```

---

#### 4. 시스템 정보 확인 및 문제 해결

`/etc/fstab`은 마운트 정보를 담을 뿐 용량 정보를 직접 기록하지 않습니다. 따라서 상세 정보를 확인하려면 아래 방법들을 활용합니다.

* **상세 할당 정보 확인:** `/etc/lvm/backup/` 디렉토리 내의 볼륨 그룹 파일을 통해 텍스트 형태로 확인 가능합니다.
* **트리 구조 확인:** `lsblk -f` 명령어를 사용하여 파티션과 LVM, 마운트 지점을 한눈에 파악합니다.
* **실시간 용량 확인:** `df -h`를 통해 최종적으로 루트(`/`) 파티션의 크기가 정상 반영되었는지 점검합니다.

> **실전 팁:** > LVM은 **'유연한 그릇'**과 같습니다. `pvresize`는 그릇의 재료를 늘리는 것이고, `lvextend`는 그릇의 크기를 키우는 것이며, `resize2fs`는 그 안에 담긴 내용물을 구석까지 펴주는 작업입니다. 이 세 단계 중 하나라도 누락되면 용량 확장이 완성되지 않습니다.

---

**Next Step: LVM 스냅샷을 활용한 데이터 백업 및 복구 전략**

수정 요청 시 해당 부분만 즉시 반영해 드립니다. 깃허브 등 웹 페이지에 바로 활용할 수 있는 마크다운 포맷입니다.

---

## 1. 현재 상태 확인


```bash
df -h

```

출력 내용 중 `/dev/mapper/ubuntu--vg-ubuntu--lv` (이름은 약간 다를 수 있음)가 루트(`/`)에 마운트되어 있고, 용량이 예상보다 적은지 확인하세요.

그 다음, 볼륨 그룹에 남은 여유 공간이 있는지 확인합니다.

```bash
sudo vgs

```

`VFree` 항목에 남은 용량(약 25G 등)이 표시된다면 아래 과정을 진행하면 됩니다.

---

## 2. 논리 볼륨(LV) 확장

볼륨 그룹의 남은 모든 공간을 해당 논리 볼륨에 할당합니다.

```bash
sudo lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv

```

> **Tip:** `/dev/mapper/...` 경로는 위 `df -h`에서 확인한 본인의 루트 파일 시스템 경로를 입력하세요.

---

## 3. 파일 시스템 사이즈 재조정 (Resize)

볼륨의 크기는 커졌지만, 실제 파일 시스템이 이를 인식하도록 리사이징해야 합니다. (Ubuntu 기본인 ext4 기준)

```bash
sudo resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv

```

*만약 파일 시스템이 XFS라면 `sudo xfs_growfs /` 명령어를 사용해야 합니다.*

---

## 4. 최종 결과 확인

이제 다시 용량을 확인해 보면 50GB 전체가 반영된 것을 볼 수 있습니다.

```bash
df -h

```

---

### 💡 실전 팁: 왜 이런 일이 발생하나요?

Ubuntu 서버 설치 프로그램(Subiquity)은 LVM을 사용할 때 만약의 상황(스냅샷, 다른 파티션 추가 등)을 대비해 **전체 용량의 절반만 할당하는 것을 기본값**으로 제안합니다.

가상 머신(VM) 운영 중 디스크 용량이 부족할 때, 설정을 통해 물리적인 디스크 크기를 키우고 이를 OS 내부 파티션에 반영하는 과정을 단계별로 정리해 드립니다.

이 작업은 크게 **1) 가상 머신 설정(S/W)에서 디스크 확장**, **2) 게스트 OS(Linux) 내부에서 파티션 확장** 두 단계로 나뉩니다.

---

## 1. VirtualBox 설정에서 디스크 용량 늘리기

먼저 가상 머신이 **종료된 상태**여야 합니다.

1. VirtualBox 관리자 화면 상단 메뉴에서 **[파일] -> [가상 미디어 관리자]**를 클릭합니다.
2. 목록에서 해당 가상 머신의 가상 디스크(`.vdi` 또는 `.vmdk`)를 선택합니다.
3. 하단의 **[크기]** 슬라이더를 조절하거나 숫자를 직접 입력하여 원하는 용량(예: 100.00 GB)으로 변경한 후 **[적용]**을 누릅니다.
4. 가상 머신 **[설정] -> [저장소]**에서 해당 디스크의 정보가 변경된 용량으로 표시되는지 확인합니다.

---

## 2. 게스트 OS(Ubuntu) 파티션 확장

디스크의 물리적 크기만 늘어난 상태이므로, OS 내부에서 이 '할당되지 않은 공간'을 실제 파티션에 합쳐줘야 합니다.

### 방법 A: GUI 도구(GParted) 사용 (추천)

가장 시각적이고 안전한 방법입니다.

1. 터미널에서 `sudo apt install gparted -y && sudo gparted`를 실행합니다.
2. 오른쪽 끝에 회색으로 된 **[unallocated]** 공간이 보입니다.
3. 확장하고자 하는 파티션(보정 `/dev/sda3` 또는 `lvm` 등)을 오른쪽 클릭하고 **[Resize/Move]**를 선택합니다.
4. 화살표를 끝까지 드래그하여 여유 공간을 모두 포함시킨 후 **[Resize]**를 누릅니다.
5. 상단 체크 아이콘(**[Apply All Operations]**)을 클릭하여 확정합니다.

### 방법 B: CLI 명령어로 확장 (LVM 환경)

지난번처럼 LVM을 사용 중이라면 명령어로 간단히 가능합니다.

1. **물리 볼륨(PV) 확장:** 늘어난 디스크 크기를 LVM이 인식하게 합니다.
```bash
sudo pvresize /dev/sda3  # 본인의 물리 파티션 번호 확인 필요

```


2. **논리 볼륨(LV) 확장:** 볼륨 그룹의 남은 공간을 루트 볼륨에 할당합니다.
```bash
sudo lvextend -l +100%FREE /dev/mapper/ubuntu--vg-ubuntu--lv

```


3. **파일 시스템 리사이징:**
```bash
sudo resize2fs /dev/mapper/ubuntu--vg-ubuntu--lv

```



---

### ⚠️ 주의사항 및 실전 팁

* **백업 필수:** 파티션을 건드리는 작업이므로 중요 데이터가 있다면 가상 머신 복제(Clone)나 스냅샷을 먼저 생성하세요.
* **유료 서비스 안내:** VirtualBox 자체는 오픈소스이나, 클라우드 환경(AWS EBS 등)에서 이와 같이 디스크 용량을 추가할 경우 **추가된 용량만큼 기가바이트(GB)당 월간 비용이 즉시 발생**하므로 주의가 필요합니다.
* **고정 크기 vs 동적 할당:** 디스크 생성 시 '고정 크기'로 만들었다면 확장 시간이 오래 걸릴 수 있습니다.

---
### 확장이 안될때
---

### 1단계: 파티션 크기 조정 (growpart 사용)

현재 디스크(`sda`)의 전체 용량은 늘어났지만, 2번 파티션(`sda2`)은 여전히 예전 크기에 갇혀 있습니다. `cloud-guest-utils` 패키지에 포함된 `growpart` 도구를 사용하는 게 가장 간편합니다.

1. **도구 설치** (설치되어 있지 않다면):
```bash
sudo apt update && sudo apt install -y cloud-guest-utils

```


2. **파티션 확장**: `sda` 디스크의 2번 파티션을 확장하겠다는 명령입니다.
```bash
sudo growpart /dev/sda 2

```


*(성공하면 "CHANGED"라는 메시지가 뜹니다.)*

### 2단계: 파일 시스템 확장 (resize2fs 사용)

파티션이라는 "그릇"은 커졌지만, 그 안의 `ext4`라는 "내용물"은 아직 예전 크기를 기억하고 있습니다.

1. **파일 시스템 확장**:
```bash
sudo resize2fs /dev/sda2

```



### 3단계: 확인

이제 용량이 제대로 반영되었는지 확인합니다.

```bash
df -hT /

```

`/dev/sda2`의 Size가 늘어났다면 성공입니다!

---

### 💡 왜 `vgs`나 `pvresize`가 안 됐나요?

현재 시스템은 **LVM(Logical Volume Management)**을 사용하지 않고 있습니다.

* **LVM 사용 시:** `Disk` -> `Partition` -> `PV` -> `VG` -> `LV` -> `FS` 순서로 구성됨.
* **현재 상태:** `Disk` -> `Partition` -> `FS` (바로 연결됨).

따라서 LVM 관련 명령어인 `pvresize`, `vgs`, `lvextend` 등은 현재 시스템에서 동작하지 않는 것이 정상입니다.

---

**혹시 위 과정에서 `growpart` 명령 실행 시 오류가 발생하나요?** 오류 메시지를 알려주시면 다른 방법(예: `fdisk`를 이용한 수동 조정)을 안내해 드릴게요.
