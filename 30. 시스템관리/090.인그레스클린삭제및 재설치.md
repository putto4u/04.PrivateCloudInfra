## 인그레스(Ingress) 컨트롤러 클린 삭제 및 재설치 가이드

쿠버네티스 운영 중 인그레스 컨트롤러 설정이 꼬이거나 업그레이드가 실패했을 때, 단순히 리소스를 삭제하는 것만으로는 해결되지 않는 경우가 많습니다. 시스템에 남아있는 잔재를 완전히 제거하고 깨끗한 상태로 복구하는 절차를 기술합니다.

---

### 1. 인그레스 컨트롤러 완전 삭제 절차

단순 삭제 명령(`kubectl delete`) 이후에도 클러스터 수준의 설정이 남아 설치를 방해할 수 있으므로 다음 순서를 반드시 준수합니다.

#### 1) 배포 도구에 따른 삭제

* **Helm 사용 시:**
```bash
helm uninstall ingress-nginx -n ingress-nginx

```


* **Manifest(YAML) 사용 시:**
```bash
kubectl delete -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.x.x/deploy/static/provider/cloud/deploy.yaml

```

```
# 1. 존재하는 IngressClass 확인
kubectl get ingressclass

# 2. 충돌나는 'nginx' 클래스 강제 삭제
kubectl delete ingressclass nginx


#### 2) 클러스터 수준의 잔재(Validating Webhook) 제거

가장 빈번하게 발생하는 '꼬임'의 원인입니다. 컨트롤러가 삭제되어도 문법 검사기(Webhook) 설정이 남아서 이후 모든 `Ingress` 생성 요청을 차단하게 됩니다.
```


```bash
# 잔재 확인
kubectl get validatingwebhookconfigurations

# nginx 관련 웹훅 강제 삭제
kubectl delete validatingwebhookconfiguration ingress-nginx-admission

```

#### 3) 네임스페이스 및 RBAC 정리

컨트롤러가 사용하던 권한과 네임스페이스를 완전히 정리하여 충돌 가능성을 제거합니다.

```bash
kubectl delete namespace ingress-nginx
kubectl delete clusterrole ingress-nginx
kubectl delete clusterrolebinding ingress-nginx

```

---

### 2. 리소스 삭제 무한 대기 해결 (Finalizers)

특정 인그레스 리소스가 `Terminating` 상태에서 멈춰 삭제되지 않을 경우, 메타데이터의 `finalizers`를 강제로 제거하여 즉시 정리합니다.

```bash
# 특정 인그레스 리소스 강제 삭제
kubectl patch ingress <인그레스_이름> -p '{"metadata":{"finalizers":null}}' --type merge

```

---

### 3. 클린 재설치 및 검증

재설치 시에는 이전 환경과의 호환성을 위해 `IngressClass` 이름을 명확히 지정하는 것이 중요합니다.

#### 1) 인그레스 컨트롤러 재설치 (Helm 기준)

```bash
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --create-namespace

```

#### 2) 설치 상태 확인 (Health Check)

```bash
# 컨트롤러 파드 실행 여부 확인
kubectl get pods -n ingress-nginx

# 서비스 할당 확인 (AWS 환경일 경우 External-IP 확인)
kubectl get svc -n ingress-nginx

```

---

### 4. 재설치 후 연동 확인 (Troubleshooting)

재설치가 완료된 후, 기존에 배포되어 있던 `Ingress` 리소스들이 새로운 컨트롤러를 정상적으로 바라보는지 확인합니다.

* **IngressClass 일치 여부:** 새 컨트롤러의 `IngressClass`와 기존 리소스의 `spec.ingressClassName`이 일치해야 합니다.
* **Admission Webhook 정상 작동:** 신규 `Ingress` 생성 시 웹훅 에러(`failed calling webhook`)가 발생하지 않는지 체크합니다.

---

> **AWS 환경 보안 및 과금 주의**
> * **ELB 수동 삭제:** `LoadBalancer` 타입의 서비스를 삭제해도 AWS 콘솔에 로드밸런서(NLB/ALB) 잔재가 남을 수 있습니다. 반드시 AWS 콘솔에서 해당 자원이 삭제되었는지 확인하여 불필요한 과금을 방지하십시오.
> * **보안 그룹(SG):** 재설치 시 서비스의 NodePort가 변경되면, 호스트 PC나 AWS 보안 그룹에서 해당 포트의 허용 규칙을 다시 업데이트해야 할 수 있습니다.
> 
> 

---

**Next Step: Ingress Controller 고가용성(HA) 구성 및 운영 최적화**

* ReplicaSet 개수 조정
* Pod Anti-Affinity 설정
* 리소스 쿼터(Resource Quota) 할당 최적화
