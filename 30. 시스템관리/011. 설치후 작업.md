# Prometheus 서비스 노출 및 외부 접속 구성

Prometheus의 'All-in-One' 설치 직후에는 기본적으로 클러스터 내부에서만 통신이 가능한 `ClusterIP` 타입으로 설정되어 있습니다. 대시보드 접근 및 데이터 시각화를 위해 외부 네트워크에서 접근할 수 있도록 Service Type을 변경하고 네트워크 보안 설정을 구성해야 합니다.

---

### 1. Service 상태 및 기본 설정 확인

설치된 Prometheus 서비스의 현재 노출 방식을 확인합니다. 쿠버네티스 환경에서 보안을 위해 기본값은 외부 접속이 차단된 상태입니다.

```bash
# 모니터링 네임스페이스의 서비스 목록 조회
kubectl get svc -n monitoring

```

**출력 예시 분석:**

* **TYPE:** `ClusterIP` (기본값, 외부 접속 불가)
* **PORT(S):** `9090/TCP`

---

### 2. 접속 환경 구성 (Service Exposure)

운영 환경과 목적에 따라 다음 세 가지 방식 중 하나를 선택하여 구성합니다.

#### 방식 A: LoadBalancer (AWS 권장 / 운영 환경)

AWS의 로드 밸런서(CLB/NLB)를 자동으로 프로비저닝하여 공인 IP 또는 도메인을 할당받습니다.

**설정 명령:**

```bash
kubectl patch svc prometheus-k8s -n monitoring -p '{"spec": {"type": "LoadBalancer"}}'

```

*(참고: 서비스명 `prometheus-k8s`는 설치한 헬름 차트나 매니페스트에 따라 다를 수 있으므로 `kubectl get svc`로 확인된 이름을 사용하십시오.)*

> **[AWS Cost Warning]**
> `LoadBalancer` 타입으로 변경 시 AWS ELB(Elastic Load Balancer)가 생성되며, 사용 시간 및 트래픽 양에 따라 **즉시 시간당 과금이 발생**합니다. 실습 후에는 반드시 삭제하거나 타입을 변경해야 비용을 절감할 수 있습니다.

#### 방식 B: NodePort (테스트 / 비용 절감)

별도의 로드 밸런서 없이 워커 노드의 IP와 특정 포트(30000-32767)를 통해 직접 접속합니다.

**설정 명령:**

```bash
kubectl patch svc prometheus-k8s -n monitoring -p '{"spec": {"type": "NodePort"}}'

```

**접속 주소 확인:**

```bash
kubectl get svc -n monitoring
# 출력 예: 9090:31234/TCP -> http://<Node-Public-IP>:31234 로 접속

```

#### 방식 C: Port-Forwarding (임시 디버깅 / 로컬 개발)

설정 변경 없이 로컬 PC에서 보안 터널을 통해 잠시 접속할 때 사용합니다.

**실행 명령:**

```bash
# 로컬 9090 포트를 파드의 9090 포트로 포워딩
kubectl port-forward svc/prometheus-k8s 9090:9090 -n monitoring

```

* 브라우저 접속: `http://localhost:9090`

---

### 3. AWS 보안 그룹(Security Group) 설정

서비스 구성을 변경했더라도 AWS 인프라 레벨의 방화벽인 보안 그룹(Security Group)이 닫혀 있으면 접속할 수 없습니다.

| 접속 방식 | 설정 대상 | 인바운드 규칙 (Inbound Rule) 추가 |
| --- | --- | --- |
| **LoadBalancer** | ELB 보안 그룹 | **TCP 9090** (Source: 내 IP 또는 0.0.0.0/0) |
| **NodePort** | Worker Node 보안 그룹 | **TCP 30000-32767** (Source: 내 IP) |
| **EC2 직접 설치** | EC2 인스턴스 보안 그룹 | **TCP 9090** (Source: 내 IP) |

**체크 포인트:**

1. AWS 콘솔 > EC2 > Security Groups로 이동합니다.
2. 해당 리소스에 연결된 보안 그룹을 선택합니다.
3. `Inbound rules` 탭에서 `Edit inbound rules`를 클릭하여 포트를 개방합니다.

---

### 4. 접속 확인 및 초기 대시보드 점검

설정이 완료되면 브라우저를 통해 Prometheus UI에 접속합니다.

1. **Status > Targets** 메뉴로 이동합니다.
2. 현재 Prometheus가 메트릭을 수집하고 있는 대상(Node Exporter, cAdvisor 등)의 상태가 `UP`인지 확인합니다.
3. `State`가 `DOWN`인 경우 네트워크 정책이나 방화벽 문제를 의심해야 합니다.

---

Next Step: node-exporter 연동 및 메트릭 수집 기초

---

**[User Guide]**
