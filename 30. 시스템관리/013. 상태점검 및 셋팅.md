Prometheus 웹 UI(9090 포트) 접속부터 Grafana 대시보드 구성까지, 전체적인 모니터링 시스템 구축 과정을 단계별 교재 형식으로 정리해 드립니다.

---

## 1. 모니터링 아키텍처 이해

데이터는 **[대상 서버(Node Exporter)] → [수집기(Prometheus)] → [시각화(Grafana)]** 순서로 흐릅니다. 9090 접속이 안 된다면 수집기 자체가 실행 중이지 않거나 네트워크 설정(방화벽) 문제일 가능성이 큽니다.

---

## 2. 1단계: Prometheus 및 Node Exporter 상태 점검

가장 먼저 데이터가 생성되고 수집되는지 확인해야 합니다.

### ① 서비스 실행 상태 확인 (Linux 기준)

각 서버에서 서비스가 활성화되어 있는지 확인합니다.

```bash
# Prometheus 상태 확인
sudo systemctl status prometheus

# Node Exporter(데이터 생성기) 상태 확인
sudo systemctl status node_exporter

```

* 만약 `Inactive` 상태라면 `sudo systemctl start <서비스명>`으로 시작하세요.

### ② 방화벽 포트 개방 (접속 불가 해결)

9090 접속이 안 되는 가장 큰 원인은 방화벽입니다.

```bash
# Ubuntu (UFW) 기준
sudo ufw allow 9090/tcp  # Prometheus
sudo ufw allow 9100/tcp  # Node Exporter
sudo ufw allow 3000/tcp  # Grafana

```

* **AWS 환경 주의:** 인스턴스의 **보안 그룹(Security Group)**에서 위 포트들이 사용자 IP에 대해 인바운드 허용되어 있는지 반드시 확인하세요.

---

## 3. 2단계: Prometheus에서 Target 연결 확인

9090 포트로 접속이 성공했다면, Prometheus가 각 노드의 데이터를 가져오고 있는지 확인합니다.

1. 웹 브라우저에서 `http://<서버IP>:9090` 접속.
2. 상단 메뉴 **Status → Targets** 클릭.
3. `Endpoint` 목록의 상태가 모두 **UP**인지 확인합니다.
* **DOWN**인 경우: `/etc/prometheus/prometheus.yml` 파일의 `static_configs`에 대상 IP와 9100 포트가 정확히 적혔는지 확인하세요.



---

## 4. 3단계: Grafana 데이터 소스 연결 및 패널 생성

이제 Prometheus의 데이터를 Grafana로 가져와 시각화합니다.

### ① Data Source 등록

1. `http://<서버IP>:3000` 접속 (초기 ID/PW: admin/admin).
2. **Connections → Data Sources → Add data source** 클릭.
3. **Prometheus** 선택 후 URL에 `http://<Prometheus_서버_IP>:9090` 입력.
4. 하단의 **Save & Test**를 눌러 녹색 체크 표시가 뜨는지 확인합니다.

### ② 각 노드 상태 패널(Dashboard) 올리기

직접 만드는 것보다 검증된 템플릿을 사용하는 것이 효율적입니다.

1. 왼쪽 메뉴 **Dashboards → New → Import** 클릭.
2. **Import via grafana.com** 항목에 `1860` (Node Exporter Full 대시보드 번호) 입력 후 **Load**.
3. 데이터 소스 선택 창에서 방금 만든 **Prometheus**를 선택하고 **Import**.

---

## 5. 실전 확인 사항 (Troubleshooting)

| 현상 | 원인 | 해결책 |
| --- | --- | --- |
| **9090 접속 불가** | 서비스 중단 또는 방화벽 | `systemctl start` 및 보안 그룹/UFW 포트 허용 |
| **Grafana No Data** | 쿼리 오류 또는 시간 불일치 | 우측 상단 시간 범위를 `Last 1 hour` 등으로 조정 |
| **Target DOWN** | Node Exporter 미실행 | 대상 서버에서 9100 포트 프로세스 확인 |

---

### 💡 실전 팁

수강생들에게 **"모니터링의 기본은 포트 확인"**임을 강조해 주세요.

* **9090:** Prometheus (창고)
* **9100:** Node Exporter (물건 생산)
* **3000:** Grafana (전시장)

### AWS 환경 과금 안내

AWS에서 실습 시, `Public IP`를 통해 데이터를 수집하면 **데이터 전송 요금(Data Transfer Out)**이 발생할 수 있습니다. 가급적 같은 VPC 내에서 **Private IP**를 사용하여 통신하도록 설정하는 것이 비용 절감에 유리합니다.

---

**Next Step: 커스텀 PromQL을 활용한 개별 지표 패널 제작 방법**

* 현재 설정 중인 `prometheus.yml` 설정값이나 특정 에러 로그가 있다면 공유해 주세요. 즉시 교정해 드리겠습니다.

----
`prometheus.service` 유닛을 찾을 수 없다는 에러는 서비스 파일이 시스템 경로에 등록되지 않았거나, 프로메테우스가 바이너리 실행 파일 형태로만 존재하고 서비스 등록이 누락되었을 때 발생합니다.

쿠버네티스 워커 노드(`wknode02`) 환경에서 프로메테우스 서비스 상태를 점검하고 해결하는 절차를 정리합니다.

---

## 1. 설치 경로 및 실행 파일 확인

먼저 프로메테우스가 시스템에 설치되어 있는지, 그리고 어디에 위치해 있는지 확인해야 합니다.

* **바이너리 위치 검색**:
```bash
which prometheus
# 또는
find / -name prometheus -type f 2>/dev/null

```


* **일반적인 경로**: 보통 `/usr/local/bin/prometheus` 또는 특정 설치 폴더(예: `/opt/prometheus/`)에 위치합니다.

## 2. 서비스 파일 유무 확인

`systemctl`이 인식하는 서비스 설정 파일(`.service`)이 실제 경로에 존재하는지 확인합니다.

* **조회 명령**:
```bash
ls -l /etc/systemd/system/prometheus.service
ls -l /lib/systemd/system/prometheus.service

```



파일이 없다면 서비스가 등록되지 않은 상태이므로 수동으로 생성해야 합니다.

## 3. prometheus.service 파일 생성 및 등록

프로메테우스 실행 경로가 `/usr/local/bin/`이라고 가정할 때, 아래 절차로 서비스를 등록합니다.

### 서비스 파일 작성

`/etc/systemd/system/prometheus.service` 파일을 생성하고 다음 내용을 입력합니다.

```ini
[Unit]
Description=Prometheus
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
    --config.file=/etc/prometheus/prometheus.yml \
    --storage.tsdb.path=/var/lib/prometheus/ \
    --web.console.templates=/etc/prometheus/consoles \
    --web.console.libraries=/etc/prometheus/console_libraries

[Install]
WantedBy=multi-user.target

```

### 서비스 활성화 및 시작

파일을 저장한 후 시스템 데몬을 재로드하고 서비스를 시작합니다.

```bash
# 1. systemd 데몬 재로드
sudo systemctl daemon-reload

# 2. 서비스 시작 및 부팅 시 자동 실행 설정
sudo systemctl enable --now prometheus

# 3. 상태 확인
sudo systemctl status prometheus

```

---

## 실전 점검 팁

* **컨테이너 실행 여부**: 만약 프로메테우스를 `docker`나 `podman` 또는 쿠버네티스 `pod`으로 띄운 경우라면 `systemctl`에는 나타나지 않습니다. `sudo docker ps` 명령어로 확인해 보세요.
* **사용자 계정**: 위 설정 파일에서 `User=prometheus`를 사용하려면 해당 계정이 시스템에 생성되어 있어야 합니다 (`sudo useradd --no-create-home --shell /bin/false prometheus`).

> [!IMPORTANT]
> **AWS 환경 주의사항**: 프로메테우스 서버가 AWS EC2 인스턴스에서 구동 중이고 9090 포트를 통해 웹 UI에 접속해야 한다면, **보안 그룹(Security Group)** 설정에서 해당 포트(TCP 9090) 인바운드 규칙이 허용되어 있는지 확인하세요. 별도의 비용은 발생하지 않으나 설정 누락 시 외부 접속이 불가능합니다.

---

Next Step: **systemd 서비스 유닛 설정 최적화 및 프로메테우스 보안 설정**

요청하신 대로 특정 부분의 수정이 필요하면 말씀해 주세요. 해당 내용만 즉시 수정해 드리겠습니다.

