## Chapter 4. 쿠버네티스 리소스 관리 및 최적화

### 4.2. 디스크 효율 극대화: Kubelet Eviction(축출) 정책 최적화

쿠버네티스 운영 중 가장 빈번하게 겪는 오해 중 하나는 "물리적인 디스크 공간이 남았는데 파드가 축출(Evicted)되는 현상"입니다. 이는 리눅스 파일시스템(LVM)의 구조와 쿠버네티스(Kubelet)의 보수적인 기본 설정이 충돌하여 발생하는 문제입니다. 본 섹션에서는 하드웨어 자원이 제한적인 예비 서버(수강생 PC) 환경에서 디스크 공간을 낭비 없이 100%에 가깝게 활용하기 위한 **Eviction 임계값(Threshold)** 수정 방법을 학습합니다.

---

### 1. Eviction(축출) 발생 원리 분석

쿠버네티스 노드 에이전트인 **Kubelet**은 주기적으로 노드의 자원 상태를 모니터링하며, 특정 임계값에 도달하면 파드를 강제로 종료하여 노드의 안정성을 확보합니다. 이를 **Node-pressure Eviction**이라 합니다.

#### 1.1. Kubelet의 시야 (View)

Kubelet은 물리적인 디스크 전체(예: `/dev/sda`)를 보지 않습니다. 오직 컨테이너 런타임과 Kubelet이 데이터를 저장하는 **파일시스템(Filesystem)의 마운트 지점**만을 인식합니다.

> **[실제 사례 분석]**
> * **물리 디스크:** 80GB 장착
> * **OS 설치(LVM 기본값):** 40GB만 할당 (`/`), 나머지 40GB는 미할당 상태
> * **Kubelet 인식 용량:** **40GB** (80GB가 아님)
> 
> 

#### 1.2. 기본 임계값의 함정 (The 10% Rule)

쿠버네티스의 기본 설정(`evictionHard`)은 디스크의 **여유 공간이 10% 미만**일 때 작동합니다.

위 사례(40GB 할당)에 대입하면 다음과 같습니다.

* **위험 감지 시점:** 남은 용량이 **4GB** 미만일 때
* **결과:** 사용자는 디스크가 아직 4GB나 남았다고 생각하지만, 쿠버네티스는 이를 '시스템 붕괴 직전'으로 판단하여 파드를 축출합니다.

---

### 2. Kubelet 설정 변경: 디스크 100% 활용 전략

낭비되는 공간을 줄이고 가용 용량을 끝까지 사용하기 위해, 퍼센트(%) 기반의 설정을 **절대값(Byte)** 기반의 설정으로 변경하여 임계값을 낮춥니다.

**작업 대상:** 모든 예비 서버(Worker Node)

#### 2.1. 설정 파일 수정 (`config.yaml`)

대부분의 클러스터(kubeadm 배포 기준)에서 Kubelet 설정 파일은 `/var/lib/kubelet/config.yaml`에 위치합니다.

1. 편집기로 설정 파일을 엽니다.
```bash
sudo vi /var/lib/kubelet/config.yaml

```


2. `evictionHard` 항목을 찾아 아래와 같이 수정하거나, 해당 항목이 없다면 파일의 끝부분에 추가합니다.
**[수정 전 (기본값, 명시되어 있지 않을 수 있음)]**
```yaml
evictionHard:
  memory.available: "100Mi"
  nodefs.available: "10%"
  nodefs.inodesFree: "5%"
  imagefs.available: "15%"

```


**[수정 후 (권장 설정)]**
```yaml
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration
# ... (기존 설정 유지) ...

# [변경 핵심] 퍼센트가 아닌 절대 용량으로 설정하여 낭비를 최소화
evictionHard:
  imagefs.available: "500Mi"   # 이미지 파일시스템이 500MB 남을 때까지 버팀
  nodefs.available: "500Mi"    # 노드 파일시스템이 500MB 남을 때까지 버팀
  nodefs.inodesFree: "1%"      # 아이노드(파일 개수)는 1% 여유 둠
  memory.available: "100Mi"

```



#### 2.2. 서비스 재시작 및 적용 확인

설정을 변경한 후 Kubelet 서비스를 재시작해야 반영됩니다.

```bash
# 서비스 재시작
sudo systemctl restart kubelet

# 적용 상태 확인 (DiskPressure 상태가 False인지 확인)
kubectl describe node <노드이름> | grep Pressure

```

---

### 3. 주의사항: 왜 0%로 설정하지 않는가?

"100% 활용"을 목표로 하더라도, 설정값을 `0%` 또는 `0Mi`로 설정해서는 안 됩니다. 운영체제(Linux)는 구동을 위해 최소한의 여유 공간을 필요로 합니다.

* **SSH 접속 불가:** 로그를 기록할 공간(몇 KB)이 없으면 SSH 데몬이 접속을 거부합니다.
* **명령어 실행 불가:** 탭 자동완성(Tab-completion)이나 임시 파일 생성이 실패하여 `ls`, `vi` 같은 기본 명령어도 작동하지 않게 됩니다.
* **시스템 멈춤(Hang):** OS가 완전히 멈추어 강제 재부팅 외에는 방법이 없게 됩니다.

> **전문가 Tip:**
> 실무 환경이나 학습 환경 모두 **최소 500Mi ~ 1Gi**의 여유 공간은 'OS 호흡기'로서 남겨두어야 합니다. 이는 시스템이 완전히 락다운(Lock-down)되는 것을 방지하는 최후의 안전장치입니다.

---

**Next Step:** 스트레스 테스트 도구(Stress)를 이용한 디스크 임계값 검증 실습
