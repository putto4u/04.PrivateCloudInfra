# Chapter 5. 프로메테우스(Prometheus) 모니터링 시스템 구축 및 활용

## 1. 개요

프로메테우스(Prometheus)는 SoundCloud에서 처음 개발된 오픈 소스 모니터링 및 경고 툴킷이다. 2016년 CNCF(Cloud Native Computing Foundation)에 가입된 두 번째 프로젝트(첫 번째는 Kubernetes)로, 현재 클라우드 네이티브 환경에서 사실상의 표준 모니터링 솔루션으로 자리 잡았다.

### 1.1 주요 특징

* **다차원 데이터 모델:** 시계열(Time Series) 데이터를 메트릭 이름과 키-값 쌍(Label)으로 식별한다.
* **PromQL:** 유연하고 강력한 쿼리 언어를 제공하여 데이터를 집계하고 분석한다.
* **Pull 방식:** 프로메테우스 서버가 주기적으로 타겟 시스템(Exporter)에 접속하여 메트릭을 수집(Scrape)한다. 이는 Push 방식에 비해 중앙 서버의 부하를 줄이고, 타겟 서비스의 장애가 모니터링 시스템에 영향을 주는 것을 방지한다.
* **자율적인 단일 노드:** 분산 스토리지에 의존하지 않으며, 각 서버는 독립적으로 동작하여 높은 신뢰성을 보장한다.

### 1.2 아키텍처 핵심 컴포넌트

1. **Prometheus Server:** 시계열 데이터를 수집하고 저장하며, PromQL 쿼리를 처리한다.
2. **Client Libraries:** 애플리케이션 코드를 계측(Instrumenting)하기 위한 라이브러리다.
3. **Pushgateway:** 숏텀(Short-lived) 배치 작업의 메트릭을 수신하여 프로메테우스가 수집할 수 있도록 중계한다.
4. **Exporters:** HAProxy, StatsD, Graphite, Linux 시스템 등 타사 시스템의 메트릭을 프로메테우스 포맷으로 변환하여 노출한다. (예: Node Exporter)
5. **Alertmanager:** 경고 규칙에 따라 알림을 그룹화하고, 중복을 제거하며, 이메일, 슬랙(Slack), PagerDuty 등으로 라우팅한다.

---

## 2. 설치 및 환경 구성 (Docker 기반)

실습을 위해 Docker Compose를 사용하여 프로메테우스, 노드 익스포터(Node Exporter), 그라파나(Grafana)를 한 번에 구축한다.

### 2.1 디렉토리 구조

```bash
monitoring/
├── docker-compose.yml
└── prometheus/
    └── prometheus.yml

```

### 2.2 `prometheus.yml` 작성

프로메테우스 서버의 메인 설정 파일이다. 수집 주기(interval)와 수집 대상(target)을 정의한다.

```yaml
# monitoring/prometheus/prometheus.yml
global:
  scrape_interval: 15s # 메트릭 수집 주기 (기본값 1분)
  evaluation_interval: 15s # 규칙 평가 주기

scrape_configs:
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  - job_name: 'node_exporter'
    static_configs:
      - targets: ['node-exporter:9100'] # Docker Network 내부 통신

```

### 2.3 `docker-compose.yml` 작성

```yaml
# monitoring/docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./prometheus/:/etc/prometheus/
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - 9090:9090
    networks:
      - monitoring-net
    restart: always

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command: 
      - '--path.procfs=/host/proc' 
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    ports:
      - 9100:9100
    networks:
      - monitoring-net
    restart: always

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - 3000:3000
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - monitoring-net
    restart: always

networks:
  monitoring-net:

volumes:
  prometheus_data:
  grafana_data:

```

### 2.4 실행

```bash
cd monitoring
docker-compose up -d

```

* **Prometheus UI:** `http://localhost:9090`
* **Grafana UI:** `http://localhost:3000` (초기 계정: admin / admin)

---

## 3. 데이터 조회: PromQL (Prometheus Query Language)

프로메테우스의 핵심은 강력한 쿼리 언어인 PromQL이다. UI의 'Expression' 입력창에서 실행한다.

### 3.1 데이터 타입

1. **Counter:** 계속 증가하기만 하는 누적 값 (예: HTTP 요청 수, 완료된 작업 수). 재시작 시 0으로 초기화된다.
2. **Gauge:** 특정 시점의 값을 나타내며 증가하거나 감소할 수 있다 (예: 메모리 사용량, 현재 온도가, 실행 중인 고루틴 수).
3. **Histogram:** 관측된 값들을 버킷(Bucket) 단위로 구분하여 빈도수를 기록한다.
4. **Summary:** Histogram과 유사하나 클라이언트 측에서 분위수(Quantile)를 미리 계산한다.

### 3.2 기본 쿼리 문법

#### Instant Vector (순간 벡터)

특정 시점의 메트릭 값을 조회한다.

```promql
node_memory_MemTotal_bytes

```

* 결과: 가장 최근에 수집된 메모리 총량 값.

#### Range Vector (범위 벡터)

특정 시간 범위 동안의 메트릭 값들을 조회한다. 대괄호 `[]`를 사용한다.

```promql
node_cpu_seconds_total[5m]

```

* 결과: 최근 5분 동안의 모든 CPU 사용 시간 데이터 포인트. **주의:** 그래프 패널이 아닌 테이블 뷰에서 확인하거나, 함수와 함께 사용해야 한다.

#### Label Filtering (레이블 필터링)

중괄호 `{}`를 사용하여 특정 조건의 데이터를 필터링한다.

* `=`: 일치
* `!=`: 불일치
* `=~`: 정규표현식 일치
* `!~`: 정규표현식 불일치

```promql
# job이 node_exporter이고 mode가 idle이 아닌 데이터 조회
node_cpu_seconds_total{job="node_exporter", mode!="idle"}

```

### 3.3 핵심 연산자 및 함수

#### `rate()` vs `irate()`

Counter 타입 데이터의 초당 변화율을 계산할 때 사용한다.

* **`rate(v[time])`:** 지정된 시간 범위 내의 평균 변화율을 계산한다. 급격한 변화를 부드럽게 표현하므로 일반적인 모니터링 및 알람에 적합하다.
* **`irate(v[time])`:** 범위 내의 마지막 두 데이터 포인트를 기반으로 순간 변화율을 계산한다. 스파이크(Spike)를 감지하는 데 유리하다.

**[예제] 최근 5분간 CPU 사용률 계산 (idle 제외)**

```promql
100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

```

1. `node_cpu_seconds_total{mode="idle"}[5m]`: 최근 5분간 idle 모드의 CPU 시간 데이터 수집.
2. `rate(...)`: 5분간의 초당 증가율 계산.
3. `avg by (instance)`: CPU 코어가 여러 개일 경우 instance 별로 평균 계산.
4. `100 - (...) * 100`: idle 비율을 100분율로 환산 후 전체에서 뺌 = 사용률.

---

## 4. 실전 활용 팁

### 4.1 그라파나 연동 (Visualization)

프로메테우스 자체 UI는 디버깅 용도이며, 시각화는 그라파나를 사용한다.

1. **Data Source 추가:**
* Grafana 접속 -> Configuration -> Data Sources -> Add data source -> Prometheus 선택.
* URL: `http://prometheus:9090` (Docker Network 내부 DNS 사용).


2. **대시보드 가져오기 (Import):**
* Dashboards -> Import.
* ID 입력: `1860` (Node Exporter Full - 가장 널리 쓰이는 표준 대시보드).
* Load 클릭 후 Data Source를 위에서 만든 Prometheus로 선택.



### 4.2 카디널리티(Cardinality) 관리 주의

* **문제:** Label의 값(Value) 종류가 너무 많으면 메모리 사용량이 급증한다.
* **안티 패턴:** 사용자 ID, 이메일 주소, 요청별 고유 ID 등을 Label 값으로 사용하는 것.
* **해결:** Label은 유한한 집합(HTTP Method, Status Code, Instance ID 등)에 대해서만 사용해야 한다.

### 4.3 데이터 보존 기간 설정

기본적으로 프로메테우스는 데이터를 15일간 보존한다. 디스크 용량을 고려하여 실행 옵션을 조정해야 한다.

* 옵션: `--storage.tsdb.retention.time=30d` (30일 보존)
* 옵션: `--storage.tsdb.retention.size=50GB` (50GB 도달 시 오래된 데이터 삭제)

---

**Next Step:**
Alertmanager를 활용한 임계치 기반 슬랙(Slack) 알림 설정 및 라우팅 구성 방법
