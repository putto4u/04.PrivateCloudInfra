---

## 2단계: 통합 환경 설정 및 업데이트 배포 (Configuration & Link)

모든 인프라가 구축된 후, 각 계층을 연결할 설정값(ConfigMap/Secret)을 배포하고 Deployment를 업데이트합니다.

### **04-cluster-config-all.yaml**

```yaml
# 04-cluster-config-all.yaml
# 설명: 전체 서비스를 연결할 네트워크 및 보안 정보 세트입니다.
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-total-config
data:
  BACKEND_URL: "http://backend-service:5000"
  DB_HOST: "mariadb-service"
  DB_NAME: "employees"
---
apiVersion: v1
kind: Secret
metadata:
  name: cluster-total-auth
stringData:
  DB_PASSWORD: "password123"
  DB_USER: "root"

```

### **05-app-link-update.yaml**

기존에 배포된 프론트엔드와 백엔드에 설정을 주입하여 실제 통신이 가능하도록 업데이트합니다.

```yaml
# 05-app-link-update.yaml
# 설명: 프론트엔드는 백엔드로, 백엔드는 DB로 연결되도록 설정을 주입합니다.

# [Frontend 업데이트] Nginx가 백엔드로 요청을 전달하도록 설정
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  template:
    spec:
      containers:
      - name: nginx-frontend
        env:
        - name: BACKEND_API_URL
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: BACKEND_URL } }
---
# [Backend 업데이트] Flask가 DB에 접속하도록 설정
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  template:
    spec:
      containers:
      - name: flask-backend
        env:
        - name: DB_HOST
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: DB_HOST } }
        - name: DB_PASSWORD
          valueFrom: { secretKeyRef: { name: cluster-total-auth, key: DB_PASSWORD } }

```

---

## 3. 작업 절차 및 실행 방법



2. **연결 명세서 배포**: 클러스터에 통합 설정을 등록합니다.
* `kubectl apply -f 04-cluster-config-all.yaml`


3. **서비스 연결 업데이트**: 업데이트 파일을 실행하여 전체 계층을 활성화합니다.
* `kubectl apply -f 05-app-link-update.yaml`


4. **브라우저 확인**: `http://<노드IP>:30001` 접속 후 서비스 동작 확인.

---

## 4. 실무 전문가 팁

* **롤링 업데이트 활용**: 5번 파일 실행 시 서비스 중단 없이 Pod가 하나씩 교체되며 새 설정이 적용됩니다. 이는 무중단 배포의 핵심 기술입니다.
* **환경 변수 확인**: 업데이트 후 특정 Pod에 접속하여(`kubectl exec`) 환경 변수가 잘 들어갔는지(`env | grep DB`) 반드시 확인하십시오.
* **AWS 과금 주의**: 프론트엔드 2대, 백엔드 2대, DB 1대 총 5대의 Pod가 돌아갑니다. **t3.medium** 이하 사양의 인스턴스에서는 메모리 부족(OOM) 현상이 발생할 수 있으니 수강생의 노드 사양을 사전에 점검하십시오.

Next Step: 전체 3-Tier 아키텍처의 트래픽 흐름 모니터링 및 로드밸런싱 검증

---

이번 실습에서는 3-Tier 아키텍처의 최종 단계인 **사용자 인터페이스(UI) 연동**을 진행합니다. Nginx 프론트엔드 서버에 백엔드로 이동하는 버튼을 추가하고, 이 모든 설정을 **ConfigMap**을 통해 동적으로 업데이트하는 과정을 학습합니다.

---

## 챕터: 프론트엔드 UI 업데이트 및 백엔드 연동 자동화

인프라가 구축된 상태에서 소스 코드를 수정하지 않고, Kubernetes의 `ConfigMap`과 `VolumeMount`를 활용하여 웹 페이지의 내용을 실시간으로 업데이트하는 고도의 운영 기법을 적용합니다.

### 1. 프론트엔드 커스텀 인덱스 설정 정의

Nginx의 기본 화면을 대신할 HTML 파일과 백엔드로 요청을 넘겨줄 프록시 설정을 정의합니다.

#### **04-frontend-ui-config.yaml**

```yaml
# 04-frontend-ui-config.yaml
# 설명: 웹 화면 구성(HTML)과 백엔드 연결 경로를 정의합니다.

apiVersion: v1
kind: ConfigMap
metadata:
  name: frontend-ui-config
data:
  # 1. 환영 인사 및 백엔드 이동 버튼이 포함된 인덱스 페이지
  index.html: |
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>K8S 3-Tier 실습</title>
        <style>
            body { font-family: sans-serif; text-align: center; padding-top: 50px; }
            .btn { padding: 15px 25px; font-size: 18px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        </style>
    </head>
    <body>
        <h1>환영합니다! IT 전문가 강사님의 K8S 클러스터입니다.</h1>
        <p>현재 프론트엔드 서버(Nginx)가 정상 작동 중입니다.</p>
        <hr>
        <button class="btn" onclick="location.href='/api/status'">APP 서버(백엔드)로 이동</button>
    </body>
    </html>

  # 2. Nginx 역프록시 설정 (브라우저의 /api 요청을 백엔드 서비스로 전달)
  default.conf: |
    server {
        listen 80;
        location / {
            root /usr/share/nginx/html;
            index index.html;
        }
        location /api/ {
            proxy_pass http://backend-service:5000;
        }
    }

```

---

### 2. 프론트엔드 업데이트 배포 (UI 및 경로 주입)

기존에 배포된 `frontend-deployment`에 위에서 정의한 `ConfigMap`을 마운트하여 화면을 교체합니다.

#### **05-frontend-update.yaml**

```yaml
# 05-frontend-update.yaml
# 설명: 기존 프론트엔드에 커스텀 UI와 프록시 설정을 주입하여 업데이트합니다.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx-frontend
        image: nginx:alpine
        ports:
        - containerPort: 80
        volumeMounts:
        # ConfigMap의 내용을 실제 Nginx 경로에 파일로 삽입
        - name: ui-volume
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        - name: proxy-config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
      volumes:
      - name: ui-volume
        configMap:
          name: frontend-ui-config
      - name: proxy-config
        configMap:
          name: frontend-ui-config

```

---

### 3. 작업 절차 및 실행 가이드

1. **인프라 선 구축**: 이전 챕터의 `01-frontend-original.yaml`을 통해 서버를 먼저 띄웁니다.
2. **UI 설정 배포**: 커스텀 HTML과 프록시 설정이 담긴 파일을 실행합니다.
* `kubectl apply -f 04-frontend-ui-config.yaml`


3. **UI 업데이트 적용**: Deployment를 업데이트하여 새 화면을 반영합니다.
* `kubectl apply -f 05-frontend-update.yaml`


4. **웹 브라우저 확인**:
* 접속 주소: `http://<노드IP>:30001`
* 화면 하단의 **"APP 서버(백엔드)로 이동"** 버튼을 클릭하여 백엔드 JSON 데이터가 출력되는지 확인합니다.



---

### 4. 실무 전문가 팁

* **SubPath 활용**: `subPath`를 사용하면 기존 디렉토리의 다른 파일들을 삭제하지 않고 특정 파일만 덮어쓸 수 있어 Nginx 설정 관리에 매우 유용합니다.
* **Rolling Update 모니터링**: 업데이트 시 `kubectl rollout status deployment/frontend-deployment`를 통해 수강생들이 무중단 배포 과정을 직접 확인하게 하십시오.
* **AWS 과금 주의**:
* **NodePort 오픈**: AWS 보안 그룹(Security Group)에서 `30001` 포트를 인바운드 허용해야 브라우저 접속이 가능합니다.
* **ELB 고려**: 실제 운영 환경에서는 `LoadBalancer` 타입을 사용하여 AWS ALB/NLB를 생성하게 되며, 이 경우 시간당 약 **$0.0225** 이상의 비용이 발생하므로 실습 후 반드시 삭제를 안내하십시오.



Next Step: 백엔드 화면에서 DB 연결 정보를 표(Table) 형태로 출력하는 최종 연동 구현

---

Next Step: 백엔드 DB 정보 시각화 구현
