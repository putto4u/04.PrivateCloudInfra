이번 실습은 백엔드(Flask) 서버의 초기 화면을 수정하여, **ConfigMap**에 저장해 두었던 **JOIN SQL(사원/부서/연봉 정보)**의 실행 결과를 웹 브라우저에 출력하는 배포 작업을 진행합니다. 이를 통해 인프라 설정이 애플리케이션 로직에 어떻게 반영되어 최종 사용자에게 전달되는지 학습합니다.

---

## 챕터: 백엔드 DB 결과 출력 화면 업데이트 및 배포

백엔드 서버가 구동될 때 ConfigMap에 정의된 SQL 문을 읽어와 MariaDB에서 데이터를 조회하고, 이를 HTML 표(Table) 형식으로 반환하도록 업데이트합니다.

### 1. 백엔드 로직 업데이트용 설정 정의

백엔드 서버가 실행할 쿼리문을 포함한 기존 `ConfigMap`을 확인하고, 필요한 경우 업데이트합니다.

#### **06-backend-logic-config.yaml**

```yaml
# 06-backend-logic-config.yaml
# 설명: 백엔드에서 사용할 SQL 쿼리와 DB 연결 정보를 정의합니다.

apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-logic-config
data:
  # DB에서 사원번호, 이름, 부서, 연봉을 가져오는 JOIN 쿼리 (이미 정의된 경우 생략 가능)
  GET_EMPLOYEES_SQL: |
    SELECT e.emp_no, e.first_name, d.dept_name, s.salary 
    FROM employees e 
    JOIN dept_emp de ON e.emp_no = de.emp_no 
    JOIN departments d ON de.dept_no = d.dept_no 
    JOIN salaries s ON e.emp_no = s.emp_no 
    WHERE s.to_date = '9999-01-01' 
    ORDER BY s.salary DESC 
    LIMIT 10;

```

---

### 2. 백엔드 서버 업데이트 배포 (로직 주입)

기존 `backend-deployment`에 새로운 환경 변수(`GET_EMPLOYEES_SQL`)를 추가하고, Flask 코드가 이를 실행하여 HTML 표를 렌더링하도록 수정합니다.

#### **07-backend-display-update.yaml**

```yaml
# 07-backend-display-update.yaml
# 설명: 환경변수의 SQL을 실행하여 결과를 표 형식으로 출력하는 업데이트 배포 파일입니다.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: flask-backend
        image: python:3.9-slim
        command: ["python3", "-c"]
        args:
          - |
            from flask import Flask
            import os, mysql.connector
            app = Flask(__name__)

            def get_data():
                # 환경변수에서 정보 로드
                conn = mysql.connector.connect(
                    host=os.getenv('DB_HOST'),
                    user=os.getenv('DB_USER'),
                    password=os.getenv('DB_PASSWORD'),
                    database=os.getenv('DB_NAME')
                )
                cursor = conn.cursor()
                # ConfigMap에서 주입된 SQL 쿼리 실행
                cursor.execute(os.getenv('QUERY'))
                rows = cursor.fetchall()
                conn.close()
                return rows

            @app.route('/api/status')
            def display_employees():
                data = get_data()
                # HTML 표 구성
                html = "<h2>사원 정보 조회 결과 (Top 10 연봉)</h2>"
                html += "<table border='1'><tr><th>사번</th><th>이름</th><th>부서</th><th>연봉</th></tr>"
                for row in data:
                    html += f"<tr><td>{row[0]}</td><td>{row[1]}</td><td>{row[2]}</td><td>{row[3]}</td></tr>"
                html += "</table><br><button onclick='history.back()'>뒤로가기</button>"
                return html

            app.run(host='0.0.0.0', port=5000)
        env:
        - name: DB_HOST
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: DB_HOST } }
        - name: DB_NAME
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: DB_NAME } }
        - name: DB_USER
          valueFrom: { secretKeyRef: { name: cluster-total-auth, key: DB_USER } }
        - name: DB_PASSWORD
          valueFrom: { secretKeyRef: { name: cluster-total-auth, key: DB_PASSWORD } }
        # 핵심: ConfigMap에 정의된 SQL을 환경변수로 주입
        - name: QUERY
          valueFrom: { configMapKeyRef: { name: backend-logic-config, key: GET_EMPLOYEES_SQL } }

```

---

### 3. 작업 절차 및 실행 가이드

1. **쿼리 설정 배포**: SQL 문이 담긴 ConfigMap을 먼저 생성하거나 업데이트합니다.
* `kubectl apply -f 06-backend-logic-config.yaml`


2. **백엔드 화면 업데이트**: 새로운 로직이 포함된 배포 파일을 실행합니다.
* `kubectl apply -f 07-backend-display-update.yaml`


3. **최종 확인**:
* 브라우저에서 `http://<노드IP>:30001` 접속.
* 메인 화면 하단의 **"APP 서버(백엔드)로 이동"** 버튼 클릭.
* MariaDB에서 실시간으로 조회된 **사원번호, 이름, 부서명, 연봉** 데이터가 표 형식으로 출력되는지 확인합니다.



---

### 4. 실무 전문가 팁

* **SQL 관리 전략**: 애플리케이션 코드 안에 SQL을 하드코딩하지 않고 ConfigMap으로 관리하면, 쿼리 최적화나 조건 변경 시 **빌드 없이 재배포(Rolling Update)**만으로 즉시 적용이 가능합니다.
* **보안 강조**: 예제에서는 `root` 계정을 사용했으나, 실무에서는 `02-backend-secret.yaml`에서 정의한 `db-user`(admin) 계정에 특정 DB에 대한 `SELECT` 권한만 부여하여 사용하는 것이 보안상 안전합니다.
* **AWS 과금 주의**:
* **데이터 트래픽**: 사원 데이터(employees)의 양이 많을 경우, 웹 브라우저로 전송되는 데이터 양에 따라 AWS **Data Transfer Out** 비용이 발생할 수 있습니다. `LIMIT` 구문을 사용하여 전송량을 조절하십시오.
* **리소스 사용량**: JOIN 연산은 메모리를 많이 소모합니다. Pod의 `resources.limits`를 설정하여 워커 노드가 멈추지 않도록 관리하는 것이 중요합니다.



Next Step: 전체 인프라 자원 삭제 및 실습 환경 정리 가이드

---

Next Step: 인프라 자원 삭제 및 정리 방법
