이번 실습에서는 **Frontend(Nginx)** 계층까지 포함하여, 전체 3-Tier 아키텍처의 **'인프라 선 구축 및 설정 후 주입'** 전략을 완성합니다. 모든 계층(웹, 백엔드, DB)을 먼저 배포한 뒤, 환경 설정 업데이트를 통해 유기적으로 연결하는 고도의 배포 프로세스를 학습합니다.

---

## 1단계: 3-Tier 전체 인프라 선 구축 (Original Deployment)

환경 설정이 주입되기 전, 각 계층의 서버들만 먼저 클러스터에 배치합니다. 이 단계에서 각 Pod는 독립적으로 실행되며 서로 연결되지 않은 상태입니다.

### **01-frontend-original.yaml**

```yaml
# 01-frontend-original.yaml
# 설명: 웹 서비스를 제공할 Nginx 서버 2대를 기본 상태로 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30001 # 사용자 접속 포트
  selector:
    app: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 2 # 고가용성을 위한 2대 구축
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx-frontend
        image: nginx:alpine
        ports:
        - containerPort: 80

```

### **02-backend-original.yaml**

```yaml
# 02-backend-original.yaml
# 설명: DB 연결 정보가 없는 대기 상태의 Flask 서버 2대를 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  ports:
    - port: 5000
  selector:
    app: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: flask-backend
        image: python:3.9-slim
        command: ["python3", "-c"]
        args: ["print('Backend Standing by...'); import time; time.sleep(3600)"]
        ports:
        - containerPort: 5000

```

### **03-mariadb-original.yaml**

```yaml
# 03-mariadb-original.yaml
# 설명: 영구 저장소(NFS)가 연결된 MariaDB 서버를 기본 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: mariadb-service
spec:
  ports:
    - port: 3306
  selector:
    app: mariadb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.6
        env:
        - name: MARIADB_ROOT_PASSWORD
          value: "password123"
        volumeMounts:
        - name: db-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: nfs-pvc-request

```

1. **전체 인프라 배포**: 웹, 백엔드, DB를 순서대로 띄웁니다.
* `kubectl apply -f 01-frontend-original.yaml`
* `kubectl apply -f 02-backend-original.yaml`
* `kubectl apply -f 03-mariadb-original.yaml`
