이번 실습에서는 **Frontend(Nginx)** 계층까지 포함하여, 전체 3-Tier 아키텍처의 **'인프라 선 구축 및 설정 후 주입'** 전략을 완성합니다. 모든 계층(웹, 백엔드, DB)을 먼저 배포한 뒤, 환경 설정 업데이트를 통해 유기적으로 연결하는 고도의 배포 프로세스를 학습합니다.

---

## 1단계: 3-Tier 전체 인프라 선 구축 (Original Deployment)

환경 설정이 주입되기 전, 각 계층의 서버들만 먼저 클러스터에 배치합니다. 이 단계에서 각 Pod는 독립적으로 실행되며 서로 연결되지 않은 상태입니다.

### **01-frontend-original.yaml**

```yaml
# 01-frontend-original.yaml
# 설명: 웹 서비스를 제공할 Nginx 서버 2대를 기본 상태로 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30001 # 사용자 접속 포트
  selector:
    app: frontend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  replicas: 2 # 고가용성을 위한 2대 구축
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
      - name: nginx-frontend
        image: nginx:alpine
        ports:
        - containerPort: 80

```

### **02-backend-original.yaml**

```yaml
# 02-backend-original.yaml
# 설명: DB 연결 정보가 없는 대기 상태의 Flask 서버 2대를 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  ports:
    - port: 5000
  selector:
    app: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: flask-backend
        image: python:3.9-slim
        command: ["python3", "-c"]
        args: ["print('Backend Standing by...'); import time; time.sleep(3600)"]
        ports:
        - containerPort: 5000

```

### **03-mariadb-original.yaml**

```yaml
# 03-mariadb-original.yaml
# 설명: 영구 저장소(NFS)가 연결된 MariaDB 서버를 기본 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: mariadb-service
spec:
  ports:
    - port: 3306
  selector:
    app: mariadb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.6
        env:
        - name: MARIADB_ROOT_PASSWORD
          value: "password123"
        volumeMounts:
        - name: db-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: nfs-pvc-request

```

---

## 2단계: 통합 환경 설정 및 업데이트 배포 (Configuration & Link)

모든 인프라가 구축된 후, 각 계층을 연결할 설정값(ConfigMap/Secret)을 배포하고 Deployment를 업데이트합니다.

### **04-cluster-config-all.yaml**

```yaml
# 04-cluster-config-all.yaml
# 설명: 전체 서비스를 연결할 네트워크 및 보안 정보 세트입니다.
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-total-config
data:
  BACKEND_URL: "http://backend-service:5000"
  DB_HOST: "mariadb-service"
  DB_NAME: "employees"
---
apiVersion: v1
kind: Secret
metadata:
  name: cluster-total-auth
stringData:
  DB_PASSWORD: "password123"
  DB_USER: "root"

```

### **05-app-link-update.yaml**

기존에 배포된 프론트엔드와 백엔드에 설정을 주입하여 실제 통신이 가능하도록 업데이트합니다.

```yaml
# 05-app-link-update.yaml
# 설명: 프론트엔드는 백엔드로, 백엔드는 DB로 연결되도록 설정을 주입합니다.

# [Frontend 업데이트] Nginx가 백엔드로 요청을 전달하도록 설정
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend-deployment
spec:
  template:
    spec:
      containers:
      - name: nginx-frontend
        env:
        - name: BACKEND_API_URL
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: BACKEND_URL } }
---
# [Backend 업데이트] Flask가 DB에 접속하도록 설정
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  template:
    spec:
      containers:
      - name: flask-backend
        env:
        - name: DB_HOST
          valueFrom: { configMapKeyRef: { name: cluster-total-config, key: DB_HOST } }
        - name: DB_PASSWORD
          valueFrom: { secretKeyRef: { name: cluster-total-auth, key: DB_PASSWORD } }

```

---

## 3. 작업 절차 및 실행 방법

1. **전체 인프라 배포**: 웹, 백엔드, DB를 순서대로 띄웁니다.
* `kubectl apply -f 01-frontend-original.yaml`
* `kubectl apply -f 02-backend-original.yaml`
* `kubectl apply -f 03-mariadb-original.yaml`


2. **연결 명세서 배포**: 클러스터에 통합 설정을 등록합니다.
* `kubectl apply -f 04-cluster-config-all.yaml`


3. **서비스 연결 업데이트**: 업데이트 파일을 실행하여 전체 계층을 활성화합니다.
* `kubectl apply -f 05-app-link-update.yaml`


4. **브라우저 확인**: `http://<노드IP>:30001` 접속 후 서비스 동작 확인.

---

## 4. 실무 전문가 팁

* **롤링 업데이트 활용**: 5번 파일 실행 시 서비스 중단 없이 Pod가 하나씩 교체되며 새 설정이 적용됩니다. 이는 무중단 배포의 핵심 기술입니다.
* **환경 변수 확인**: 업데이트 후 특정 Pod에 접속하여(`kubectl exec`) 환경 변수가 잘 들어갔는지(`env | grep DB`) 반드시 확인하십시오.
* **AWS 과금 주의**: 프론트엔드 2대, 백엔드 2대, DB 1대 총 5대의 Pod가 돌아갑니다. **t3.medium** 이하 사양의 인스턴스에서는 메모리 부족(OOM) 현상이 발생할 수 있으니 수강생의 노드 사양을 사전에 점검하십시오.

Next Step: 전체 3-Tier 아키텍처의 트래픽 흐름 모니터링 및 로드밸런싱 검증

---

Next Step: 트래픽 모니터링 및 검증 방법
