이번 실습에서는 애플리케이션의 **'배포(Deployment)'**와 **'설정(Configuration)'**을 분리하는 전략을 학습합니다.

먼저 1단계에서 순수한 애플리케이션 인프라를 구축한 뒤, 2단계에서 환경 설정(ConfigMap/Secret)을 통해 DB 연결 정보를 주입하여 업데이트하는 방식입니다. 이 방식은 인프라 구성과 비즈니스 설정을 분리하여 관리할 수 있어 대규모 시스템 운영에 필수적인 기법입니다.

---

## 1단계: 백엔드 및 DB 오리지널 인프라 구축

환경 설정이 주입되기 전, 기본적인 실행 환경만 정의된 상태입니다. 이때 백엔드는 아직 DB 정보를 모르기 때문에 단독으로만 기동됩니다.

### **01-mariadb-original.yaml**

```yaml
# 01-mariadb-original.yaml
# 설명: MariaDB의 기본적인 실행 환경을 정의합니다.
apiVersion: v1
kind: Service
metadata:
  name: mariadb-service
spec:
  ports:
    - port: 3306
  selector:
    app: mariadb
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mariadb-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mariadb
  template:
    metadata:
      labels:
        app: mariadb
    spec:
      containers:
      - name: mariadb
        image: mariadb:10.6
        # 초기 기동을 위한 최소한의 환경변수만 설정 (이후 Secret으로 교체 가능)
        env:
        - name: MARIADB_ROOT_PASSWORD
          value: "password123"
        volumeMounts:
        - name: db-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: db-storage
        persistentVolumeClaim:
          claimName: nfs-pvc-request

```

### **02-backend-original.yaml**

```yaml
# 02-backend-original.yaml
# 설명: DB 연결 정보가 없는 순수 백엔드 서버를 배포합니다.
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  ports:
    - port: 5000
  selector:
    app: backend
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: flask-backend
        image: python:3.9-slim
        command: ["python3", "-c"]
        args: ["print('Backend Standing by...'); import time; time.sleep(3600)"]
        ports:
        - containerPort: 5000

```

---

## 2단계: 환경 설정 배포 및 연결 업데이트

이제 ConfigMap과 Secret을 생성하고, 기존 배포된 Deployment에 이 정보를 주입하여 백엔드와 DB를 연결하는 **업데이트 배포**를 진행합니다.

### **03-config-and-secret.yaml**

```yaml
# 03-config-and-secret.yaml
# 설명: 백엔드와 DB가 서로를 인식하고 통신하기 위한 설정값 세트입니다.
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-env-config
data:
  DB_HOST: "mariadb-service"
  DB_NAME: "employees"
---
apiVersion: v1
kind: Secret
metadata:
  name: cluster-db-auth
stringData:
  DB_PASSWORD: "password123"
  DB_USER: "root"

```

### **04-backend-update.yaml (업데이트 배포용)**

기존 `backend-deployment`에 환경 변수 주입 설정을 추가하여 다시 실행(Patch/Update)합니다.

```yaml
# 04-backend-update.yaml
# 설명: 기존 백엔드에 DB 연결 정보를 주입하여 실제 서비스를 활성화합니다.
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend-deployment
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
      - name: flask-backend
        image: python:3.9-slim
        env:
        # 2단계에서 생성한 ConfigMap/Secret으로부터 정보 로드
        - name: DB_HOST
          valueFrom: { configMapKeyRef: { name: cluster-env-config, key: DB_HOST } }
        - name: DB_NAME
          valueFrom: { configMapKeyRef: { name: cluster-env-config, key: DB_NAME } }
        - name: DB_PASSWORD
          valueFrom: { secretKeyRef: { name: cluster-db-auth, key: DB_PASSWORD } }
        # 이후 Flask 앱은 이 변수들을 사용하여 DB에 접속함

```

---

## 3. 작업 절차 및 실행 방법

1. **1차 인프라 구축**: 기본적인 서버들을 먼저 띄웁니다.
* `kubectl apply -f 01-mariadb-original.yaml`
* `kubectl apply -f 02-backend-original.yaml`


2. **2차 환경 설정 배포**: 연결에 필요한 명세서를 클러스터에 등록합니다.
* `kubectl apply -f 03-config-and-secret.yaml`


3. **연결 업데이트**: 백엔드 설정을 업데이트하여 DB와 연결을 시작합니다.
* `kubectl apply -f 04-backend-update.yaml`
* 이때 Kubernetes는 **Rolling Update**를 통해 기존 Pod를 순차적으로 교체하며 새 설정을 적용합니다.



---

## 4. 실무 전문가 팁

* **분리 배포의 이유**: 인프라 담당자는 `01, 02`번 파일만 관리하고, 개발자나 운영 담당자가 상황에 맞춰 `03, 04`번 설정을 변경하여 배포하는 방식으로 업무를 분리할 수 있습니다.
* **상태 확인**: 업데이트 배포 후 `kubectl rollout status deployment/backend-deployment` 명령어로 새 설정이 잘 적용되었는지 모니터링하십시오.
* **AWS 과금 및 리소스**: 업데이트 과정에서 일시적으로 Pod의 개수가 늘어날 수 있으므로, 노드의 자원(CPU/Memory) 여유가 있는지 체크해야 하며 과도한 재배포는 트래픽 비용을 유발할 수 있습니다.

Next Step: 주입된 설정을 기반으로 한 Flask 서버의 실제 DB CRUD 로직 구현 및 검증

---

Next Step: Flask DB 연동 로직 구현 및 검증 방법
