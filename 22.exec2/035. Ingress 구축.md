네, 제가 이전에 작성한 내용을 바탕으로 **네임스페이스 `megaprod` 적용**, **순차적 배포(Apply)**, 그리고 **레이블(Label) 트러블슈팅 각주**를 보강하여 최종 교재를 다시 제작했습니다.

---

## [실습] 경로 기반 인그레스 배포 및 검증 (Namespace: megaprod)

이번 장에서는 리소스를 순차적으로 배포하고, 쿠버네티스의 핵심 연결 고리인 **레이블(Label)**을 이용해 상태를 정확하게 검증하는 방법을 학습합니다.

### 1. 사전 준비: 네임스페이스 생성

프로젝트 간 자원 격리를 위해 전용 작업 공간인 `megaprod`를 생성합니다.

```bash
kubectl create namespace megaprod

```

### 2. 단계별 설정 파일 (YAML) 작성

관리 편의성과 배포 안정성을 위해 설정을 3개의 파일로 분리하여 관리합니다.

#### [파일 1] 메인 웹 서비스 (`front-web.yaml`)

* **역할:** 메인 경로(`/`) 요청을 처리하는 웹 서버 배포

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: front-web-deploy
  namespace: megaprod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: front-web # (각주 1) 서비스와 연결될 식별자
  template:
    metadata:
      labels:
        app: front-web
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: front-web-svc
  namespace: megaprod
spec:
  selector:
    app: front-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

```

#### [파일 2] 리스트 조회 서비스 (`view-web.yaml`)

* **역할:** 특정 경로(`/viewlist`) 요청을 처리하는 웹 서버 배포

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: view-web-deploy
  namespace: megaprod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: view-web
  template:
    metadata:
      labels:
        app: view-web
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: view-web-svc
  namespace: megaprod
spec:
  selector:
    app: view-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

```

#### [파일 3] 공용 인그레스 설정 (`shared-ingress.yaml`)

* **역할:** 단일 외부 진입점을 생성하고 경로에 따라 트래픽을 분산

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: shared-ingress
  namespace: megaprod
  annotations:
    kubernetes.io/ingress.class: "nginx"
    # (각주 2) URL 경로 재작성 설정
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: front-web-svc
            port:
              number: 80
      - path: /viewlist
        pathType: Prefix
        backend:
          service:
            name: view-web-svc
            port:
              number: 80

```

---

### 3. 안정적인 순차 배포 및 검증 절차

한꺼번에 배포할 경우 발생할 수 있는 의존성 에러를 방지하기 위해 파일별로 순차 배포를 진행합니다.

#### **Step 1: Front-end 배포 및 검증**

```bash
kubectl apply -f front-web.yaml

# [중요] 레이블 확인 시 파일명(.yaml)을 쓰지 않도록 주의하세요.
kubectl get pod -n megaprod -l app=front-web

```

#### **Step 2: View-list 배포 및 상태 확인**

```bash
kubectl apply -f view-web.yaml

# 서비스가 두 개의 Pod를 정상적으로 포착했는지 확인합니다.
kubectl get svc,endpoints -n megaprod

```

#### **Step 3: Ingress 적용 및 외부 주소 확인**

```bash
kubectl apply -f shared-ingress.yaml

# ADDRESS 항목에 공인 IP나 DNS 주소가 할당될 때까지 약 1~3분 대기합니다.
kubectl get ingress -n megaprod

```

---

### ⚠️ 자주 실수하는 부분 (Troubleshooting & 각주)

* **(각주 1) 레이블(Label) 오용 주의:** `kubectl get pod -l app=front-web.yaml`과 같이 명령어를 치면 아무것도 나오지 않습니다. `-l` 뒤에는 파일명이 아니라 YAML 파일 안의 `metadata: labels:`에 적힌 **실제 값(`front-web`)**을 적어야 합니다.
* **(각주 2) Rewrite Target의 의미:** 사용자가 `/viewlist`로 접속하더라도, 실제 Pod 내부의 Nginx는 `/` 경로의 `index.html`을 보여줘야 합니다. 이를 연결해 주는 것이 `rewrite-target` 주석입니다.
* **(각주 3) Unchanged 메시지:** `apply`를 다시 실행했을 때 `unchanged`가 나온다면 현재 클러스터 상태가 파일 내용과 완벽히 일치한다는 뜻이므로 안심하셔도 됩니다.

> [!CAUTION] **AWS 환경 유료 서비스 경고**
> * **ALB 비용 발생:** `shared-ingress.yaml`을 적용하는 순간 AWS 상에 **Application Load Balancer(ALB)**가 생성되며, 이는 생성 즉시 **시간당 비용**이 청구되는 유료 서비스입니다.
> * **자원 회수:** 실습이 끝나면 반드시 `kubectl delete namespace megaprod`를 실행하여 관련 유료 자원을 모두 삭제하시기 바랍니다.
> 
> 

---

Next Step: Ingress 로그 확인 및 실시간 트래픽 분석

수정된 내용과 각주가 교재 제작에 도움이 되기를 바랍니다. 추가로 보완이 필요한 부분은 말씀해 주세요.
