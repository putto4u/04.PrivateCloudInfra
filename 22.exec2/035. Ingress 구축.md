네임스페이스 `megaprod` 내에서 리소스를 분리하고, 안정적인 배포를 위해 실행 단계를 세분화한 교재입니다. 한꺼번에 배포할 때 발생할 수 있는 의존성 에러를 방지하기 위해 순차적 적용 방식을 채택했습니다.

---

## 서비스별 리소스 분리 및 순차적 배포 관리

실무 환경에서는 네트워크 설정이나 서비스 간 의존성 때문에 리소스를 한꺼번에 생성하기보다 순차적으로 배포하여 에러를 최소화합니다. 본 과정에서는 `네임스페이스 -> 애플리케이션 -> 인그레스` 순으로 배포를 진행합니다.

### 1. 사전 작업 (Preparation)

가장 먼저 작업 공간인 네임스페이스를 생성합니다. 네임스페이스가 생성되지 않은 상태에서 다른 리소스를 배포하면 `not found` 에러가 발생합니다.

* **단계 1: 네임스페이스 생성**
```bash
kubectl create namespace megaprod

```



---

### 2. 서비스별 설정 파일 (YAML)

각 리소스는 관리 효율을 위해 3개의 파일로 나뉩니다.

#### [파일 1] 메인 웹 서비스 (`front-web.yaml`)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: front-web-deploy
  namespace: megaprod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: front-web
  template:
    metadata:
      labels:
        app: front-web
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: front-web-svc
  namespace: megaprod
spec:
  selector:
    app: front-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

```

#### [파일 2] 리스트 조회 서비스 (`view-web.yaml`)

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: view-web-deploy
  namespace: megaprod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: view-web
  template:
    metadata:
      labels:
        app: view-web
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: view-web-svc
  namespace: megaprod
spec:
  selector:
    app: view-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

```

#### [파일 3] 공용 라우팅 설정 (`shared-ingress.yaml`)

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: shared-ingress
  namespace: megaprod
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: front-web-svc
            port:
              number: 80
      - path: /viewlist
        pathType: Prefix
        backend:
          service:
            name: view-web-svc
            port:
              number: 80

```

---

### 3. 단계별 배포 절차 (Step-by-Step Apply)

에러 방지를 위해 다음 순서로 명령어를 실행하며 각 단계의 정상 작동 여부를 확인하세요.

**Step 1. Front-end 배포**

```bash
kubectl apply -f front-web.yaml
# 확인: Pod가 Running 상태인지 체크
kubectl get pods -n megaprod -l app=front-web

```

**Step 2. View-list 배포**

```bash
kubectl apply -f view-web.yaml
# 확인: 서비스가 정상적으로 생성되었는지 체크
kubectl get svc -n megaprod

```

**Step 3. Ingress 라우팅 적용**
앞선 서비스들이 정상적으로 준비된 것을 확인한 후 인그레스를 생성합니다.

```bash
kubectl apply -f shared-ingress.yaml
# 확인: 외부 접속 주소(ADDRESS) 할당 여부 체크
kubectl get ingress -n megaprod

```

### 💡 실전 팁: 순차적 배포를 권장하는 이유

1. **의존성 해결:** 서비스(Service)가 먼저 존재해야 인그레스(Ingress)가 해당 서비스를 올바르게 바라볼 수 있습니다.
2. **트러블슈팅 용이:** 에러 발생 시 어느 파일 혹은 어느 서비스에서 문제가 생겼는지 즉시 파악이 가능합니다.
3. **리소스 경합 방지:** 대규모 클러스터에서 한꺼번에 많은 리소스를 요청할 때 발생하는 API 서버의 부하를 분산할 수 있습니다.

> [!CAUTION] **AWS 과금 주의**
> * **ALB 생성 비용:** `shared-ingress.yaml`을 적용하는 순간 AWS 상에 **Application Load Balancer가 생성되며 즉시 시간당 요금이 발생**합니다.
> * **삭제 절차:** 실습 종료 후에는 `kubectl delete namespace megaprod`를 실행하여 생성된 로드밸런서와 관련 자원을 모두 삭제해야 추가 과금을 막을 수 있습니다.
> 
> 

---

Next Step: Ingress 컨트롤러의 로그 확인 및 트래픽 분석 방법

순차적 배포 방식을 적용하여 안정성을 높인 교재로 재구성했습니다. 추가로 필요한 수정 사항이 있다면 말씀해 주세요.
