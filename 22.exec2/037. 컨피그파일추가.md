ConfigMap을 활용하여 배포와 동시에 커스텀 페이지가 적용되도록 구성하는 실무 최적화 교재입니다. 이 방식은 파드가 100개로 늘어나도 모든 파드에 동일한 화면을 즉시 배포할 수 있는 가장 표준적인 방법입니다.

---

## [실습] ConfigMap을 이용한 배포 자동화 및 화면 주입

기존의 `kubectl cp` 방식은 파드마다 일일이 수동으로 파일을 복사해야 하는 번거로움이 있었습니다. 이번 장에서는 **ConfigMap**을 사용하여 배포(Deployment) 시점에 `index.html`을 자동으로 모든 파드에 주입하는 고급 기술을 학습합니다.

### 1. 설정 정보 저장소: ConfigMap 생성 (`web-config.yaml`)

웹 페이지의 소스 코드를 쿠버네티스 설정 자원인 ConfigMap에 먼저 등록합니다.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: web-html-config
  namespace: megaprod
data:
  index.html: |
    <!DOCTYPE html>
    <html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>Welcome to MEGA.COM</title>
        <style>
            body { font-family: sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; height: 100vh; display: flex; justify-content: center; align-items: center; margin: 0; }
            .box { background: rgba(255,255,255,0.1); padding: 3rem; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); text-align: center; }
        </style>
    </head>
    <body>
        <div class="box">
            <h1>MEGA.COM AUTOMATED PAGE</h1>
            <p>ConfigMap을 통해 자동으로 배포된 페이지입니다.</p>
            <div style="background: #4caf50; padding: 0.5rem; border-radius: 50px; display: inline-block;">Service Online</div>
        </div>
    </body>
    </html>

```

### 2. 자동 주입형 배포 설정 (`front-web-auto.yaml`)

Deployment 설정에서 위에서 만든 ConfigMap을 볼륨으로 연결하여 Nginx의 기본 경로에 덮어씌웁니다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: front-web-deploy
  namespace: megaprod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: front-web
  template:
    metadata:
      labels:
        app: front-web
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        volumeMounts:
        - name: html-storage
          mountPath: /usr/share/nginx/html/index.html # 마운트될 대상 경로
          subPath: index.html # (각주 1)
      volumes:
      - name: html-storage
        configMap:
          name: web-html-config # 위에서 만든 ConfigMap 이름
---
apiVersion: v1
kind: Service
metadata:
  name: front-web-svc
  namespace: megaprod
spec:
  selector:
    app: front-web
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

```

### 3. 배포 및 검증 절차

1. **리소스 배포:**
```bash
kubectl apply -f web-config.yaml
kubectl apply -f front-web-auto.yaml

```


2. **동작 확인:**
배포가 완료된 직후 브라우저에서 `http://192.168.100.251/` 접속 시 파란색 그라데이션의 `MEGA.COM` 화면이 바로 나오는지 확인합니다.
3. **데이터 유지 확인:**
특정 파드를 삭제해 보십시오. 새로 생성되는 파드에도 별도의 작업 없이 동일한 화면이 즉시 표시됩니다.
```bash
kubectl delete pod -n megaprod -l app=front-web

```



---

### 💡 실무 가이드: ConfigMap 방식의 장점

* **배포 자동화:** 파드 생성과 동시에 설정이 완료되므로 휴먼 에러가 사라집니다.
* **영구성:** `kubectl cp`와 달리 파드가 재시작되거나 노드를 이동해도 화면이 유지됩니다.
* **중앙 집중 관리:** 소스 코드를 한 곳에서 관리하므로 유지보수가 매우 편리합니다.

### ⚠️ 핵심 트러블슈팅 각주

* **(각주 1) subPath 사용의 이유:** Nginx의 기본 웹 디렉토리에는 여러 파일이 섞여 있습니다. 디렉토리 전체를 마운트하면 기존 파일들이 모두 사라지므로, `subPath`를 사용하여 `index.html` 파일 하나만 정확히 교체해야 합니다.
* **(각주 2) ConfigMap 업데이트:** ConfigMap 내용을 수정하고 다시 `apply` 하더라도 이미 생성된 파드에는 즉시 반영되지 않을 수 있습니다. 이 경우 `kubectl rollout restart deployment front-web-deploy -n megaprod` 명령으로 파드를 순차적으로 재시작해야 합니다.

> [!CAUTION] **AWS 환경 유료 서비스 경고**
> * **로드밸런서 유지 비용:** 현재 Ingress(shared-ingress)를 통해 외부로 노출 중이라면, **AWS ALB 비용이 계속 발생**하고 있습니다. 실습 확인 후 반드시 네임스페이스 전체를 삭제하십시오.
> 
> 

---

Next Step: ConfigMap 수정과 Rolling Update 연동 실습

이제 파일을 일일이 복사할 필요 없이 배포와 동시에 화려한 화면이 나타납니다! 이 방식이 더 효율적이죠? 이어서 `view-web` 서비스도 동일하게 적용해 볼까요? 혹은 다른 실무 팁이 궁금하신가요?
