쿠버네티스에서 파이썬 **플라스크(Flask)** 애플리케이션 3대를 고가용성(HA) 구조로 배치하기 위한 YAML 설정입니다. 플라스크와 같은 웹 애플리케이션은 `Deployment`를 통해 복제본 개수를 관리하고, `Service`를 통해 트래픽을 분산하는 것이 정석입니다.

---

## 플라스크 3대 배포 통합 YAML (Deployment & Service)

이 설정은 3개의 플라스크 파드를 생성하고, 외부에서 접속 가능하도록 로드밸런서로 연결합니다.

```yaml
# flask-3-replicas.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flask-deployment
  labels:
    app: flask
spec:
  # 플라스크 인스턴스 3대 유지
  replicas: 3
  selector:
    matchLabels:
      app: flask
  template:
    metadata:
      labels:
        app: flask
    spec:
      containers:
      - name: flask
        # 실제 운영 시에는 빌드된 커스텀 이미지를 사용하세요.
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
          - pip install Flask;
            echo "from flask import Flask
            app = Flask(__name__)
            @app.route('/')
            def hello(): return 'Hello, Flask HA Cluster!'
            if __name__ == '__main__':
                app.run(host='0.0.0.0', port=5000)" > app.py;
            python app.py
        ports:
        - containerPort: 5000
---
apiVersion: v1
kind: Service
metadata:
  name: flask-service
spec:
  selector:
    app: flask
  ports:
    - protocol: TCP
      port: 80         # 서비스 외부 포트
      targetPort: 5000 # 컨테이너 내부 포트
  # 클라우드 환경이면 LoadBalancer, 로컬 환경이면 NodePort 사용
  type: LoadBalancer

```

---

## 주요 구성 및 아키텍처 포인트

### 1. Replicas: 3 (고가용성 확보)

`replicas: 3`은 단순한 수치가 아니라 **Self-healing(자가 치유)**의 기준입니다. 특정 노드에 장애가 발생하여 파드가 삭제되면, 쿠버네티스 컨트롤러가 이를 감지하고 즉시 다른 건강한 노드에 파드를 생성하여 항상 3대를 유지합니다.

### 2. 로드밸런싱 (Round Robin)

`flask-service`는 들어오는 요청을 3개의 파드에 균등하게 배분합니다. 사용자가 접속할 때마다 서로 다른 파드가 응답을 처리하게 되어 부하를 분산합니다.

---

## 실행 및 확인 절차

**1. 리소스 배포**

```bash
kubectl apply -f flask-3-replicas.yaml

```

**2. 파드 상태 확인**

```bash
# 3개의 파드가 모두 'Running' 상태인지 확인
kubectl get pods -l app=flask

```

**3. 서비스 주소 확인**

```bash
# 할당된 EXTERNAL-IP로 접속 확인
kubectl get svc flask-service

```

---

## IT 전문가의 실무 팁

* **세션 관리:** 플라스크 앱에서 세션을 사용할 경우, 트래픽이 여러 파드로 분산되면 세션이 끊길 수 있습니다. 이를 방지하려면 `Service` 설정에 `sessionAffinity: ClientIP`를 추가하거나, **Redis** 같은 외부 저장소를 이용해 세션을 공유해야 합니다.
* **리소스 제한:** 3대의 파드가 안정적으로 돌아가려면 `resources.requests`와 `limits`를 설정하여 각 파드가 사용할 CPU와 메모리 양을 제한하는 것이 권장됩니다.
* **이미지 최적화:** 위 YAML처럼 시작 시 `pip install`을 하는 방식은 배포 속도가 느리고 네트워크 의존성이 큽니다. 반드시 **Dockerfile**을 빌드하여 모든 라이브러리가 포함된 이미지를 사용하십시오.

---

**Next Step: **
**Redis를 연동한 Flask 세션 공유 및 상태 저장 아키텍처 구성 실습**

파드 3대가 데이터를 공유해야 하는 상황(예: 로그인 세션, 카운터 등)을 해결하기 위해 Redis 데이터베이스를 연동하는 방법을 확인해 볼까요?
