## Ingress Controller의 배치 전략: 공유형 vs 전용형

결론부터 말씀드리면, **인그레스 컨트롤러를 반드시 네임스페이스마다 설치할 필요는 없습니다.** 하지만 아키텍처 설계 목적(비용, 보안, 성능)에 따라 **'공유형'**으로 쓸지, **'전용형'**으로 쓸지 결정해야 합니다.

---

### 1. 공유형 컨트롤러 (Shared Ingress Controller)

일반적으로 가장 많이 사용하는 방식입니다. 하나의 컨트롤러가 클러스터 전체의 Ingress 규칙을 감시하고 모든 네임스페이스의 트래픽을 처리합니다.

* **장점**: 리소스 소모가 적고 관리가 간편하며, 클라우드 환경에서 로드밸런서(LB) 생성 비용을 절감할 수 있습니다.
* **단점**: 특정 서비스의 트래픽 폭주가 컨트롤러 전체에 영향을 줄 수 있으며(Noisy Neighbor 문제), 보안 설정이 복잡해질 수 있습니다.

### 2. 네임스페이스별 전용 컨트롤러 (Per-Namespace Controller)

보안 요구사항이 엄격하거나, 특정 서비스가 매우 높은 성능을 요구할 때 사용합니다.

* **장점**: 네임스페이스 간 완벽한 트래픽 격리가 가능하며, 각 환경(`megaprod`, `megadev`)에 최적화된 설정을 독립적으로 적용할 수 있습니다.
* **단점**: 컨트롤러 개수만큼 리소스(CPU/Mem)를 더 많이 소모하며, 클라우드 벤더의 외부 로드밸런서(ALB/NLB)가 각각 생성되어 **추가 과금이 발생**합니다.

---

### 3. 실무 환경에서의 선택 기준

강사님께서 구축 중인 `megaprod`와 `megadev` 환경을 기준으로 가이드라인을 제시해 드립니다.

| 구분 | 추천 전략 | 이유 |
| --- | --- | --- |
| **개발 환경 (megadev)** | **공유형** | 비용 절감 및 관리 편의성 우선 |
| **운영 환경 (megaprod)** | **전용형** | 트래픽 격리 및 보안 안정성 확보 |
| **멀티 테넌트 (B2B)** | **전용형** | 고객사별 독립적인 네트워크 경로 보장 |

---

### 4. 핵심 설정: Ingress Class

여러 개의 컨트롤러를 설치할 경우, 각 Ingress 리소스가 어떤 컨트롤러에 의해 처리될지 명시해야 합니다. 이를 위해 `ingressClassName`을 활용합니다.

```yaml
# megaprod 전용 인그레스 설정 예시
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: prod-ingress
  namespace: megaprod
spec:
  ingressClassName: nginx-prod  # 특정 컨트롤러 지정
  rules:
  - host: prod.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: prod-service
            port:
              number: 80

```

---

### 💡 실전 전문 팁 (Expert Tips)

* **과금 주의**: AWS에서 네임스페이스마다 Ingress Controller를 설치하고 `Type: LoadBalancer`를 사용하면, 컨트롤러마다 **최소 월 20$ 이상의 NLB/ALB 비용**이 각각 발생합니다. 예산에 맞춰 전략을 선택하십시오.
* **Scoped 설치**: Helm으로 설치 시 `--set controller.scope.enabled=true --set controller.scope.namespace=megaprod` 옵션을 주면, 해당 컨트롤러는 지정된 네임스페이스의 자원만 관리하도록 범위를 제한할 수 있습니다.
* **리소스 경합**: 공유형을 쓸 경우 컨트롤러 Pod에 **HPA(Horizontal Pod Autoscaler)**를 설정하여 트래픽 증가에 유연하게 대응하도록 구성하는 것이 필수입니다.

---

## 멀티 네임스페이스 기반 Ingress Controller 구축

실무 아키텍처에서는 운영(`megaprod`)과 개발(`megadev`) 환경을 엄격히 분리하기 위해 네임스페이스별로 전용 인그레스 컨트롤러를 배치하기도 합니다. 이를 통해 환경 간 트래픽 간섭을 차단하고 독립적인 네트워크 설정을 유지할 수 있습니다.

---

### 1. YAML 정의서를 이용한 선언적 설치 (Declarative)

IaC(Infrastructure as Code) 원칙에 따라 설정 파일을 통해 관리하는 방식입니다. 개발 환경의 특성에 맞춰 리소스 사용량을 최적화한 설정입니다.

**[dev-values.yaml]**

```yaml
controller:
  # 1. 개발 환경용 고유 인그레스 클래스 지정
  ingressClassResource:
    name: dev-nginx
    enabled: true
    default: false
    controllerValue: "k8s.io/dev-nginx"
  
  # 2. 감시 범위 제한 (megadev 네임스페이스만 관리)
  scope:
    enabled: true
    namespace: "megadev"
  
  # 3. 개발 환경 최적화 설정
  replicaCount: 1
  admissionWebhooks:
    enabled: false # 다중 설치 시 포트 충돌 방지 및 자원 절약

```

* **설치 명령어**

```bash
helm install dev-ingress ingress-nginx/ingress-nginx \
  -f dev-values.yaml \
  --namespace megadev

```

---

### 2. 명령형 방식을 이용한 즉시 설치 (Imperative)

별도의 파일 생성 없이 Helm의 `--set` 플래그를 사용하여 운영과 개발 환경을 각각 구축하는 방법입니다.

#### 1) 운영 환경 (megaprod) 설치

고가용성을 위해 복제본(Replica)을 2개로 설정하고 전용 클래스를 부여합니다.

```bash
helm install prod-ingress ingress-nginx/ingress-nginx \
  --namespace megaprod \
  --set controller.ingressClassResource.name=prod-nginx \
  --set controller.scope.enabled=true \
  --set controller.scope.namespace=megaprod \
  --set controller.replicaCount=2

```

#### 2) 개발 환경 (megadev) 설치

최소 자원으로 구동하며 개발 전용 클래스를 부여합니다.

```bash
helm install dev-ingress ingress-nginx/ingress-nginx \
  --namespace megadev \
  --set controller.ingressClassResource.name=dev-nginx \
  --set controller.scope.enabled=true \
  --set controller.scope.namespace=megadev \
  --set controller.replicaCount=1

```

---

### 3. 설치 결과 검증

두 환경의 컨트롤러가 독립적으로 실행 중인지 확인합니다.

```bash
# 네임스페이스별 컨트롤러 Pod 확인
kubectl get pods -n megaprod
kubectl get pods -n megadev

# 인그레스 클래스 이중화 확인
kubectl get ingressclass

```

*출력 결과에 `dev-nginx`와 `prod-nginx`가 모두 정상적으로 조회되어야 합니다.*

---

### 💡 실전 전문 팁 (Expert Tips)

* **AWS 과금 주의**: 위와 같이 두 개의 컨트롤러를 설치하면 AWS 환경에서는 **2개의 NLB(또는 ALB)가 생성**됩니다. 각각 시간당 비용이 발생하므로 실습 종료 후에는 반드시 `helm uninstall`로 삭제하십시오.
* **Ingress Resource 작성 시 주의**: 이후 Ingress 규칙을 만들 때 반드시 `spec.ingressClassName` 항목에 `dev-nginx` 또는 `prod-nginx`를 명시해야 해당 컨트롤러가 올바르게 인식합니다.
* **Webhook 포트 충돌**: 한 클러스터 내에 여러 NGINX 인그레스를 설치할 때, `admissionWebhooks` 포트가 겹쳐 설치가 실패하는 경우가 잦습니다. 이 경우 한쪽의 Webhook을 끄거나 포트를 변경하는 작업이 수반되어야 합니다.

---

**Next Step: 각 네임스페이스별 인그레스 규칙(Ingress Rule) 적용 실습**

요청하신 대로 `megadev`용 YAML 파일과 두 환경의 명령형 설치 스크립트를 교재 형식으로 정리하였습니다. 이제 실제로 트래픽을 분기하는 인그레스 규칙을 작성해 볼까요?

**Next Step: 특정 네임스페이스 전용 인그레스 컨트롤러 설치 실습**

전용 컨트롤러 구성을 위해 `megaprod` 네임스페이스에만 한정되어 동작하는 컨트롤러 설치 명령어를 준비해 드릴까요?
