## Docker Compose 개요 및 구조

**Docker Compose**는 여러 개의 컨테이너로 구성된 복잡한 애플리케이션을 정의하고 실행하기 위한 도구입니다. YAML 파일을 사용하여 애플리케이션의 서비스, 네트워크, 볼륨을 설정하며, 단 한 번의 명령어로 전체 스택을 제어할 수 있습니다.

### 1. 주요 구조 및 문법

* **Services:** 실행할 컨테이너들의 정의입니다. 각 서비스는 사용할 이미지, 포트 매핑, 환경 변수 등을 포함합니다.
* **Networks:** 컨테이너 간 통신을 위한 가상 네트워크 설정입니다. Compose는 기본적으로 프로젝트 단위의 네트워크를 자동 생성합니다.
* **Volumes:** 컨테이너가 삭제되어도 데이터를 보존하기 위한 공유 저장소 설정입니다.
* **IP 주소 할당:** 기본적으로 도커가 자동 할당하지만, `networks` 설정을 통해 고정 IP(Static IP)를 지정할 수 있습니다.

---

## 2. 도커 허브(Docker Hub)에서 이미지 찾는 방법

모든 실습의 시작은 공식 이미지를 찾는 것부터 시작합니다.

1. **[Docker Hub](https://hub.docker.com/)** 접속
2. 상단 검색창에 필요한 소프트웨어 입력 (예: `nginx`, `python`, `node`)
3. **Docker Official Image** 배지가 있는 것을 우선적으로 선택
4. **Tags** 탭에서 특정 버전(예: `alpine` 등 경량 버전) 확인

---

## 3. 단계별 실습: 점진적으로 복잡한 Compose 구축

### 1단계: 프론트엔드 + 백엔드 연동

가장 기본적인 구조입니다. 웹 서버가 백엔드 API 서버와 통신합니다.

파일명 : docker-compose.yml
```yaml
version: '3.8'
services:
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    networks:
      backend_net:
        ipv4_address: 172.20.0.10

  backend:
    image: python:3.9-slim
    command: python -m http.server 8080
    networks:
      backend_net:
        ipv4_address: 172.20.0.20

networks:
  backend_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

```

> **실습 명령어:** `docker-compose up -d` (백그라운드 실행)
> ``` $ docker-compose -f docker-compose.prod.yml up -d ```
> 
> **확인 방법:** `curl http://localhost` 접속 및 `docker exec frontend ping 172.20.0.20`으로 통신 확인

---

### 2단계: 파일 서버(NFS/Samba 대체) 추가 연동

정적 자산이나 공유 파일을 관리하는 파일 서버를 스택에 추가합니다.

```yaml
version: '3.8'
services:
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    networks:
      my_net:
        ipv4_address: 172.20.0.10

  backend:
    image: python:3.9-slim
    networks:
      my_net:
        ipv4_address: 172.20.0.20

  fileserver:
    image: halverneus/static-file-server:latest # 도커허브 인기 파일서버 이미지
    environment:
      - FOLDER=/web
    networks:
      my_net:
        ipv4_address: 172.20.0.30

networks:
  my_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

```

> **실습 명령어:** `docker-compose up -d --build` (수정사항 반영 빌드)
> **확인 방법:** `docker-compose ps`로 3개 서비스 상태 확인

---

### 3단계: 영구 저장소(Volume) 연결

컨테이너가 꺼져도 데이터가 사라지지 않도록 DB나 로그 저장용 볼륨을 추가합니다.

```yaml
version: '3.8'
services:
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro # 호스트 설정을 컨테이너로
    networks:
      my_net:
        ipv4_address: 172.20.0.10

  backend:
    image: mariadb:latest # 데이터베이스 추가
    environment:
      MYSQL_ROOT_PASSWORD: password123
    volumes:
      - db_data:/var/lib/mysql # 영구 저장소 볼륨 연결
    networks:
      my_net:
        ipv4_address: 172.20.0.20

  fileserver:
    image: halverneus/static-file-server:latest
    volumes:
      - shared_files:/web
    networks:
      my_net:
        ipv4_address: 172.20.0.30

networks:
  my_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  db_data: # 도커가 관리하는 내부 볼륨
  shared_files: # 파일 서버용 공유 볼륨

```

> **실습 명령어:** `docker-compose down` 후 `docker-compose up -d` (완성본 실행)
> **확인 방법:** `docker volume ls`로 생성된 볼륨 확인, DB 컨테이너 삭제 후 재시작 시 데이터 유지 확인

---

## 💡 주요 명령어 및 관리 팁

* **로그 확인:** `docker-compose logs -f` (실시간 로그 스트리밍)
* **서비스 중지 및 제거:** `docker-compose down` (볼륨까지 지우려면 `-v` 옵션 추가)
* **특정 서비스만 재시작:** `docker-compose restart backend`

> [!IMPORTANT]
> **과금 주의:** AWS EC2 환경에서 여러 컨테이너를 올릴 경우 메모리 부족(OOM)이 발생하여 인스턴스가 멈출 수 있습니다. 프리티어(t2.micro) 사용 시 `mem_limit` 설정을 추가하거나 스왑 메모리 설정을 권장합니다.

Next Step: Docker Compose를 활용한 CI/CD 파이프라인(GitHub Actions) 연동 방법
