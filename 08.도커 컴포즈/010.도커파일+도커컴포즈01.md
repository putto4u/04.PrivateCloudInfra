## 도커 파일 빌드와 컴포즈 통합 실행 가이드

도커 컴포즈의 진정한 강력함은 직접 만든 `Dockerfile`과 외부 이미지를 조합하여 하나의 서비스로 묶어낼 때 나타납니다. 여기서는 사용자가 작성한 소스 코드를 빌드(Compile/Build)하고 실행, 관리하는 전 과정을 설명합니다.

---

### 1. 프로젝트 구조 설정

먼저 빌드 대상이 되는 소스 코드와 설정 파일들을 준비합니다.

**디렉토리 구조 예시**

```text
my-app/
├── Dockerfile          # 컨테이너 빌드 정의서
├── app.py              # 실행 소스 코드
├── requirements.txt    # 의존성 파일
└── compose.yaml        # 다중 컨테이너 정의서

```

---

### 2. 빌드와 컴포즈 설정 (`Dockerfile` & `compose.yaml`)

**Dockerfile (이미지 빌드 정의)**

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY . .
RUN pip install -r requirements.txt
CMD ["python", "app.py"]

```

**compose.yaml (서비스 연동 정의)**

```yaml
services:
  web:
    build: .           # 현재 디렉토리의 Dockerfile을 읽어 이미지를 생성함
    ports:
      - "5000:5000"
    volumes:
      - .:/app         # 로컬 코드 수정 시 컨테이너에 즉시 반영 (Hot Reload용)
  
  db:
    image: postgres:15 # 외부 공식 이미지 사용
    environment:
      POSTGRES_PASSWORD: example

```

---

### 3. 생성, 실행 및 확인 단계

이 단계는 소스 코드를 컨테이너 이미지로 만드는 **빌드**와 실행 환경을 구성하는 **배포** 과정을 포함합니다.

#### ① 빌드 및 실행 (Build & Up)

```bash
# 빌드와 실행을 동시에 진행 (백그라운드)
docker compose up -d --build

```

* `--build`: 소스 코드가 수정되었을 때 Dockerfile을 다시 읽어 새 이미지를 생성하도록 강제합니다.

#### ② 실행 상태 확인 (Check)

```bash
# 전체 서비스 상태 요약 확인
docker compose ps

# 특정 서비스(web)의 상세 로그 실시간 확인
docker compose logs -f web

```

#### ③ 컨테이너 내부 점검

```bash
# 실행 중인 web 컨테이너 안으로 들어가 환경 확인
docker compose exec web bash

```

---

### 4. 삭제 및 정리 단계 (Down)

작업이 완료된 후 자원을 반납하는 과정입니다.

* **표준 삭제**
```bash
docker compose down

```


컨테이너와 네트워크만 제거합니다. 이미지와 볼륨 데이터는 남습니다.
* **이미지까지 삭제**
```bash
docker compose down --rmi all

```


서비스에 사용된 모든 이미지를 함께 삭제하여 디스크 공간을 확보합니다.
* **완전 초기화 (데이터 포함)**
```bash
docker compose down -v --rmi all

```


데이터베이스 볼륨, 네트워크, 이미지까지 모두 삭제하여 프로젝트 초기 상태로 되돌립니다.

---

### 💡 실전 중급 팁: 변경 사항 즉시 반영하기

개발 중 소스 코드를 수정했다면, 전체를 내리고 올릴 필요 없이 아래 명령만 사용하세요.

1. 소스 코드 수정
2. `docker compose up -d --build web`
3. 도커가 변경된 레이어만 감지하여 `web` 서비스만 다시 빌드하고 교체합니다.

---

### AWS 비용 및 유료 전환 주의사항

* **Amazon ECR (Elastic Container Registry)**: `docker compose`로 빌드한 이미지를 AWS 환경에 올리려면 ECR 저장소가 필요합니다. 일정 용량 이상의 프라이빗 리포지토리는 매달 **데이터 저장 비용**이 발생하며, 데이터 전송 시 **Outbound 트래픽 비용**이 청구될 수 있습니다.
* **NAT Gateway**: 프라이빗 서브넷에서 도커 이미지를 빌드하거나 외부 이미지를 Pull 할 때 NAT Gateway를 통과하면 **시간당 처리 비용**이 높게 발생할 수 있으니 주의가 필요합니다.

Next Step: Docker Compose 기반의 멀티 스테이지 빌드 최적화

교재 구성에 맞게 빌드(`build`) 옵션을 활용한 생명 주기 관리를 정리해 드렸습니다.

Would you like me to:

* Flask/Postgres 연동 코드 구현
* 환경별(Dev/Prod) 컴포즈 분리 방법
* 도커 이미지 용량 줄이기 전략

---

*개인별 맞춤 설정에 따라 요청하신 부분 위주로 수정하고 강의 교재 형식으로 작성하였습니다.*
