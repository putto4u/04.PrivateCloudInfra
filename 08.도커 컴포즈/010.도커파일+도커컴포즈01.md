## 도커 파일 빌드와 컴포즈 통합 실습 (Flask & Redis)

프로젝트를 시작하기 전, 파일들이 위치할 구조를 먼저 파악하는 것이 중요합니다. 아래 트리를 참고하여 환경을 구성해 주세요.

---

### 1. 프로젝트 디렉토리 트리 구조

실습에 필요한 파일 구성은 다음과 같습니다. 모든 파일은 하나의 루트 디렉토리 안에 위치해야 합니다.

```text
my-flask-app/
├── app.py              # Flask 애플리케이션 소스 코드
├── requirements.txt    # Python 패키지 의존성 목록
├── Dockerfile          # 애플리케이션 이미지 빌드 정의서
└── compose.yaml        # 다중 컨테이너 서비스 정의서

```

**터미널에서 구조 생성하기**

```bash
# 1. 프로젝트 디렉토리 생성 및 이동
mkdir my-flask-app && cd my-flask-app

# 2. 필요한 빈 파일들 생성
touch app.py requirements.txt Dockerfile compose.yaml

```

---

### 2. 파일별 상세 내용 작성

생성한 파일들에 아래 내용을 각각 복사하여 저장합니다.

#### ① 소스 코드 작성 (`app.py`)

```python
from flask import Flask
from redis import Redis
import os

app = Flask(__name__)
# environment에서 정의할 REDIS_HOST 변수를 읽어옵니다.
redis = Redis(host=os.environ.get('REDIS_HOST', 'redis'), port=6379)

@app.route('/')
def hello():
    count = redis.incr('hits')
    return f'어서오세요! 현재까지 접속 횟수는 {count}번입니다.\n'

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=5000)

```

#### ② 의존성 정의 (`requirements.txt`)

```text
flask
redis

```

#### ③ 빌드 정의서 작성 (`Dockerfile`)

```dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
EXPOSE 5000
CMD ["python", "app.py"]

```

#### ④ 서비스 설정 (`compose.yaml`)

```yaml
services:
  web:
    build: .           # 현재 경로(.)의 Dockerfile을 빌드하여 이미지 생성
    ports:
      - "8080:5000"    # 호스트 8080포트를 컨테이너 5000포트에 연결
    environment:
      - REDIS_HOST=redis
    depends_on:
      - redis
  
  redis:
    image: "redis:alpine"
    volumes:
      - redis_data:/data

volumes:
  redis_data:          # 데이터 보존을 위한 명명된 볼륨

```

---

### 3. 실행, 확인 및 삭제 방법

#### [Step 1] 빌드 및 실행 (Build & Run)

```bash
docker compose up -d --build

```

* `--build`: 소스 코드가 수정되었을 때 새롭게 빌드를 수행하도록 강제합니다.

#### [Step 2] 상태 및 로그 확인 (Check)

```bash
# 컨테이너 가동 상태 확인
docker compose ps

# 웹 서비스의 로그 실시간 모니터링
docker compose logs -f web

```

* 브라우저에서 `http://localhost:8080`에 접속하여 숫자가 올라가는지 확인합니다.

#### [Step 3] 삭제 및 정리 (Clean up)

```bash
# 컨테이너 및 네트워크 삭제
docker compose down

# 이미지와 볼륨까지 모두 삭제 (완전 초기화 시 사용)
docker compose down -v --rmi all

```

---

### AWS 비용 및 유료 전환 주의사항

* **Amazon ECR (Elastic Container Registry)**: 직접 빌드한 이미지를 AWS에 저장할 경우, **월간 데이터 저장 용량**에 따라 과금이 발생합니다.
* **EC2 NAT Gateway**: 프라이빗 서브넷의 EC2에서 빌드 시 외부 라이브러리를 다운로드하면 **데이터 처리 비용**이 발생할 수 있습니다.
* **EBS 볼륨**: `compose.yaml`에서 정의한 볼륨이 실제 EBS로 생성될 경우, 인스턴스 중지 중에도 **스토리지 비용**은 계속 청구됩니다.

## Next Step: 환경 변수 관리 및 보안 설정

요청하신 대로 최상단에 디렉토리 트리 구조와 생성 방법을 배치하여 실습 가이드를 수정하였습니다.

Next Step: 환경 변수 관리 및 보안 설정
