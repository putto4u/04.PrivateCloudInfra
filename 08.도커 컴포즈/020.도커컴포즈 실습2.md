## 도커 컴포즈(Docker Compose)의 구조와 이해

도커 컴포즈는 다중 컨테이너 애플리케이션을 정의하고 실행하기 위한 도구입니다. 복잡한 애플리케이션(예: 웹 서버 + DB + 캐시 서버)을 각각의 명령어로 실행하는 대신, 하나의 **YAML** 설정 파일로 관리할 수 있게 해줍니다.

### 1. 도커 컴포즈의 핵심 구조

도커 컴포즈 파일(`compose.yaml` 또는 `docker-compose.yml`)은 크게 4가지 섹션으로 구성됩니다.

* **Services**: 컨테이너 설정의 핵심입니다. 이미지, 포트 바인딩, 환경 변수 등 개별 컨테이너가 어떻게 동작할지 정의합니다.
* **Networks**: 서비스 간의 통신을 위한 가상 네트워크를 정의합니다. 별도 설정이 없으면 기본 네트워크가 자동 생성됩니다.
* **Volumes**: 컨테이너가 삭제되어도 데이터를 보존하기 위한 저장 공간을 정의합니다. (호스트 경로 연결 또는 볼륨 생성)
* **Configs/Secrets**: 설정 파일이나 민감한 정보(비밀번호 등)를 관리할 때 사용합니다.

---

### 2. 기본 예제: Nginx 웹 서버 실행

가장 단순한 구조로 웹 서버 하나를 띄우는 예제입니다.

**`compose.yaml`**

```yaml
services:
  web-server:
    image: nginx:latest
    ports:
      - "8080:80" # 호스트 8080 포트를 컨테이너 80 포트에 연결

```

* **실행**: `docker compose up -d`
* **확인**: 브라우저에서 `localhost:8080` 접속
* **종료**: `docker compose down`

---

### 3. 중급 예제: Python Flask와 Redis 연동

데이터베이스(Redis)와 애플리케이션(Flask)이 서로 통신하고 데이터를 보존하는 구조입니다.

**프로젝트 구조**

```text
.
├── app.py
├── requirements.txt
├── Dockerfile
└── compose.yaml

```

**`compose.yaml`**

```yaml
services:
  web:
    build: . # 현재 디렉토리의 Dockerfile을 사용하여 이미지 빌드
    ports:
      - "5001:5000"
    environment:
      - REDIS_HOST=redis
    depends_on:
      - redis # redis 서비스가 먼저 시작된 후 실행됨

  redis:
    image: "redis:alpine"
    networks:
      - backend-net
    volumes:
      - redis_data:/data # 데이터 영속성을 위한 볼륨 설정

networks:
  backend-net:
    driver: bridge

volumes:
  redis_data: # 명명된 볼륨 생성

```

#### 주요 중급 개념 설명

1. **build**: 미리 만들어진 이미지가 아니라 사용자의 코드가 담긴 `Dockerfile`을 실시간으로 빌드하여 서비스에 사용합니다.
2. **depends_on**: 서비스 간의 실행 순서를 보장합니다. DB가 켜지기 전에 앱이 실행되어 연결 오류가 나는 것을 방지합니다.
3. **Networks (Isolation)**: `backend-net`이라는 별도 네트워크를 구성하여 외부 노출 없이 내부 컨테이너끼리만 안전하게 통신하게 할 수 있습니다.
4. **Volumes (Persistence)**: 컨테이너를 지우고(`down`) 다시 실행해도 Redis에 저장된 데이터가 유지됩니다.

---

### 4. 실전 운영 팁

* **환경 변수 관리**: 민감한 정보는 `.env` 파일을 만들어 관리하세요. 컴포즈는 자동으로 동일 경로의 `.env`를 읽어 `${DB_PASSWORD}` 형태로 변수를 치환해줍니다.
* **이미지 최적화**: `build` 시 `target` 옵션을 활용하여 멀티 스테이지 빌드 중 특정 단계만 실행할 수 있습니다.
* **리소스 제한**: 중급 이상의 운영 환경에서는 컨테이너가 호스트의 자원을 독점하지 않도록 `deploy.resources.limits`를 설정하는 것이 좋습니다.

---

### AWS 비용 및 유료 전환 주의사항

* **AWS Fargate (ECS)**: 도커 컴포즈를 사용하여 AWS ECS로 배포할 경우, 인스턴스 사양과 실행 시간에 따라 시간당 과금이 발생합니다. **Free Tier** 범위를 초과하면 비용이 청구되니 주의하세요.
* **EBS Volumes**: 컴포즈에서 정의한 볼륨이 AWS EBS로 생성될 경우, 데이터 저장 용량에 따라 매달 고정 비용이 발생합니다. 사용하지 않는 볼륨은 반드시 삭제해야 합니다.

Next Step: Docker Compose를 활용한 CI/CD 파이프라인 구축

강의 교재의 흐름에 맞춰 도커 컴포즈의 계층 구조와 실무에서 자주 쓰이는 옵션 위주로 정리하였습니다.

Would you like me to:

* Flask와 Redis 소스 코드 예제 포함
* Dockerfile 작성 가이드 추가
* 네트워크 격리 심화 설명
