## 데이터베이스 복원: 샘플 데이터(Employees) 마이그레이션 및 검증

외부에서 다운로드한 샘플 데이터베이스(`employees.sql`)와 덤프 파일들을 클러스터 내부의 **쓰기 전용(Primary) 서버**로 복사하고, 이를 복원하여 실제 데이터 서비스가 가능한 상태로 만드는 과정을 실습합니다.

---

### 1. 데이터 복원 아키텍처 및 흐름

로컬 PC나 마스터 PC에 있는 SQL 데이터를 포드 내부로 전송한 뒤, MySQL 엔진을 통해 물리 저장소(PVC)에 기록합니다.

* **Source**: 테스트 DB 디렉토리 (덤프 파일 및 `employees.sql` 포함)
* **Destination**: `mysql-primary` 포드 내부의 `/tmp` 경로
* **Final Storage**: `mysql-pvc-primary` (마운트 경로: `/var/lib/mysql`)

---

### 2. 실행 방법 (Step-by-Step)

**단계 1: 로컬 디렉토리를 포드로 복사 (`kubectl cp`)**
터미널에서 샘플 데이터가 있는 디렉토리로 이동한 후, `kubectl cp` 명령어를 사용하여 Primary 포드 내부로 데이터를 전송합니다.

```bash
# 디렉토리 통째로 Primary 포드의 /tmp 폴더로 복사
# 형식: kubectl cp [로컬디렉토리명] [네임스페이스]/[포드명]:[복사경로]
kubectl cp ./employees_db wb_prod/mysql-primary-xxxx-xxxx:/tmp/employees_db

```

**단계 2: 포드 내부 접속 및 데이터 확인**
파일이 정상적으로 전송되었는지 포드 내부에서 확인합니다.

```bash
kubectl exec -it mysql-primary-xxxx-xxxx -n wb_prod -- ls -l /tmp/employees_db

```

**단계 3: 데이터베이스 복원 실행**
`mysql` 명령어를 통해 `employees.sql` 파일을 실행하여 스키마와 데이터를 복원합니다.

```bash
# 포드 내부에서 복원 명령어 실행
kubectl exec -it mysql-primary-xxxx-xxxx -n wb_prod -- /bin/bash -c "cd /tmp/employees_db && mysql -u admin -p12345678 < employees.sql"

```

---

### 3. 확인 및 테스트 방법

복원이 완료된 후, 실제 테이블과 데이터 건수를 조회하여 정합성을 검증합니다.

**단계 1: 데이터베이스 목록 및 테이블 확인**

```bash
kubectl exec -it mysql-primary-xxxx-xxxx -n wb_prod -- mysql -u admin -p12345678 -e "SHOW DATABASES; USE employees; SHOW TABLES;"

```

**단계 2: 레코드 건수 조회 테스트**
샘플 데이터가 대량으로 잘 들어갔는지 특정 테이블의 카운트를 확인합니다.

```bash
kubectl exec -it mysql-primary-xxxx-xxxx -n wb_prod -- mysql -u admin -p12345678 -e "SELECT COUNT(*) FROM employees.employees;"

```

> **정상 결과 예시**: 약 300,024건의 데이터가 조회되어야 합니다.

---

### 4. 트러블슈팅 가이드

* **파일 복사 실패 (Permission Denied)**: 포드 내부의 `/tmp` 경로는 보통 쓰기 권한이 허용되지만, 에러 발생 시 포드 내부에서 `chmod 777 /tmp`를 실행한 후 다시 시도하십시오.
* **복원 중 에러 (Unknown command '')**: SQL 파일 내부에 경로 설정이 잘못된 경우 발생할 수 있습니다. 반드시 `cd /tmp/employees_db`로 이동한 상태에서 명령어를 실행해야 합니다.
* **용량 부족**: 덤프 데이터 용량이 PVC 용량(2Gi)을 초과할 경우 복원이 중단될 수 있습니다. `df -h`로 `/var/lib/mysql`의 잔여 공간을 확인하십시오.

---

### 5. 핵심 관리 포인트

* **데이터의 영속성**: 이렇게 복원된 데이터는 `mysql-pvc-primary`에 기록되므로, 포드를 삭제하고 다시 띄워도 `employees` 데이터베이스는 그대로 유지됩니다.
* **쓰기 전용 서버 활용**: 데이터 복원은 반드시 **Primary** 서버에서 수행해야 합니다. (이후 복제 설정을 통해 Replica로 데이터가 전파됩니다.)

> [!IMPORTANT]
> **과금 및 자원 안내**:
> 파일 복사와 DB 복원 과정은 CPU와 디스크 I/O를 집중적으로 사용합니다. AWS 인스턴스 타입이 낮을 경우 잠시 응답이 느려질 수 있으나, **추가적인 서비스 과금은 발생하지 않습니다.**

---

Next Step: **복원된 데이터를 읽기 전용 서비스(mysql-read)에서 조회하여 로드밸런싱 확인하기**

---

Next Step: **back-pvc**
