### 마이크로서비스 아키텍처: 약한 결합(Loose Coupling)을 위한 FastAPI 백엔드 구축

본 섹션에서는 Kubernetes(k8s)의 핵심 철학인 **약한 결합(Loose Coupling)**을 구현합니다. 약한 결합이란 클라이언트(프론트엔드 등)가 백엔드의 구체적인 상태(Pod의 IP, 개수, 위치)를 알 필요 없이, 추상화된 단일 진입점(Service)을 통해 통신하는 방식을 의미합니다.

이를 위해 FastAPI 백엔드 Pod를 3개로 복제(Replica)하여 가용성을 확보하고, 이들을 하나의 논리적 서비스로 묶는 Deployment와 Service 매니페스트를 작성합니다.

---

### 1. 사전 준비 사항

FastAPI 서버를 컨테이너로 배포하기 위해 필요한 구성 요소입니다.

* **기본 이미지**: `python:3.9-slim` (경량화된 공식 파이썬 이미지)
* **필수 라이브러리**:
* `fastapi`: 웹 프레임워크 핵심 라이브러리
* `uvicorn`: FastAPI를 실행하기 위한 고성능 ASGI 서버


* **포트 설정**: 기본적으로 **8000**번 포트를 사용하도록 구성합니다.

---



#### 1. Deployment 및 Service 명세서 (YAML)

아래 코드는 3개의 FastAPI 인스턴스를 생성하는 `Deployment`와, 외부에서 이를 접속할 수 있게 해주는 `Service`를 하나의 파일로 정의한 내용입니다.

* **파일명:** `fastapi-backend.yaml`
* **주의:** AWS EKS 사용 시 `type: LoadBalancer`는 유료 CLB/ALB를 즉시 프로비저닝하여 과금이 발생합니다. 실습용으로는 비용 절감을 위해 `NodePort`를 사용합니다.

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: origin-backend-deployment
  labels:
    app: origin-backend
spec:
  # [Loose Coupling & Availability]
  # 3개의 레플리카를 유지하여 특정 Pod가 죽더라도 서비스 지속성을 보장
  replicas: 3
  selector:
    matchLabels:
      app: origin-backend
  template:
    metadata:
      labels:
        app: origin-backend
    spec:
      containers:
      - name: fastapi-container
        # [Image] 실습용 공식 FastAPI 베이스 이미지 (실제 배포 시 빌드한 이미지 주소 사용)
        image: tiangolo/uvicorn-gunicorn-fastapi:python3.9
        ports:
        - containerPort: 80
        resources:
          requests:
            cpu: "100m"
            memory: "128Mi"
          limits:
            cpu: "250m"
            memory: "256Mi"
        # [Health Check] 애플리케이션이 실제 응답 가능한지 확인
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: origin-backend-service
spec:
  # [Service Discovery]
  # Selector를 통해 'app: origin-backend' 라벨을 가진 3개의 Pod를 자동으로 연결
  selector:
    app: origin-backend
  ports:
    - protocol: TCP
      port: 80         # 서비스가 노출할 포트
      targetPort: 80   # 컨테이너 내부의 실제 포트
      nodePort: 30001  # [Access] 외부 브라우저 접속을 위한 고정 포트 (30000-32767)
  # [Cost Management]
  # AWS LoadBalancer(유료) 대신 NodePort를 사용하여 워커 노드의 IP로 직접 접속
  type: NodePort

```

---

#### 2. 배포 및 실행 방법

작성된 YAML 파일을 클러스터에 적용하여 리소스를 생성합니다.

**Step 1: 매니페스트 적용**

```bash
kubectl apply -f fastapi-backend.yaml

```

**Step 2: 배포 상태 실시간 확인**
Pod가 3개가 정상적으로 생성(Running)되고 있는지, Service가 IP를 할당받았는지 확인합니다.

```bash
# Pod 생성 과정 모니터링 (3개의 replica 확인)
kubectl get pods -l app=origin-backend -w

# Service 및 NodePort 포트 확인
kubectl get svc origin-backend-service

```

**출력 예시:**

```text
NAME                                         READY   STATUS    RESTARTS   AGE
origin-backend-deployment-5d4767c8-abc1      1/1     Running   0          15s
origin-backend-deployment-5d4767c8-def2      1/1     Running   0          15s
origin-backend-deployment-5d4767c8-ghi3      1/1     Running   0          15s

```

---

#### 3. 브라우저 접속 및 약한 결합 확인

서비스가 정상적으로 로드밸런싱(트래픽 분산)을 수행하는지 브라우저를 통해 확인합니다.

1. **접속 주소 확인:**
* **로컬/VM 환경:** `http://localhost:30001` 또는 `http://<VM_IP>:30001`
* **AWS EKS 환경:** 워커 노드의 **Public IP** 확인 후 `http://<Node_Public_IP>:30001`
* *Tip:* AWS 보안 그룹(Security Group)에서 인바운드 규칙에 `TCP 30001` 포트가 열려 있어야 접속 가능합니다.




2. **브라우저 확인:**
* 웹 브라우저 주소창에 위 주소를 입력합니다.
* FastAPI 기본 페이지(JSON 응답: `{"message": "Hello World"}`)가 출력되면 성공입니다.


3. **약한 결합(Loose Coupling) 검증:**
* 터미널에서 `kubectl delete pod <POD_NAME>` 명령어로 3개 중 하나의 Pod를 강제로 삭제합니다.
* Kubernetes가 즉시 새로운 Pod를 생성하여 3개를 유지(Self-healing)하는 것을 확인합니다.
* 브라우저에서 새로고침을 해도 서비스가 중단되지 않고 정상 응답하는 것을 확인합니다. (클라이언트는 어떤 Pod가 죽었는지 알 필요가 없음)



---

**Next Step:** k8s 서비스(Service)의 종류(ClusterIP, NodePort, LoadBalancer) 상세 비교 및 Ingress Controller를 통한 L7 라우팅 구성
