## FastAPI 단독 서버 구축 및 배포 가이드

단순 파일 서빙을 넘어 실제 비즈니스 로직을 처리할 수 있는 고성능 파이썬 웹 프레임워크인 **FastAPI**를 활용하여 단독 서버를 구축합니다. 이 과정에서는 컨테이너 기반 배포를 위한 사전 준비부터 쿠버네티스 리소스 생성 및 확인까지의 단계를 다룹니다.

---

### 1. 사전 준비 사항

FastAPI 서버를 컨테이너로 배포하기 위해 필요한 구성 요소입니다.

* **기본 이미지**: `python:3.9-slim` (경량화된 공식 파이썬 이미지)
* **필수 라이브러리**:
* `fastapi`: 웹 프레임워크 핵심 라이브러리
* `uvicorn`: FastAPI를 실행하기 위한 고성능 ASGI 서버


* **포트 설정**: 기본적으로 **8000**번 포트를 사용하도록 구성합니다.

---

### 2. FastAPI 서버 정의 (`fastapi-web.yaml`)

별도의 Dockerfile 빌드 없이 쿠버네티스 명령어를 통해 즉석에서 라이브러리를 설치하고 서버를 실행하는 방식으로 구성합니다. 이를 통해 인프라 수준에서의 빠른 테스트가 가능합니다.

```yaml
# fastapi-web.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fastapi-web
  namespace: wb_prod
  labels:
    app: fastapi
spec:
  replicas: 2
  selector:
    matchLabels:
      app: fastapi
  template:
    metadata:
      labels:
        app: fastapi
    spec:
      containers:
      - name: fastapi-container
        image: python:3.9-slim
        # 컨테이너 시작 시 필요한 패키지를 설치하고 서버를 실행합니다.
        command: ["/bin/sh", "-c"]
        args:
          - |
            pip install fastapi uvicorn;
            cat <<EOF > main.py
            from fastapi import FastAPI
            app = FastAPI()
            @app.get("/")
            def read_root():
                return {"message": "Hello FastAPI", "status": "Production-Ready"}
            @app.get("/items/{item_id}")
            def read_item(item_id: int):
                return {"item_id": item_id, "detail": "Data from FastAPI"}
            EOF
            python3 -m uvicorn main.py --host 0.0.0.0 --port 8000
        ports:
        - containerPort: 8000
---
apiVersion: v1
kind: Service
metadata:
  name: fastapi-service
  namespace: wb_prod
spec:
  type: NodePort
  selector:
    app: fastapi
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
      nodePort: 38000

```

---

### 3. 설치 및 실행 방법

**단계 1: 리소스 배포**

```bash
kubectl apply -f fastapi-web.yaml

```

**단계 2: 배포 상태 확인**
라이브러리 설치 시간이 약 10~20초 정도 소요될 수 있습니다. 포드가 `Running` 상태가 될 때까지 기다립니다.

```bash
# 포드 로그를 통해 서버 실행 상태 확인
kubectl logs -f -l app=fastapi -n wb_prod

```

---

### 4. 브라우저 확인 방법

FastAPI는 API 문서(Swagger UI)를 자동으로 생성해주는 강력한 기능이 있습니다.

1. **기본 응답 확인**:
* 주소: `http://<Worker-Node-IP>:38000/`
* 결과: `{"message": "Hello FastAPI", "status": "Production-Ready"}` JSON 메시지가 표시됩니다.


2. **자동 생성된 API 문서(Swagger UI) 확인**:
* 주소: **`http://<Worker-Node-IP>:38000/docs`**
* 특징: 웹 브라우저에서 직접 API를 테스트(Try it out)해 볼 수 있는 인터페이스가 나타납니다.


3. **파라미터 호출 테스트**:
* 주소: `http://<Worker-Node-IP>:38000/items/100`
* 결과: `{"item_id": 100, "detail": "Data from FastAPI"}`가 출력됩니다.



---

### 5. 핵심 관리 포인트

* **ASGI 서버 사용**: 단순 `http.server`와 달리 `uvicorn`을 사용하여 비동기 처리가 가능한 운영급 성능을 제공합니다.
* **JSON 기본 통신**: 모든 응답이 JSON 형식이므로 현대적인 프론트엔드(React, Vue 등)와 연동하기에 최적화되어 있습니다.
* **보안 및 확장**: 실제 운영 시에는 이 위에 `pip install` 과정이 포함된 사용자 정의 도커 이미지를 미리 빌드하여 사용하는 것이 배포 속도 면에서 유리합니다.

> [!IMPORTANT]
> **과금 관련 안내**:
> 본 실습은 `NodePort`를 사용하여 외부 로드밸런서를 생성하지 않으므로 **추가 인프라 비용이 발생하지 않습니다.** 다만, `pip install` 과정에서 소량의 외부 네트워크 트래픽(Data Transfer Out)이 발생할 수 있으나 무시할 수 있는 수준입니다.

---

Next Step: **FastAPI 서버에 기존 생성한 back-pvc를 마운트하여 데이터베이스 대용으로 활용하기**

---
