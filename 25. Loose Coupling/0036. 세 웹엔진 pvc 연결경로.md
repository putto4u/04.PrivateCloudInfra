## 서비스별 볼륨 마운트 구조 및 물리적 경로 매핑

현재 구성된 3개의 서비스(Nginx, Python 기본 웹서버, FastAPI)가 각각 어떤 **PVC**를 호출하고, 컨테이너 내부의 **어떤 경로**와 노드의 **물리적 디렉토리**가 연결되는지 정리한 구조도입니다.

---

### 1. 서비스별 볼륨 매핑 요약표

| 서비스명 (Deployment) | 사용 PVC | 컨테이너 내부 경로 (MountPath) | 워커 노드 물리 경로 (HostPath) |
| --- | --- | --- | --- |
| **ng-web** (Nginx) | `ng-static-pvc` | `/usr/share/nginx/html` | `/opt/local-path-provisioner/pvc-[ID]_wb_prod_ng-static-pvc/` |
| **py-web** (Python 3) | `ng-static-pvc` | `/var/www/html` | (위와 동일한 경로 공유) |
| **py-web** (Python 3) | `back-pvc` | `/data/storage` | `/opt/local-path-provisioner/pvc-[ID]_wb_prod_back-pvc/` |
| **fastapi-web** (FastAPI) | `back-pvc` | `/data/storage` | `/opt/local-path-provisioner/pvc-[ID]_wb_prod_back-pvc/` |

---

### 2. 논리적 연결 구조도

각 포드는 PVC라는 '논리적 주소'를 통해 물리적 디렉토리에 접근합니다. 특히 `py-web`은 두 개의 PVC를 동시에 호출하여 서로 다른 경로에 마운트하는 구조를 가집니다.

---

### 3. 물리적 데이터 흐름 상세

1. **Nginx (`ng-web`)**:
* 사용자가 노드의 `/opt/.../ng-static-pvc` 경로에 `index.html`을 넣으면, Nginx 컨테이너의 `/usr/share/nginx/html`에 즉시 나타납니다.


2. **Python 웹서버 (`py-web`)**:
* **정적 데이터**: Nginx와 동일한 `ng-static-pvc`를 참조하므로, Nginx가 보여주는 것과 똑같은 파일을 `/var/www/html`에서 읽어 서비스합니다.
* **백엔드 데이터**: `back-pvc`를 `/data/storage`에 연결하여 로그나 DB 파일을 관리합니다.


3. **FastAPI (`fastapi-web`)**:
* `back-pvc`를 `/data/storage`에 연결합니다. 파이썬 웹서버가 `/data/storage`에 쓴 파일을 FastAPI에서도 동일하게 읽고 쓸 수 있습니다. (단, 두 포드가 같은 노드에 있을 때만 가능)



---

### 4. 실습 확인 명령어 (Deep Dive)

수강생들이 실제 경로를 추적할 수 있도록 다음 명령어를 순서대로 실행합니다.

**단계 1: 특정 포드의 마운트 정보 확인**

```bash
# FastAPI 포드가 어디에 무엇을 마운트했는지 확인
kubectl describe pod fastapi-web -n wb_prod | grep -A 10 Volumes:

```

**단계 2: 실제 노드 디렉토리 파일 조작**
워커 노드에 접속하여 직접 파일을 생성하고 모든 서버에서 보이는지 확인합니다.

```bash
# 워커 노드 내부에서 실행
# 1. back-pvc 경로로 이동
cd /opt/local-path-provisioner/pvc-*_wb_prod_back-pvc/

# 2. 공유 데이터 생성
echo "Shared Backend Data" > shared.txt

# 3. FastAPI 포드에서 확인
kubectl exec -it [fastapi-pod-name] -n wb_prod -- cat /data/storage/shared.txt

# 4. Python 웹서버 포드에서 확인
kubectl exec -it [py-pod-name] -n wb_prod -- cat /data/storage/shared.txt

```

---

### 5. 핵심 교육 포인트

* **다대일 연결**: 하나의 PVC(`back-pvc`)를 서로 다른 서비스(`py-web`, `fastapi-web`)가 동시에 호출할 수 있습니다.
* **경로의 유연성**: 노드의 실제 경로는 복잡하지만, 컨테이너 내부에서는 우리가 정한 직관적인 경로(`/data/storage`)로 단순화되어 사용됩니다.
* **데이터 공유**: 동일한 PVC를 공유하는 포드들은 서로의 데이터를 실시간으로 공유하는 '공유 저장소'처럼 활용할 수 있습니다.

> [!IMPORTANT]
> **과금 관련 안내**:
> 여러 포드가 하나의 PVC를 공유하거나 여러 개의 PVC를 생성하더라도, 이는 모두 노드 로컬 디스크의 공간을 나누어 쓰는 것이므로 **추가적인 AWS 스토리지 과금은 발생하지 않습니다.**

---

Next Step: **노드 장애 발생 시 데이터 복구 및 노드 이동 전략(Node Affinity)**

---

강사님의 교재 구성을 위해 각 서비스별 마운트 지점을 명확히 시각화하여 정리했습니다. 깃허브 등에서 바로 활용하실 수 있는 마크다운 포맷입니다. 추가로 특정 경로를 수정하거나 보완이 필요하시면 말씀해 주세요.
