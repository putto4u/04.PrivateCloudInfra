## Local Path Provisioner와 HostPath의 이해 및 구축

쿠버네티스에서 노드의 로컬 디스크를 사용하는 방식은 크게 **HostPath**와 **Local Path Provisioner(동적 프로비저닝)**로 나뉩니다. 두 방식의 결정적인 차이점은 관리의 자동화와 스케줄링 안정성에 있습니다.

---

### 1. HostPath vs Local Path Provisioner 비교

| 구분 | HostPath | Local Path Provisioner |
| --- | --- | --- |
| **PV 생성 방식** | 수동 (Static) | 자동 (Dynamic) |
| **스케줄링** | 노드 위치를 직접 지정해야 함 | 포드와 볼륨 위치를 쿠버네티스가 자동 매칭 |
| **관리 편의성** | 낮음 (경로 및 권한 직접 관리) | 높음 (PVC 요청 시 자동 생성/삭제) |
| **권장 용도** | 단일 노드 테스트, 시스템 로그 수집 | 로컬 스토리지가 필요한 일반 워크로드 |

---

### 2. HostPath의 한계점

HostPath는 노드의 특정 경로를 컨테이너에 직접 연결합니다. 하지만 다음과 같은 치명적인 단점이 있습니다.

* **노드 고정 불가**: 포드가 재시작되어 다른 워커 노드로 이동하면, 이전 노드에 있던 데이터에 접근할 수 없습니다.
* **보안 위험**: 포드가 호스트의 파일 시스템에 직접 접근하므로 보안상 취약할 수 있습니다.
* **수동 관리**: 모든 노드에 동일한 경로를 미리 만들어두거나, 특정 노드에 포드가 뜨도록 `nodeSelector`를 매번 설정해야 합니다.

---

### 3. Local Path Provisioner 설치 방법

Rancher에서 제공하는 가벼운 동적 프로비저너를 사용하여 로컬 디스크 관리 자동화를 구축합니다. 이 도구는 PVC 요청이 발생할 때마다 노드의 특정 경로를 자동으로 PV로 할당해 줍니다.

**시스템 배포**

```bash
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/master/deploy/local-path-storage.yaml

```

**설치 상태 확인**

```bash
# 관련 서비스 포드 실행 확인 (Running 상태 확인)
kubectl get pods -n local-path-storage

# 생성된 스토리지 클래스(StorageClass) 확인
kubectl get sc

```

---

### 4. Local Path Provisioner의 작동 원리 및 장점

Local Path Provisioner는 HostPath의 수동 관리 문제를 해결하기 위한 **동적 프로비저닝 솔루션**입니다.

* **자동 생명주기 관리**: 사용자가 PVC를 만들면 프로비저너가 노드에 적절한 디렉토리를 생성하고 PV를 즉시 연결합니다.
* **지능적 스케줄링 (Node Affinity)**: 볼륨이 생성된 노드 정보를 PV 객체에 기록합니다. 덕분에 포드가 재시작되더라도 쿠버네티스 스케줄러는 해당 데이터가 있는 노드로 포드를 강제 배정합니다.
* **격리된 경로**: `/opt/local-path-provisioner/<pvc-name>`과 같이 고유한 경로를 생성하므로 여러 포드가 동일한 경로를 사용하여 데이터가 충돌하는 것을 방지합니다.

---

### 5. 실습: 동적 프로비저닝 동작 확인

실제로 PVC를 생성했을 때 PV가 어떻게 자동으로 노드 정보(`nodeAffinity`)를 갖게 되는지 확인합니다.

**단계 1: PVC 생성 (`wb_prod` 네임스페이스)**

```yaml
# local-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wb-local-pvc
  namespace: wb_prod
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: local-path
  resources:
    requests:
      storage: 1Gi

```

**단계 2: 생성된 PV 상세 확인**
PVC를 생성한 후, 자동으로 만들어진 PV의 상세 설정을 확인하여 어느 노드에 데이터가 묶여있는지 검토합니다.

```bash
# 생성된 PV 목록 확인
kubectl get pv

# PV의 노드 친밀도(Node Affinity) 확인
kubectl get pv [PV_이름] -o yaml | grep -A 10 nodeAffinity

```

> [!IMPORTANT]
> **과금 관련 안내**:
> 본 방식은 클라우드 전용 스토리지 서비스(예: AWS EBS)를 호출하지 않고 인스턴스 자체의 디스크를 사용하므로 **추가적인 스토리지 과금이 발생하지 않습니다.** 단, 인스턴스 생성 시 설정한 루트 볼륨 용량 내에서 동작함을 유의하십시오.

---

Next Step: **Node Affinity 설정 확인 및 포드 이동 테스트**

---
