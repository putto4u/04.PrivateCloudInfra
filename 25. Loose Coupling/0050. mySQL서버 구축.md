## MySQL 아키텍처 구축: 쓰기 전용(Primary) 및 읽기 전용(Replica) 배포

데이터베이스의 부하 분산과 고가용성을 위해, 모든 데이터 변경을 담당하는 **Primary(Master) 서버 1대**와 조회 성능 향상을 위한 **Replica(Slave) 서버 2대**를 독립적으로 구축합니다. 강사님께서 확인하신 대로 **쓰기 전용 1개, 읽기 전용 2개**의 구조가 맞으며, 각 서버는 용도에 맞는 레이블로 구분됩니다.

---

### 1. MySQL 클러스터 배포 정의 (`mysql-deploy.yaml`)

각 리소스의 역할과 설정값을 주석으로 상세히 풀이하였습니다.

```yaml
# mysql-deploy.yaml
# --- 쓰기 전용(Primary) 서버 설정 ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-primary        # 쓰기 전용 서버의 고유 이름
  namespace: wb_prod         # 작업 네임스페이스 지정
spec:
  replicas: 1                # 쓰기 서버는 데이터 일관성을 위해 1개만 생성
  selector:
    matchLabels:
      app: mysql
      role: primary          # 쓰기 전용 레이블로 식별
  template:
    metadata:
      labels:
        app: mysql
        role: primary
    spec:
      containers:
      - name: mysql
        image: mysql:8.0     # MySQL 8.0 공식 이미지 사용
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "12345678"  # 루트 관리자 비밀번호
        - name: MYSQL_USER
          value: "admin"     # 요청하신 admin 계정 생성
        - name: MYSQL_PASSWORD
          value: "12345678"  # admin 계정 비밀번호
        ports:
        - containerPort: 3306 # MySQL 기본 포트
        volumeMounts:
        - name: db-data
          mountPath: /var/lib/mysql # 데이터가 저장될 컨테이너 내부 경로
      volumes:
      - name: db-data        # 위 mountPath와 매칭되는 볼륨 이름
        persistentVolumeClaim:
          claimName: mysql-pvc-primary # 이전에 생성한 쓰기전용 PVC 연결

---
# --- 읽기 전용(Replica) 서버 설정 ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-replica        # 읽기 전용 서버의 고유 이름
  namespace: wb_prod
spec:
  replicas: 2                # 읽기 전용 서버는 부하 분산을 위해 2개 생성
  selector:
    matchLabels:
      app: mysql
      role: replica          # 읽기 전용 레이블로 식별
  template:
    metadata:
      labels:
        app: mysql
        role: replica
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "12345678"
        - name: MYSQL_USER
          value: "admin"
        - name: MYSQL_PASSWORD
          value: "12345678"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: db-data
          mountPath: /var/lib/mysql
      volumes:
      - name: db-data
        persistentVolumeClaim:
          # 실습 환경에 따라 각각 다른 PVC(mysql-pvc-replica-1, 2)를 지정하거나
          # 하나를 지정하여 분할하여 사용합니다.
          claimName: mysql-pvc-replica-1 

```

---

### 2. 설치 및 실행 방법

**단계 1: 리소스 적용**

```bash
kubectl apply -f mysql-deploy.yaml

```

**단계 2: 실행 상태 확인**
포드 목록에서 `primary` 역할을 가진 포드 1개와 `replica` 역할을 가진 포드 2개가 모두 `Running` 상태인지 확인합니다.

```bash
kubectl get pods -n wb_prod -l app=mysql

```

---

### 3. 데이터베이스 접속 및 확인 방법

설정한 `admin` 계정으로 정상 로그인이 되는지 테스트합니다.

**단계 1: Primary 서버 접속**

```bash
# 포드 이름 확인 후 접속 (임의의 primary 포드명 입력)
kubectl exec -it [PRIMARY_POD_NAME] -n wb_prod -- mysql -u admin -p
# 비밀번호: 12345678

```

**단계 2: 데이터베이스 생성 테스트**

```sql
-- 쓰기 전용 서버에서 데이터베이스 생성
CREATE DATABASE wb_test;
SHOW DATABASES;
EXIT;

```

---

### 4. 트러블슈팅 가이드

* **Pending 상태 지속**: PVC가 정상적으로 생성되어 `Bound` 되었는지 `kubectl get pvc -n wb_prod`로 확인하십시오.
* **로그 확인**: DB 실행에 문제가 있을 경우 아래 명령어로 원인을 분석합니다.
```bash
kubectl logs [POD_NAME] -n wb_prod

```



> [!IMPORTANT]
> **과금 관련 안내**:
> 본 구성은 관리형 DB 서비스가 아닌 컨테이너 기반이므로 **별도의 DB 서비스 과금은 발생하지 않습니다.** 다만, 3개의 DB 인스턴스가 가동되므로 워커 노드의 메모리 자원을 약 1~2GB 정도 점유하게 됩니다.

---

Next Step: **쓰기 전용(Write)과 읽기 전용(Read) 서비스를 분리하기 위한 Service 구축**

---

Next Step: **back-pvc**
