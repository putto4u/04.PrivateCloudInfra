## Python 기본 애플리케이션의 읽기 전용 DB 연결 및 데이터 조회

이미 구축된 **MySQL 읽기 전용 로드밸런서(`mysql-read`)**를 활용하여, Python 기본 웹 서버에서 데이터베이스의 내용을 불러와 화면에 출력하는 과정을 실습합니다. 이 과정은 애플리케이션이 인프라 서비스와 어떻게 대화하는지 이해하는 핵심 단계입니다.

---

### 1. 연결 아키텍처 (Read-Only Path)

Python 애플리케이션은 쓰기 전용 서버가 아닌, 로드밸런싱이 지원되는 읽기 전용 서비스 이름을 통해 DB에 접근합니다.

* **연결 대상**: `mysql-read` (서비스 이름)
* **포트**: `3306`
* **사용 라이브러리**: `mysql-connector-python` (순수 파이썬용 MySQL 드라이버)

---

### 2. Python 웹 서버 설정 업데이트 (`py-db-read.yaml`)

기존의 Python 웹 서버 환경에 DB 접속 라이브러리를 설치하고, 데이터를 조회하는 스크립트를 포함하여 배포합니다.

```yaml
# py-db-read.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: py-web
  namespace: wb_prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: py-web
  template:
    metadata:
      labels:
        app: py-web
    spec:
      containers:
      - name: py-container
        image: python:3.9-slim
        command: ["/bin/sh", "-c"]
        args:
          - |
            # 1. 필요한 DB 드라이버 설치
            pip install mysql-connector-python;
            
            # 2. DB 조회를 위한 메인 스크립트 작성
            cat <<EOF > index.py
            import mysql.connector
            from http.server import BaseHTTPRequestHandler, HTTPServer

            class DBHandler(BaseHTTPRequestHandler):
                def do_GET(self):
                    self.send_response(200)
                    self.send_header('Content-type', 'text/html; charset=utf-8')
                    self.end_headers()
                    
                    try:
                        # mysql-read 서비스를 통해 읽기 전용 접속
                        conn = mysql.connector.connect(
                            host="mysql-read",
                            user="admin",
                            password="12345678",
                            database="employees"
                        )
                        cursor = conn.cursor()
                        # 샘플 데이터베이스의 부서 목록 5개 조회
                        cursor.execute("SELECT dept_name FROM departments LIMIT 5")
                        rows = cursor.fetchall()
                        
                        output = "<h1>Python DB Read Test</h1>"
                        output += "<h3>Connected to: mysql-read</h3>"
                        output += "<ul>"
                        for row in rows:
                            output += f"<li>Department: {row[0]}</li>"
                        output += "</ul>"
                        
                        cursor.close()
                        conn.close()
                    except Exception as e:
                        output = f"<h1>DB Connection Failed</h1><p>{str(e)}</p>"
                    
                    self.wfile.write(output.encode('utf-8'))

            print("Starting Python Web Server on port 8080...")
            HTTPServer(('', 8080), DBHandler).serve_forever()
            EOF
            
            # 3. 작성한 스크립트 실행
            python3 index.py
        ports:
        - containerPort: 8080

```

---

### 3. 실행 및 확인 방법

**단계 1: 설정 적용**

```bash
kubectl apply -f py-db-read.yaml

```

**단계 2: 서비스 연결 상태 확인**
포드가 정상적으로 뜨고 라이브러리가 설치되었는지 로그를 확인합니다.

```bash
kubectl logs -f deployment/py-web -n wb_prod

```

**단계 3: 브라우저 테스트**
인그레스 설정에 따라 다음 주소로 접속하여 DB에서 불러온 부서 목록이 출력되는지 확인합니다.

* **접속 주소**: `http://192.168.0.251/vew`
* **정상 결과**:
* `Customer Service`, `Development`, `Finance` 등 부서명이 리스트 형태로 화면에 나타나야 합니다.



---

### 4. 트러블슈팅 가이드

* **ModuleNotFoundError**: `mysql-connector-python` 설치가 완료되기 전에 서버가 실행된 경우 발생할 수 있습니다. 포드가 재시작되기를 기다리거나 로그를 다시 확인하십시오.
* **Connection Timeout**: `mysql-read` 서비스가 동일한 네임스페이스(`wb_prod`)에 있는지 확인하십시오.
* **Access Denied**: MySQL 구축 시 설정한 `admin` 계정과 비밀번호(`12345678`)가 코드 내 설정과 일치하는지 점검하십시오.

---

### 5. 핵심 관리 포인트

* **읽기 부하 분산**: Python 앱은 `mysql-read`를 호출함으로써 자동으로 2대의 레플리카 서버 중 한 곳에서 데이터를 가져오게 됩니다.
* **코드의 간결성**: 복잡한 네트워크 경로를 몰라도 `mysql-read`라는 서비스 이름 하나로 DB 통신을 완성하는 **느슨한 결합**을 실현했습니다.

> [!IMPORTANT]
> **과금 및 자원 안내**:
> 내부 DNS 기반 통신이므로 **추가적인 트래픽 비용은 발생하지 않습니다.** 단, `pip install` 과정에서 소량의 인터넷 트래픽이 발생합니다.

---

Next Step: **Python 앱에서 읽어온 데이터를 FastAPI 백엔드로 전달하는 API 통신 구축**

---

Next Step: **back-pvc**
