## PV/PVC 시스템 자원 삭제 및 환경 정리

쿠버네티스에서 스토리지를 사용한 후에는 단순히 파드를 삭제하는 것만으로는 실제 물리 자원이 정리되지 않습니다. 특히 클라우드 환경(AWS)에서는 명확한 삭제 절차를 거치지 않으면 지속적으로 비용이 발생하므로 주의가 필요합니다.

---

### 1. 자원 삭제 표준 절차 (Step-by-Step)

스토리지는 의존성 관계가 명확하므로 반드시 역순으로 삭제해야 오류가 발생하지 않습니다.

**Step 1: 사용 중인 Pod 삭제**
스토리지(PVC)를 붙잡고 있는 프로세스를 먼저 종료해야 합니다.

```bash
kubectl delete pod storage-app-pod

```

**Step 2: PersistentVolumeClaim(PVC) 삭제**
사용자의 요청서(PVC)를 삭제합니다.

```bash
kubectl delete pvc ebs-pvc-claim

```

**Step 3: PersistentVolume(PV) 삭제**
실제 리소스 정의(PV)를 삭제합니다.

```bash
kubectl delete pv ebs-pv-storage

```

---

### 2. 회수 정책(Reclaim Policy)에 따른 데이터 처리

PV 정의서의 `persistentVolumeReclaimPolicy` 설정값에 따라 삭제 후 동작이 달라집니다.

* **Retain (보존):** * PVC를 삭제해도 PV는 `Released` 상태로 남으며, 실제 데이터는 보존됩니다.
* 다른 PVC가 이 PV를 재사용하려면 관리자가 수동으로 데이터를 정리하고 PV를 다시 생성해야 합니다.


* **Delete (삭제):** * PVC를 삭제하는 즉시 PV도 삭제되며, 연결된 외부 스토리지(AWS EBS 등)도 함께 삭제됩니다. (클라우드 동적 프로비저닝의 기본값)

---

### 3. AWS 인프라 최종 과금 확인 (가장 중요)

쿠버네티스 명령어로 PV를 삭제했더라도, `Retain` 정책을 사용했거나 설정 오류가 있을 경우 AWS 계정에는 여전히 EBS 볼륨이 남아 과금될 수 있습니다.

1. **AWS 관리 콘솔 접속:** [EC2 대시보드](https://console.aws.amazon.com/ec2/)로 이동합니다.
2. **Volumes 메뉴 확인:** 좌측 메뉴의 **Elastic Block Store > Volumes**를 클릭합니다.
3. **상태(State) 체크:** 사용했던 Volume ID의 상태가 **`available`** 인지 확인합니다. (`in-use`는 아직 삭제되지 않은 상태입니다.)
4. **수동 삭제:** `available` 상태의 볼륨이 남아있다면 **Actions > Delete volume**을 선택하여 직접 삭제해야 더 이상의 과금을 방지할 수 있습니다.

---

### 4. 삭제 관련 트러블슈팅: 'Terminating' 상태 고착

간혹 PVC를 삭제했는데 계속 `Terminating` 상태로 멈춰있는 경우가 있습니다. 이는 해당 PVC를 사용 중인 파드가 아직 완전히 종료되지 않았을 때 발생합니다.

* **원인:** 쿠버네티스의 `Finalizers` 보호 기능 때문입니다.
* **해결:** 연결된 파드가 모두 삭제되었는지 확인하고, 그래도 멈춰있다면 아래 명령어로 강제 패치하여 삭제할 수 있습니다.

```bash
kubectl patch pvc [PVC_이름] -p '{"metadata":{"finalizers":null}}' --type=merge

```

---

**Next Step: StorageClass 및 Dynamic Provisioning**

* 매번 수동으로 PV를 만들고 삭제하는 번거로움을 해결해 주는 자동화 방법을 알아볼까요?

---
